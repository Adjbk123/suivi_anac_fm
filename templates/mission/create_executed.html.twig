{% extends 'base.html.twig' %}

{% block title %}Créer une Mission Exécutée (Non Prévue){% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
	<li class="breadcrumb-item"><a href="{{ path('app_mission_index') }}">MISSIONS</a></li>
	<li class="breadcrumb-item active">MISSION EXÉCUTÉE (NON PRÉVUE)</li>
</ul>
{% endblock %}

{% block page_title %}
<h1 class="page-header">
	Créer une Mission Exécutée <small>Non prévue mais déjà réalisée</small>
</h1>
{% endblock %}

{% block buttons %}
<div class="d-flex gap-2">
	<a href="{{ path('app_mission_index') }}" class="btn btn-secondary btn-sm">
		<i class="fa fa-arrow-left"></i> Retour
	</a>
</div>
{% endblock %}

{% block body %}
<div class="row">
	<div class="col-xl-12">
		<div class="card">
			<div class="card-body">
				<div class="alert alert-success d-flex align-items-center gap-2 mb-4" role="alert">
					<i class="fa fa-info-circle"></i>
					<div>
						<strong>Mission non prévue mais déjà exécutée :</strong> Utilisez ce formulaire pour enregistrer une mission qui n'était pas prévue dans le planning mais qui a déjà eu lieu. 
						Vous devrez renseigner les dates réelles, les participants et les dépenses réelles.
					</div>
				</div>

				<!-- Étapes de progression -->
				<div class="mb-4">
					<div class="progress" style="height: 4px;">
						<div class="progress-bar" id="progressBar" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100"></div>
					</div>
					<div class="d-flex justify-content-between mt-2">
						<span class="step-indicator active" data-step="1">1. Informations générales</span>
						<span class="step-indicator" data-step="2">2. Participants & Dépenses</span>
						<span class="step-indicator" data-step="3">3. Récapitulatif</span>
					</div>
				</div>

				<form id="missionExecutedForm" novalidate>
					<input type="hidden" id="missionId" name="missionId">
					
					<!-- Étape 1 : Informations générales -->
					<div class="step-content" id="step1">
						<h4 class="mb-3"><i class="fa fa-info-circle text-primary"></i> Informations générales</h4>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="missionModeleId" class="form-label">Mission concernée <span class="text-danger">*</span></label>
									<select class="form-select" id="missionModeleId" required>
										<option value="">Sélectionner une mission</option>
									</select>
									<div class="form-text text-muted">Sélectionnez une mission modèle existante</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="directionId" class="form-label">Direction responsable <span class="text-danger">*</span></label>
									<select class="form-select" id="directionId" required>
										<option value="">Choisir une direction</option>
									</select>
									<div class="form-text text-muted">Sélectionnez une direction pour voir ses utilisateurs à l'étape suivante</div>
								</div>
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="fondsId" class="form-label">Type de fonds <span class="text-danger">*</span></label>
									<select class="form-select" id="fondsId" required>
										<option value="">Choisir le type de fonds</option>
									</select>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="lieuReel" class="form-label">Lieu réel <span class="text-danger">*</span></label>
									<input type="text" class="form-control" id="lieuReel" required>
								</div>
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="dateReelleDebut" class="form-label">Date réelle de début <span class="text-danger">*</span></label>
									<input type="date" class="form-control" id="dateReelleDebut" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="dateReelleFin" class="form-label">Date réelle de fin <span class="text-danger">*</span></label>
									<input type="date" class="form-control" id="dateReelleFin" required>
								</div>
							</div>
						</div>
						
						<div class="mb-3">
							<label for="notes" class="form-label">Notes</label>
							<textarea class="form-control" id="notes" rows="3"></textarea>
						</div>
					</div>

					<!-- Étape 2 : Participants avec dépenses -->
					<div class="step-content d-none" id="step2">
						<h4 class="mb-3"><i class="fa fa-users text-primary"></i> Participants & Dépenses</h4>

						<div class="alert alert-info mb-3">
							<i class="fa fa-info-circle me-2"></i>
							Les collaborateurs proposés proviennent de la direction sélectionnée à l'étape précédente. Sélectionnez les participants et renseignez leurs dépenses par catégorie.
						</div>

						<div class="table-responsive">
							<table class="table table-hover align-middle" id="participantsTable">
								<thead class="table-secondary">
									<tr>
										<th width="60">Sélection</th>
										<th>Nom &amp; prénom</th>
										<th>Email</th>
										<th>Service</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="4" class="text-center text-muted">Sélectionnez une direction à l'étape précédente pour charger les participants disponibles.</td>
									</tr>
								</tbody>
							</table>
						</div>

						<div class="mt-3 mb-4">
							<span class="badge bg-secondary" id="participantsCount">0 participant(s) sélectionné(s)</span>
						</div>

						<!-- Budget par participant -->
						<div id="participantBudgetContainer" class="d-flex flex-column gap-3"></div>
					</div>

					<!-- Étape 3 : Récapitulatif -->
					<div class="step-content d-none" id="step3">
						<h4 class="mb-3"><i class="fa fa-check-circle text-primary"></i> Récapitulatif</h4>
						<div id="recapContent" class="bg-light rounded p-3">
							<!-- Contenu généré dynamiquement -->
						</div>
					</div>

					<!-- Boutons navigation -->
					<div class="d-flex justify-content-between mt-4">
						<button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display:none;">
							<i class="fa fa-arrow-left"></i> Précédent
						</button>
						<div class="ms-auto">
							<button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
								Suivant <i class="fa fa-arrow-right"></i>
							</button>
							<button type="button" class="btn btn-success" id="submitBtn" style="display:none;" onclick="submitForm()">
								<i class="fa fa-check"></i> Créer la mission exécutée
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block stylesheets %}
<style>
.step-indicator {
    font-size: 0.9rem;
    color: #6c757d;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 15px;
    transition: all 0.3s ease;
}

.step-indicator.active {
    background-color: #007bff;
    color: white;
}

.step-indicator.completed {
    background-color: #28a745;
    color: white;
}

.step-content {
    min-height: 400px;
}
</style>
{% endblock %}

{% block javascripts %}
<script>
let currentStep = 1;
const totalSteps = 3;
let missionModeles = [];
let directions = [];
let fonds = [];
let categoriesDepenses = [];
let participantsDisponibles = [];
let selectedParticipants = new Map();
let participantBudgets = new Map(); // Map<userId, Map<categorieId, montant>>

document.addEventListener('DOMContentLoaded', async function() {
	try {
		await Promise.all([
			loadMissionModeles(),
			loadDirections(),
			loadFonds(),
			loadCategoriesDepenses()
		]);
	} catch (error) {
		console.error('Erreur de chargement des données de base :', error);
		showToast('Impossible de charger certaines données initiales.', 'error');
	}

	setupEventListeners();
	updateStepDisplay();
});

function loadMissionModeles() {
	return fetch('/api/missions')
		.then(response => response.json())
		.then(data => {
			missionModeles = data || [];
			const select = document.getElementById('missionModeleId');
			if (!select) return;
			select.innerHTML = '<option value="">Sélectionner une mission</option>';
			missionModeles.forEach(mission => {
				const option = document.createElement('option');
				option.value = mission.id;
				option.textContent = mission.titre;
				select.appendChild(option);
			});
		});
}

function loadDirections() {
	return fetch('/api/directions')
		.then(response => response.json())
		.then(data => {
			directions = data || [];
			const select = document.getElementById('directionId');
			if (!select) return;
			select.innerHTML = '<option value="">Choisir une direction</option>';
			directions.forEach(direction => {
				const option = document.createElement('option');
				option.value = direction.id;
				option.textContent = direction.libelle;
				select.appendChild(option);
			});
		});
}

function loadFonds() {
	return fetch('/api/fonds')
		.then(response => response.json())
		.then(data => {
			fonds = data || [];
			const select = document.getElementById('fondsId');
			if (!select) return;
			select.innerHTML = '<option value="">Choisir le type de fonds</option>';
			fonds.forEach(fond => {
				const option = document.createElement('option');
				option.value = fond.id;
				option.textContent = fond.libelle;
				select.appendChild(option);
			});
		});
}

function loadCategoriesDepenses() {
	return fetch('/api/categories-depenses')
		.then(response => response.json())
		.then(data => {
			categoriesDepenses = data || [];
		});
}

function setupEventListeners() {
	const directionSelect = document.getElementById('directionId');
	if (directionSelect) {
		directionSelect.addEventListener('change', handleDirectionChange);
	}

	document.querySelectorAll('.step-indicator').forEach(indicator => {
		indicator.addEventListener('click', () => {
			const target = parseInt(indicator.getAttribute('data-step'), 10);
			if (!isNaN(target) && target <= currentStep) {
				currentStep = target;
				updateStepDisplay();
				// Si on passe à l'étape 2, charger les participants si une direction est sélectionnée
				if (target === 2) {
					const directionId = document.getElementById('directionId').value;
					if (directionId) {
						loadParticipantsForDirection(directionId);
					}
				}
			}
		});
	});
}

function handleDirectionChange(event) {
	const directionId = event.target.value;
	
	// Si on est à l'étape 2, recharger les participants
	if (currentStep === 2) {
		selectedParticipants.clear();
		participantBudgets.clear();
		updateParticipantsCount();
		renderParticipantBudgets();

		if (!directionId) {
			participantsDisponibles = [];
			renderParticipantsTable();
			return;
		}

		renderParticipantsTable('loading');
		loadParticipantsForDirection(directionId);
	}
}

function loadParticipantsForDirection(directionId) {
	return fetch(`/api/users-by-direction/${directionId}?pageSize=200`)
		.then(response => response.json())
		.then(data => {
			participantsDisponibles = Array.isArray(data.users) ? data.users : [];
			renderParticipantsTable();
		})
		.catch(error => {
			console.error('Erreur lors du chargement des participants :', error);
			participantsDisponibles = [];
			renderParticipantsTable('error');
			showToast('Impossible de charger les participants pour cette direction.', 'error');
		});
}

function renderParticipantsTable(state = null) {
	const tbody = document.querySelector('#participantsTable tbody');
	if (!tbody) return;

	if (state === 'loading') {
		tbody.innerHTML = `
			<tr>
				<td colspan="4" class="text-center text-muted">
					<i class="fa fa-spinner fa-spin me-2"></i>Chargement des participants...
				</td>
			</tr>
		`;
		return;
	}

	const directionSelect = document.getElementById('directionId');
	const directionId = directionSelect ? directionSelect.value : '';

	if (!directionId) {
		tbody.innerHTML = `
			<tr>
				<td colspan="4" class="text-center text-muted">
					Sélectionnez une direction pour afficher les participants disponibles.
				</td>
			</tr>
		`;
		updateParticipantsCount();
		return;
	}

	if (state === 'error') {
		tbody.innerHTML = `
			<tr>
				<td colspan="4" class="text-center text-danger">
					Une erreur est survenue lors du chargement des participants.
				</td>
			</tr>
		`;
		updateParticipantsCount();
		return;
	}

	if (!participantsDisponibles.length) {
		tbody.innerHTML = `
			<tr>
				<td colspan="4" class="text-center text-muted">
					Aucun collaborateur disponible pour cette direction.
				</td>
			</tr>
		`;
		updateParticipantsCount();
		return;
	}

	const rows = participantsDisponibles.map(user => {
		const userId = Number(user.id);
		const checkboxId = `participant-${userId}`;
		const nom = [user.nom, user.prenom].filter(Boolean).join(' ') || '-';
		const email = user.email || '-';
		const service = user.service || '-';
		const isChecked = selectedParticipants.has(userId);

		return `
			<tr>
				<td>
					<div class="form-check">
						<input class="form-check-input participant-checkbox" type="checkbox" value="${userId}" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
					</div>
				</td>
				<td>
					<label class="form-check-label" for="${checkboxId}">
						${nom}
					</label>
				</td>
				<td>${email}</td>
				<td>${service}</td>
			</tr>
		`;
	}).join('');

	tbody.innerHTML = rows;

	// Attacher les événements
	document.querySelectorAll('.participant-checkbox').forEach(checkbox => {
		checkbox.addEventListener('change', handleParticipantToggle);
	});

	updateParticipantsCount();
	renderParticipantBudgets();
}

function handleParticipantToggle(event) {
	const userId = Number(event.target.value);
	const isChecked = event.target.checked;

	if (isChecked) {
		selectedParticipants.set(userId, participantsDisponibles.find(u => Number(u.id) === userId));
		if (!participantBudgets.has(userId)) {
			participantBudgets.set(userId, new Map());
		}
	} else {
		selectedParticipants.delete(userId);
		participantBudgets.delete(userId);
	}

	updateParticipantsCount();
	renderParticipantBudgets();
}

function updateParticipantsCount() {
	const count = selectedParticipants.size;
	const badge = document.getElementById('participantsCount');
	if (badge) {
		badge.textContent = `${count} participant(s) sélectionné(s)`;
		badge.className = count > 0 ? 'badge bg-success' : 'badge bg-secondary';
	}
}

function renderParticipantBudgets() {
	const container = document.getElementById('participantBudgetContainer');
	if (!container) return;

	if (selectedParticipants.size === 0) {
		container.innerHTML = '<div class="alert alert-info">Sélectionnez des participants pour définir leurs dépenses.</div>';
		return;
	}

	if (categoriesDepenses.length === 0) {
		container.innerHTML = '<div class="alert alert-warning">Chargement des catégories de dépenses...</div>';
		return;
	}

	let html = '<h5 class="mb-3">Dépenses par participant</h5>';

	selectedParticipants.forEach((user, userId) => {
		const userBudgets = participantBudgets.get(userId) || new Map();
		const nom = [user.nom, user.prenom].filter(Boolean).join(' ') || 'Utilisateur';

		html += `
			<div class="card mb-3">
				<div class="card-header bg-primary text-white">
					<strong>${nom}</strong>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-sm">
							<thead>
								<tr>
									<th>Catégorie de dépense</th>
									<th width="200">Montant (prévu = réel)</th>
								</tr>
							</thead>
							<tbody id="budgetRows_${userId}">
								${categoriesDepenses.map(cat => {
									const montant = userBudgets.get(Number(cat.id)) || '';
									return `
										<tr>
											<td>${cat.libelle}</td>
											<td>
												<div class="input-group input-group-sm">
													<input type="number" class="form-control budget-input" 
														data-user-id="${userId}" 
														data-categorie-id="${cat.id}" 
														value="${montant}" 
														min="0" step="1000" 
														placeholder="0">
													<span class="input-group-text">FCFA</span>
												</div>
											</td>
										</tr>
									`;
								}).join('')}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		`;
	});

	container.innerHTML = html;

	// Attacher les événements
	document.querySelectorAll('.budget-input').forEach(input => {
		input.addEventListener('input', handleBudgetChange);
	});
}

function handleBudgetChange(event) {
	const userId = Number(event.target.dataset.userId);
	const categorieId = Number(event.target.dataset.categorieId);
	const montant = parseFloat(event.target.value) || 0;

	if (!participantBudgets.has(userId)) {
		participantBudgets.set(userId, new Map());
	}

	const userBudgets = participantBudgets.get(userId);
	if (montant > 0) {
		userBudgets.set(categorieId, montant);
	} else {
		userBudgets.delete(categorieId);
	}
}

function nextStep() {
	if (currentStep === 1) {
		if (!validateStep1()) {
			return;
		}
		// Charger les participants de la direction sélectionnée avant de passer à l'étape 2
		const directionId = document.getElementById('directionId').value;
		if (directionId) {
			renderParticipantsTable('loading');
			loadParticipantsForDirection(directionId).then(() => {
				currentStep++;
				updateStepDisplay();
			});
		} else {
			currentStep++;
			updateStepDisplay();
		}
	} else if (currentStep === 2) {
		if (!validateStep2()) {
			return;
		}
		updateRecap();
		currentStep++;
		updateStepDisplay();
	}
}

function previousStep() {
	if (currentStep > 1) {
		currentStep--;
		updateStepDisplay();
	}
}

function validateStep1() {
	const missionId = document.getElementById('missionModeleId').value;
	const directionId = document.getElementById('directionId').value;
	const fondsId = document.getElementById('fondsId').value;
	const lieuReel = document.getElementById('lieuReel').value;
	const dateReelleDebut = document.getElementById('dateReelleDebut').value;
	const dateReelleFin = document.getElementById('dateReelleFin').value;

	if (!missionId) {
		showToast('Veuillez sélectionner une mission', 'error');
		return false;
	}

	if (!directionId) {
		showToast('Veuillez sélectionner une direction', 'error');
		return false;
	}

	if (!fondsId) {
		showToast('Veuillez sélectionner un type de fonds', 'error');
		return false;
	}

	if (!lieuReel) {
		showToast('Veuillez renseigner le lieu réel', 'error');
		return false;
	}

	if (!dateReelleDebut || !dateReelleFin) {
		showToast('Veuillez renseigner les dates réelles', 'error');
		return false;
	}

	if (new Date(dateReelleDebut) > new Date(dateReelleFin)) {
		showToast('La date de début ne peut pas être postérieure à la date de fin', 'error');
		return false;
	}

	return true;
}

function validateStep2() {
	if (selectedParticipants.size === 0) {
		showToast('Veuillez sélectionner au moins un participant', 'error');
		return false;
	}

	return true;
}

function updateStepDisplay() {
	// Masquer toutes les étapes
	for (let i = 1; i <= totalSteps; i++) {
		const stepContent = document.getElementById(`step${i}`);
		const stepIndicator = document.querySelector(`.step-indicator[data-step="${i}"]`);
		
		if (stepContent) {
			stepContent.classList.toggle('d-none', i !== currentStep);
		}
		
		if (stepIndicator) {
			stepIndicator.classList.remove('active', 'completed');
			if (i < currentStep) {
				stepIndicator.classList.add('completed');
			} else if (i === currentStep) {
				stepIndicator.classList.add('active');
			}
		}
	}

	// Mettre à jour la barre de progression
	const progressBar = document.getElementById('progressBar');
	if (progressBar) {
		const progress = (currentStep / totalSteps) * 100;
		progressBar.style.width = progress + '%';
		progressBar.setAttribute('aria-valuenow', progress);
	}

	// Afficher/masquer les boutons
	const prevBtn = document.getElementById('prevBtn');
	const nextBtn = document.getElementById('nextBtn');
	const submitBtn = document.getElementById('submitBtn');

	if (prevBtn) {
		prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
	}

	if (nextBtn) {
		nextBtn.style.display = currentStep < totalSteps ? 'block' : 'none';
	}

	if (submitBtn) {
		submitBtn.style.display = currentStep === totalSteps ? 'block' : 'none';
	}
}

function updateRecap() {
	const container = document.getElementById('recapContent');
	if (!container) return;

	const directionId = document.getElementById('directionId').value;
	const direction = directions.find(d => d.id == directionId);
	const missionId = document.getElementById('missionModeleId').value;
	const mission = missionModeles.find(m => m.id == missionId);
	const fondsId = document.getElementById('fondsId').value;
	const fondsSelected = fonds.find(f => f.id == fondsId);
	const lieuReel = document.getElementById('lieuReel').value;
	const dateReelleDebut = document.getElementById('dateReelleDebut').value;
	const dateReelleFin = document.getElementById('dateReelleFin').value;
	const notes = document.getElementById('notes').value;

	// Calculer le total des dépenses
	let totalDepenses = 0;
	participantBudgets.forEach((userBudgets) => {
		userBudgets.forEach((montant) => {
			totalDepenses += montant;
		});
	});

	// Calculer la durée
	let duree = 0;
	if (dateReelleDebut && dateReelleFin) {
		const debut = new Date(dateReelleDebut);
		const fin = new Date(dateReelleFin);
		duree = Math.ceil((fin - debut) / (1000 * 60 * 60 * 24)) + 1;
	}

	container.innerHTML = `
		<div class="row">
			<div class="col-md-6">
				<h6>Mission</h6>
				<p><strong>Modèle :</strong> ${mission ? mission.titre : 'Non sélectionné'}</p>
				<p><strong>Direction :</strong> ${direction ? direction.libelle : 'Non sélectionnée'}</p>
				<p><strong>Type de fonds :</strong> ${fondsSelected ? fondsSelected.libelle : 'Non sélectionné'}</p>
			</div>
			<div class="col-md-6">
				<h6>Dates & Lieu</h6>
				<p><strong>Date début :</strong> ${dateReelleDebut || 'Non renseigné'}</p>
				<p><strong>Date fin :</strong> ${dateReelleFin || 'Non renseigné'}</p>
				<p><strong>Durée :</strong> ${duree} jour(s)</p>
				<p><strong>Lieu réel :</strong> ${lieuReel || 'Non renseigné'}</p>
			</div>
		</div>
		<hr>
		<div class="row">
			<div class="col-md-6">
				<h6>Participants</h6>
				<p><strong>Nombre :</strong> ${selectedParticipants.size}</p>
				<ul>
					${Array.from(selectedParticipants.values()).map(user => 
						`<li>${[user.nom, user.prenom].filter(Boolean).join(' ')}</li>`
					).join('')}
				</ul>
			</div>
			<div class="col-md-6">
				<h6>Budget</h6>
				<p><strong>Total dépenses :</strong> <span class="text-primary fs-5">${formatNumber(totalDepenses)} FCFA</span></p>
			</div>
		</div>
		${notes ? `<hr><div><h6>Notes</h6><p>${notes}</p></div>` : ''}
	`;
}

function formatNumber(num) {
	return new Intl.NumberFormat('fr-FR').format(num);
}

function submitForm() {
	if (!validateStep2()) {
		return;
	}

	const missionId = document.getElementById('missionModeleId').value;
	const mission = missionModeles.find(m => m.id == missionId);
	const directionId = document.getElementById('directionId').value;
	const fondsId = document.getElementById('fondsId').value;
	const lieuReel = document.getElementById('lieuReel').value;
	const dateReelleDebut = document.getElementById('dateReelleDebut').value;
	const dateReelleFin = document.getElementById('dateReelleFin').value;
	const notes = document.getElementById('notes').value;

	// Construire les dépenses par catégorie avec allocations
	const depensesByCategorie = new Map();
	
	participantBudgets.forEach((userBudgets, userId) => {
		userBudgets.forEach((montant, categorieId) => {
			if (!depensesByCategorie.has(categorieId)) {
				depensesByCategorie.set(categorieId, {
					categorieId: categorieId,
					montant: 0,
					allocations: []
				});
			}
			const depense = depensesByCategorie.get(categorieId);
			depense.montant += montant;
			depense.allocations.push({
				userId: userId,
				montant: montant
			});
		});
	});

	const depensesReelles = Array.from(depensesByCategorie.values()).map(d => ({
		categorieId: d.categorieId,
		montant: d.montant.toFixed(2),
		allocations: d.allocations.map(a => ({
			userId: a.userId,
			montant: a.montant.toFixed(2)
		}))
	}));

	const formData = {
		missionId: missionId ? parseInt(missionId) : null,
		titre: mission ? mission.titre : '',
		directionId: parseInt(directionId),
		fondsId: parseInt(fondsId),
		lieuReel: lieuReel,
		dateReelleDebut: dateReelleDebut,
		dateReelleFin: dateReelleFin,
		notes: notes,
		participants: Array.from(selectedParticipants.keys()),
		depensesReelles: depensesReelles
	};

	const payload = new FormData();
	payload.append('data', JSON.stringify(formData));

	const submitBtn = document.getElementById('submitBtn');
	const originalText = submitBtn.innerHTML;
	submitBtn.disabled = true;
	submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Création...';

	fetch('{{ path('app_mission_create_executed_post') }}', {
		method: 'POST',
		body: payload
	})
	.then(response => response.json())
	.then(data => {
		if (data.success) {
			showToast(data.message || 'Mission exécutée créée avec succès', 'success');
			setTimeout(() => {
				window.location.href = data.id ? "{{ path('app_mission_show', {'id': '__ID__'}) }}".replace('__ID__', data.id) : '{{ path('app_mission_index') }}';
			}, 1500);
		} else {
			showToast(data.message || 'Une erreur est survenue', 'error');
			submitBtn.disabled = false;
			submitBtn.innerHTML = originalText;
		}
	})
	.catch(error => {
		console.error('Erreur:', error);
		showToast('Erreur lors de la création', 'error');
		submitBtn.disabled = false;
		submitBtn.innerHTML = originalText;
	});
}

function showToast(message, type = 'info') {
	if (typeof Swal !== 'undefined') {
		Swal.fire({
			toast: true,
			position: 'top-end',
			showConfirmButton: false,
			timer: 3000,
			icon: type,
			title: message
		});
	} else {
		alert(message);
	}
}
</script>
{% endblock %}
