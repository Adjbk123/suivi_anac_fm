{% extends 'base.html.twig' %}

{% block title %}Missions{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
	<li class="breadcrumb-item active">MISSIONS</li>
</ul>
{% endblock %}

{% block page_title %}
<h1 class="page-header">
	Missions <small>Gestion des missions</small>
</h1>
{% endblock %}

{% block buttons %}
<div class="d-flex gap-2">
	{% if can_create_mission() %}
	<div class="dropdown">
		<button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
			<i class="fa fa-plus"></i> Nouvelle Mission
		</button>
		<ul class="dropdown-menu">
			<li>
				<a class="dropdown-item" href="{{ path('app_mission_modele_create') }}">
					<i class="fa fa-plus text-secondary"></i> Nouvelle mission (modèle)
				</a>
			</li>
			<li>
				<a class="dropdown-item" href="{{ path('app_mission_create') }}">
					<i class="fa fa-plane text-secondary"></i> Nouvelle session
	</a>
			</li>
			<li><hr class="dropdown-divider"></li>
			<li>
				<a class="dropdown-item" href="{{ path('app_mission_create_executed') }}">
					<i class="fa fa-check-circle text-success"></i> Mission exécutée (non prévue)
				</a>
			</li>
		</ul>
	</div>
	{% endif %}
</div>
{% endblock %}

{% block body %}
<div class="row">
	<div class="col-xl-12">
		<!-- Section des filtres -->
		<div class="card mb-3">
			<div class="card-header">
				<h5 class="card-title mb-0">
					<i class="fa fa-filter"></i> Filtres
				</h5>
			</div>
			<div class="card-body">
				<div class="row">
					<div class="col-md-3">
						<label for="statutFilter" class="form-label">Statut</label>
						<select class="form-select" id="statutFilter">
							<option value="">Tous les statuts</option>
						</select>
					</div>
					<div class="col-md-3">
						<label for="directionFilter" class="form-label">Direction</label>
						<select class="form-select" id="directionFilter">
							<option value="">Toutes les directions</option>
						</select>
					</div>
					<div class="col-md-3">
						<label for="periodeFilter" class="form-label">Période</label>
						<select class="form-select mb-2" id="periodeFilter" name="periode_type">
							<option value="">Toutes les périodes</option>
							<option value="mois">Ce mois</option>
							<option value="trimestre">Ce trimestre</option>
							<option value="semestre1">1er semestre</option>
							<option value="semestre2">2ème semestre</option>
							<option value="annee">Cette année</option>
							<option value="personnalisee">Période personnalisée</option>
						</select>
						<div class="row" id="dateRangeContainer" style="display: none;">
							<div class="col-6 mb-2">
								<label class="form-label small">Date début</label>
								<input type="date" class="form-control form-control-sm" name="date_debut" id="dateDebut">
							</div>
							<div class="col-6 mb-2">
								<label class="form-label small">Date fin</label>
								<input type="date" class="form-control form-control-sm" name="date_fin" id="dateFin">
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<label for="participantFilter" class="form-label">Participant</label>
						<select class="form-select" id="participantFilter">
							<option value="">Tous les participants</option>
						</select>
					</div>
				</div>
				<div class="row mt-3">
					<div class="col-12 text-center">
						<button type="button" class="btn btn-secondary btn-sm" onclick="applyFilters()">
							<i class="fa fa-search"></i> Appliquer les filtres
						</button>
						<button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetFilters()">
							<i class="fa fa-refresh"></i> Réinitialiser
						</button>
						<button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportBudgetReport()">
							<i class="fa fa-chart-line"></i> Rapport Budget
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Widget de Performance des Missions -->
		<div class="row mb-3">
			<div class="col-xl-12">
				{% include 'widgets/performance_summary.html.twig' with {
					'title': 'Performance Missions ' ~ currentYear,
					'header_color': 'secondary',
					'header_icon': 'fa-plane',
					'physique_taux': performanceData.taux_physique,
					'physique_color': performanceData.couleur_physique,
					'physique_icon': performanceData.icon_physique,
					'financier_taux': performanceData.taux_financier,
					'financier_color': performanceData.couleur_financier,
					'financier_icon': performanceData.icon_financier,
					'realisees': performanceData.missions_realisees,
					'prevues': performanceData.missions_prevues,
					'budget_reel': performanceData.depenses_reelles,
					'budget_prevu': performanceData.budget_prevu,
					'en_cours': performanceData.missions_en_cours
				} %}
			</div>
		</div>

		<!-- Tableau des missions -->
		<div class="card">
			<div class="card-body">
				<div class="table-responsive">
					<table id="missionsTable" class="table table-hover">
						<thead class="table-secondary">
							<tr>
								<th>ID</th>
								<th>Titre</th>
								<th>Direction</th>
								<th>Fonds</th>
								<th>Dates prévues</th>
								<th>Durée</th>
								<th>Budget prévu</th>
								<th>Statut</th>
								                        <th><i class="fa fa-cogs"></i></th>
							</tr>
						</thead>
						<tbody>
							<!-- Les données seront chargées via AJAX -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block javascripts %}
<script>
let missionsTable = null;
let filtersData = null;

document.addEventListener('DOMContentLoaded', function() {
    loadFiltersData();
    initializeDataTable();
    // Mettre à jour les performances au chargement initial
    updatePerformance({});
});

function loadFiltersData() {
    fetch("{{ path('app_mission_filters_data') }}")
        .then(response => response.json())
        .then(data => {
            filtersData = data;
            populateFilters();
        })
        .catch(error => {
            console.error('Erreur lors du chargement des données de filtres:', error);
        });
}

function populateFilters() {
    if (!filtersData) return;
    const statutFilter = document.getElementById('statutFilter');
    filtersData.statuts.forEach(statut => {
        const option = document.createElement('option');
        option.value = statut.id;
        option.textContent = statut.libelle;
        statutFilter.appendChild(option);
    });

    const directionFilter = document.getElementById('directionFilter');
    filtersData.directions.forEach(direction => {
        const option = document.createElement('option');
        option.value = direction.id;
        option.textContent = direction.libelle;
        directionFilter.appendChild(option);
    });

    const participantFilter = document.getElementById('participantFilter');
    filtersData.users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `${user.nom} ${user.prenom} (${user.email})`;
        participantFilter.appendChild(option);
    });
}

function initializeDataTable() {
    if (typeof $.fn.DataTable === 'undefined') {
        console.error('DataTables n\'est pas chargé');
        return;
    }
    if ($('#missionsTable').length === 0) {
        console.error('Table missionsTable non trouvée');
        return;
    }

    missionsTable = $('#missionsTable').DataTable({
        ajax: {
            url: "{{ path('app_mission_list') }}",
            dataSrc: '',
            data: function(d) {
                const filters = getFilters();
                Object.keys(filters).forEach(key => {
                    if (filters[key] && filters[key] !== '') {
                        d[key] = filters[key];
                    }
                });
            }
        },
        columns: [
            { data: 'id' },
            { data: 'titre' },
            { data: 'direction' },
            { data: 'fonds' },
            { 
                data: null,
                render: function(data, type, row) {
                    return row.datePrevueDebut + ' - ' + row.datePrevueFin;
                }
            },
            { data: 'dureePrevue' },
            { data: 'budgetPrevu' },
            { 
                data: null,
                render: function(data, type, row) {
                    return `<span class="badge bg-${row.statut_couleur}">${row.statut}</span>`;
                }
            },
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                    return `
                        <div class="dropdown" style="position: relative;">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="position: relative; z-index: 1;">
                                <i class="fa fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" style="position: absolute; z-index: 99999; right: 0; left: auto;">
                                <li><a class="dropdown-item" href="/mission/${row.id}">
                                    <i class="fa fa-eye text-info"></i> Voir
                                </a></li>
                                ${row.statut_code !== "prevue_executee" ? 
                                    `<li><a class="dropdown-item" href="/mission/${row.id}/edit">
                                        <i class="fa fa-edit text-warning"></i> Modifier
                                    </a></li>` : ""
                                }
                                <li><a class="dropdown-item" href="#" onclick="deleteMission(${row.id})">
                                    <i class="fa fa-trash text-danger"></i> Supprimer
                                </a></li>
                            </ul>
                        </div>`;
                }
            }
        ],
        language: {
            "sProcessing":     "Traitement en cours...",
            "sSearch":         "Rechercher&nbsp;:",
            "sLengthMenu":     "Afficher _MENU_ éléments",
            "sInfo":           "Affichage de l'élément _START_ à _END_ sur _TOTAL_ éléments",
            "sInfoEmpty":      "Affichage de l'élément 0 à 0 sur 0 élément",
            "sInfoFiltered":   "(filtré de _MAX_ éléments au total)",
            "sLoadingRecords": "Chargement...",
            "sZeroRecords":    "Aucun élément à afficher",
            "sEmptyTable":     "Aucune donnée disponible dans le tableau",
            "oPaginate": {
                "sFirst":    '<i class="fa fa-angle-double-left" style="font-size: 12px;"></i>',
                "sPrevious": '<i class="fa fa-angle-left" style="font-size: 12px;"></i>',
                "sNext":     '<i class="fa fa-angle-right" style="font-size: 12px;"></i>',
                "sLast":     '<i class="fa fa-angle-double-right" style="font-size: 12px;"></i>'
            },
            "oAria": {
                "sSortAscending":  ": activer pour trier la colonne par ordre croissant",
                "sSortDescending": ": activer pour trier la colonne par ordre décroissant"
            }
        },
        responsive: true,
        order: [[0, 'asc']],
        dom: 'Bfrtip',
        buttons: [
            { extend: 'copy', text: '<i class="fa fa-copy"></i> Copier', className: 'btn btn-sm btn-outline-secondary' },
            { extend: 'csv', text: '<i class="fa fa-file-csv"></i> CSV', className: 'btn btn-sm btn-outline-secondary' },
            { extend: 'excel', text: '<i class="fa fa-file-excel"></i> Excel', className: 'btn btn-sm btn-outline-secondary' },
            { extend: 'pdf', text: '<i class="fa fa-file-pdf"></i> PDF', className: 'btn btn-sm btn-outline-secondary' },
            { extend: 'print', text: '<i class="fa fa-print"></i> Imprimer', className: 'btn btn-sm btn-outline-secondary' }
        ]
    });

    missionsTable.on('preXhr', function() {
        $('#missionsTable tbody').html(`
            <tr>
                <td colspan="9" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </td>
            </tr>
        `);
    });
}

function getFilters() {
    const filters = {
        statut: document.getElementById('statutFilter').value,
        direction: document.getElementById('directionFilter').value,
        periode: document.getElementById('periodeFilter').value,
        participant: document.getElementById('participantFilter').value
    };
    
    // Ajouter les dates si période personnalisée
    const dateDebut = document.getElementById('dateDebut');
    const dateFin = document.getElementById('dateFin');
    if (dateDebut && dateDebut.value) {
        filters.date_debut = dateDebut.value;
    }
    if (dateFin && dateFin.value) {
        filters.date_fin = dateFin.value;
    }
    
    return filters;
}

function applyFilters() {
    const filters = getFilters();
    if (missionsTable) {
        missionsTable.ajax.reload();
    }
    updatePerformance(filters);
}

function resetFilters() {
    document.getElementById('statutFilter').value = '';
    document.getElementById('directionFilter').value = '';
    document.getElementById('periodeFilter').value = '';
    document.getElementById('participantFilter').value = '';
    
    const dateRangeContainer = document.getElementById('dateRangeContainer');
    const dateDebut = document.getElementById('dateDebut');
    const dateFin = document.getElementById('dateFin');
    if (dateRangeContainer) dateRangeContainer.style.display = 'none';
    if (dateDebut) dateDebut.value = '';
    if (dateFin) dateFin.value = '';

    if (missionsTable) {
        missionsTable.ajax.reload();
    }
    updatePerformance({});
}

// Fonction pour calculer les dates selon la période sélectionnée
function calculatePeriodDates(periodType) {
    const now = new Date();
    const year = {{ currentYear }};
    let dateDebut, dateFin;

    switch(periodType) {
        case 'mois':
            const month = now.getMonth();
            dateDebut = new Date(year, month, 1).toISOString().split('T')[0];
            dateFin = new Date(year, month + 1, 0).toISOString().split('T')[0];
            break;
        
        case 'trimestre':
            const currentQuarter = Math.floor(now.getMonth() / 3);
            const quarterStartMonth = currentQuarter * 3;
            dateDebut = new Date(year, quarterStartMonth, 1).toISOString().split('T')[0];
            dateFin = new Date(year, quarterStartMonth + 3, 0).toISOString().split('T')[0];
            break;
        
        case 'semestre1':
            dateDebut = new Date(year, 0, 1).toISOString().split('T')[0];
            dateFin = new Date(year, 5, 30).toISOString().split('T')[0];
            break;
        
        case 'semestre2':
            dateDebut = new Date(year, 6, 1).toISOString().split('T')[0];
            dateFin = new Date(year, 11, 31).toISOString().split('T')[0];
            break;
        
        case 'annee':
            dateDebut = new Date(year, 0, 1).toISOString().split('T')[0];
            dateFin = new Date(year, 11, 31).toISOString().split('T')[0];
            break;
        
        default:
            return;
    }

    const dateDebutInput = document.getElementById('dateDebut');
    const dateFinInput = document.getElementById('dateFin');
    if (dateDebutInput) dateDebutInput.value = dateDebut;
    if (dateFinInput) dateFinInput.value = dateFin;
}

// Gestionnaire d'événement pour le filtre de période
document.addEventListener('DOMContentLoaded', function() {
    const periodeFilter = document.getElementById('periodeFilter');
    const dateRangeContainer = document.getElementById('dateRangeContainer');
    
    if (periodeFilter) {
        periodeFilter.addEventListener('change', function() {
            const selectedPeriod = this.value;
            
            if (selectedPeriod === 'personnalisee') {
                if (dateRangeContainer) dateRangeContainer.style.display = 'block';
            } else if (selectedPeriod === '') {
                if (dateRangeContainer) dateRangeContainer.style.display = 'none';
                const dateDebut = document.getElementById('dateDebut');
                const dateFin = document.getElementById('dateFin');
                if (dateDebut) dateDebut.value = '';
                if (dateFin) dateFin.value = '';
            } else {
                calculatePeriodDates(selectedPeriod);
                if (dateRangeContainer) dateRangeContainer.style.display = 'none';
            }
        });
    }
});

// Fonction pour mettre à jour les performances selon les filtres
function updatePerformance(filters) {
    const formData = new FormData();
    
    // Toujours ajouter l'année
    formData.append('annee', {{ currentYear }});
    
    // Récupérer directement depuis les champs pour être sûr
    const statutFilter = document.getElementById('statutFilter');
    const directionFilter = document.getElementById('directionFilter');
    const dateDebut = document.getElementById('dateDebut');
    const dateFin = document.getElementById('dateFin');
    
    if (statutFilter && statutFilter.value) {
        formData.append('statut', statutFilter.value);
    }
    if (directionFilter && directionFilter.value) {
        formData.append('direction', directionFilter.value);
    }
    if (dateDebut && dateDebut.value) {
        formData.append('date_debut', dateDebut.value);
    }
    if (dateFin && dateFin.value) {
        formData.append('date_fin', dateFin.value);
    }
    
    // Ajouter les autres filtres depuis l'objet si fourni
    if (filters) {
        Object.keys(filters).forEach(key => {
            if (filters[key] && filters[key] !== '' && key !== 'periode' && key !== 'date_debut' && key !== 'date_fin' && key !== 'statut' && key !== 'direction') {
                formData.append(key, filters[key]);
            }
        });
    }
    
    // Afficher les filtres envoyés pour débogage
    console.log('Filtres envoyés pour les performances:', Object.fromEntries(formData));
    
    fetch("{{ path('app_mission_performance') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Données de performance reçues:', data);
        // Vérifier que les données sont valides
        if (data && typeof data.taux_physique !== 'undefined') {
            updatePerformanceWidget(data);
        } else {
            console.error('Données de performance invalides:', data);
        }
    })
    .catch(error => {
        console.error('Erreur lors de la mise à jour des performances:', error);
    });
}

// Fonction pour mettre à jour le widget de performance
function updatePerformanceWidget(data) {
    // Mettre à jour le taux physique
    const physiqueBadge = document.querySelector('.card-body .col-md-6:first-child .badge.fs-5');
    if (physiqueBadge) {
        const icon = data.icon_physique || (data.taux_physique >= 50 ? 'fa-check-circle' : 'fa-times-circle');
        const color = data.couleur_physique || (data.taux_physique >= 50 ? 'success' : 'danger');
        physiqueBadge.innerHTML = `<i class="fa ${icon} me-1 text-${color}"></i> ${data.taux_physique}%`;
    }
    
    // Mettre à jour le taux financier
    const financierBadge = document.querySelector('.card-body .col-md-6:last-child .badge.fs-5');
    if (financierBadge) {
        const icon = data.icon_financier || 'fa-check-circle';
        const color = data.couleur_financier || 'success';
        financierBadge.innerHTML = `<i class="fa ${icon} me-1 text-${color}"></i> ${data.taux_financier}%`;
    }
    
    // Mettre à jour les détails physiques
    // Chercher le badge qui contient "réalisées" dans la première colonne
    const firstColumn = document.querySelector('.card-body .col-md-6:first-child');
    if (firstColumn) {
        const badges = firstColumn.querySelectorAll('.badge.bg-light.text-dark');
        badges.forEach(badge => {
            if (!badge.classList.contains('fs-5') && badge.textContent.includes('réalisées')) {
                badge.textContent = `${data.missions_realisees}/${data.missions_prevues} réalisées`;
            }
        });
    }
    
    // Mettre à jour les détails financiers
    const budgetContainer = document.querySelector('.card-body .col-md-6:last-child .small.text-muted');
    if (budgetContainer) {
        const budgetReel = new Intl.NumberFormat('fr-FR').format(data.depenses_reelles || 0);
        const budgetPrevu = new Intl.NumberFormat('fr-FR').format(data.budget_prevu || 0);
        budgetContainer.innerHTML = `<div>${budgetReel} FCFA</div><div>sur ${budgetPrevu} FCFA</div>`;
    }
}

function exportExcel() {
    const filters = getFilters();
    const url = new URL("{{ path('app_mission_export_excel') }}", window.location.origin);
    Object.keys(filters).forEach(key => {
        if (filters[key] && filters[key] !== '') {
            url.searchParams.append(key, filters[key]);
        }
    });
    window.open(url.toString(), '_blank');
}

function exportBudgetReport() {
    const filters = getFilters();
    const url = new URL("{{ path('app_mission_export_budget_report') }}", window.location.origin);
    Object.keys(filters).forEach(key => {
        if (filters[key] && filters[key] !== '') {
            url.searchParams.append(key, filters[key]);
        }
    });
    window.open(url.toString(), '_blank');
}

function deleteMission(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette mission ?')) {
        fetch(`/mission/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                missionsTable.ajax.reload();
            } else {
                showToast(data.message || 'Erreur lors de la suppression', 'error');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showToast('Erreur lors de la suppression de la mission', 'error');
        });
    }
}
</script>
{% endblock %}
