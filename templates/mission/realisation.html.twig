{% extends 'base.html.twig' %}

{% block title %}Réalisation de la Mission{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
	<li class="breadcrumb-item"><a href="{{ path('app_mission_index') }}">MISSIONS</a></li>
	<li class="breadcrumb-item"><a href="{{ path('app_mission_show', {'id': missionSession.id}) }}">DÉTAIL</a></li>
	<li class="breadcrumb-item active">RÉALISATION</li>
</ul>
{% endblock %}

{% block page_title %}
<h1 class="page-header">
	Réalisation de la Mission <small>{{ mission.titre }}</small>
</h1>
{% endblock %}

{% block buttons %}
<div class="d-flex gap-2">
	<a href="{{ path('app_mission_show', {'id': missionSession.id}) }}" class="btn btn-secondary btn-sm">
		<i class="fa fa-arrow-left"></i> Retour
	</a>
</div>
{% endblock %}

{% block body %}
<div class="row">
	<div class="col-xl-12">
		<div class="card">
			<div class="card-header">
				<h5 class="card-title mb-0">
					<i class="fa fa-check-circle text-success"></i> Marquer la mission comme réalisée
				</h5>
			</div>
			<div class="card-body">
				<!-- Étapes de progression -->
				<div class="mb-4">
					<div class="progress" style="height: 4px;">
						<div class="progress-bar" id="progressBar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
					</div>
					<div class="d-flex justify-content-between mt-2">
						<span class="step-indicator active" data-step="1">1. Informations réelles</span>
						<span class="step-indicator" data-step="2">2. Pointage participants</span>
						<span class="step-indicator" data-step="3">3. Dépenses réelles</span>
						<span class="step-indicator" data-step="4">4. Validation</span>
					</div>
				</div>

				<!-- Étape 1: Informations réelles -->
				<div class="step-content" id="step1">
					<h4 class="mb-3"><i class="fa fa-info-circle text-primary"></i> Informations de la mission</h4>
					
					<!-- Informations de prévision (lecture seule) -->
					<div class="card mb-4">
						<div class="card-header">
							<h6 class="mb-0"><i class="fa fa-calendar text-info"></i> Informations prévisionnelles</h6>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">Titre de la mission</label>
										<input type="text" class="form-control" value="{{ mission.titre }}" readonly>
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">Direction responsable</label>
										<input type="text" class="form-control" value="{{ mission.direction.libelle }}" readonly>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">Type de fonds</label>
										<input type="text" class="form-control" value="{{ mission.fonds.libelle }}" readonly>
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">Lieu prévu</label>
										<input type="text" class="form-control" value="{{ mission.lieuPrevu }}" readonly>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-md-4">
									<div class="mb-3">
										<label class="form-label">Date de début prévue</label>
										<input type="text" class="form-control" value="{{ mission.datePrevueDebut|date('d/m/Y') }}" readonly>
									</div>
								</div>
								<div class="col-md-4">
									<div class="mb-3">
										<label class="form-label">Date de fin prévue</label>
										<input type="text" class="form-control" value="{{ mission.datePrevueFin|date('d/m/Y') }}" readonly>
									</div>
								</div>
								<div class="col-md-4">
									<div class="mb-3">
										<label class="form-label">Durée prévue</label>
										<input type="text" class="form-control" value="{{ mission.dureePrevue }} jours" readonly>
									</div>
								</div>
							</div>
							{% if mission.description %}
							<div class="mb-3">
								<label class="form-label">Description</label>
								<textarea class="form-control" rows="3" readonly>{{ mission.description }}</textarea>
							</div>
							{% endif %}
						</div>
					</div>
					
					<!-- Informations réelles (modifiables) -->
					<div class="card">
						<div class="card-header">
							<h6 class="mb-0"><i class="fa fa-check-circle text-success"></i> Informations réelles</h6>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label for="dateReelleDebut" class="form-label">Date réelle de début *</label>
										<input type="date" class="form-control" id="dateReelleDebut" required>
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<label for="dateReelleFin" class="form-label">Date réelle de fin *</label>
										<input type="date" class="form-control" id="dateReelleFin" required>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label for="lieuReel" class="form-label">Lieu réel *</label>
										<input type="text" class="form-control" id="lieuReel" placeholder="Lieu où s'est réellement déroulée la mission" required>
									</div>
								</div>
								<div class="col-md-6">
								</div>
							</div>
						</div>
					</div>
					<div class="d-flex justify-content-end mt-3">
						<button type="button" class="btn btn-primary" onclick="nextStep(2)">
							Suivant <i class="fa fa-arrow-right"></i>
						</button>
					</div>
				</div>

				<!-- Étape 2: Pointage participants -->
				<div class="step-content d-none" id="step2">
					<h4 class="mb-3"><i class="fa fa-users text-primary"></i> Pointage des participants</h4>
					
					<!-- Participants prévus -->
					<div class="mb-4">
						<h6 class="text-primary">Participants prévus</h6>
						<div class="table-responsive">
							<table class="table table-hover" id="participantsTable">
								<thead class="table-secondary">
									<tr>
										<th>Nom</th>
										<th>Prénom</th>
										<th>Matricule</th>
										<th>Statut de participation</th>
										<th>Statut actuel</th>
									</tr>
								</thead>
								<tbody>
									<!-- Les données seront chargées via AJAX -->
								</tbody>
							</table>
						</div>
					</div>

					<div class="d-flex justify-content-between mt-4">
						<button type="button" class="btn btn-secondary" onclick="prevStep(1)">
							<i class="fa fa-arrow-left"></i> Précédent
						</button>
						<button type="button" class="btn btn-primary" onclick="nextStep(3)">
							Suivant <i class="fa fa-arrow-right"></i>
						</button>
					</div>
				</div>

				<!-- Étape 3: Dépenses réelles -->
				<div class="step-content d-none" id="step3">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h4 class="mb-0"><i class="fa fa-money-bill text-primary"></i> Dépenses réelles</h4>
						<button type="button" class="btn btn-success btn-sm" onclick="showAddDepenseModal()">
							<i class="fa fa-plus"></i> Ajouter une dépense
						</button>
					</div>
					<div class="alert alert-info">
						<i class="fa fa-info-circle me-2"></i>
						Les montants prévus sont pré-remplis comme montants réels. Ajustez-les pour chaque participant si nécessaire.
					</div>
					<div id="participantExpensesContainer" class="mb-4">
						<!-- Cartes générées dynamiquement -->
					</div>
					<div class="card bg-light mb-4">
						<div class="card-body">
							<div class="row text-center">
								<div class="col-md-4 mb-2 mb-md-0">
									<h6 class="text-uppercase text-muted mb-1">Total prévu</h6>
									<div class="fw-bold" id="totalPrevu">0 FCFA</div>
								</div>
								<div class="col-md-4 mb-2 mb-md-0">
									<h6 class="text-uppercase text-muted mb-1">Total réel</h6>
									<div class="fw-bold text-primary" id="totalReel">0 FCFA</div>
								</div>
								<div class="col-md-4">
									<h6 class="text-uppercase text-muted mb-1">Écart global</h6>
									<div class="fw-bold" id="totalEcart">0 FCFA</div>
								</div>
							</div>
						</div>
					</div>
					<div class="d-flex justify-content-between">
						<button type="button" class="btn btn-secondary" onclick="prevStep(2)">
							<i class="fa fa-arrow-left"></i> Précédent
						</button>
						<button type="button" class="btn btn-primary" onclick="nextStep(4)">
							Suivant <i class="fa fa-arrow-right"></i>
						</button>
					</div>
				</div>

				<!-- Étape 4: Validation -->
				<div class="step-content d-none" id="step4">
					<h4 class="mb-3"><i class="fa fa-check-circle text-primary"></i> Récapitulatif et validation</h4>
					<div class="row">
						<div class="col-md-4">
							<div class="card">
								<div class="card-header">
									<h6 class="card-title mb-0">Informations réelles</h6>
								</div>
								<div class="card-body">
									<p><strong>Date début :</strong> <span id="recapDateDebut"></span></p>
									<p><strong>Date fin :</strong> <span id="recapDateFin"></span></p>
									<p><strong>Lieu :</strong> <span id="recapLieu"></span></p>
									<p><strong>Durée réelle :</strong> <span id="recapDureeReelle"></span></p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card">
								<div class="card-header">
									<h6 class="card-title mb-0">Participants</h6>
								</div>
								<div class="card-body">
									<p><strong>Participants prévus :</strong> <span id="recapParticipantsPrevus"></span></p>
									<p><strong>Total participants :</strong> <span id="recapTotalParticipants"></span></p>
									<p><strong>Participants présents :</strong> <span id="recapParticipantsPresents"></span></p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card">
								<div class="card-header">
									<h6 class="card-title mb-0">Dépenses</h6>
								</div>
								<div class="card-body">
									<p><strong>Budget prévu :</strong> <span id="recapBudgetPrevu"></span></p>
									<p><strong>Dépenses réelles :</strong> <span id="recapDepensesReelles"></span></p>
									<p><strong>Écart :</strong> <span id="recapEcartBudget"></span></p>
									<p><strong>Nombre de dépenses :</strong> <span id="recapNombreDepenses"></span></p>
								</div>
							</div>
						</div>
					</div>
					<div class="d-flex justify-content-between mt-4">
						<button type="button" class="btn btn-secondary" onclick="prevStep(3)">
							<i class="fa fa-arrow-left"></i> Précédent
						</button>
						<button type="button" class="btn btn-success" onclick="validerRealisation()">
							<i class="fa fa-check"></i> Valider la réalisation
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Modal pour ajouter une dépense -->
<div class="modal fade" id="addDepenseModal" tabindex="-1" aria-labelledby="addDepenseModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addDepenseModalLabel">
					<i class="fa fa-plus text-success"></i> Ajouter une dépense
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form id="addDepenseForm">
					<div class="mb-3">
						<label for="depenseCategorie" class="form-label">Catégorie de dépense *</label>
						<select class="form-select" id="depenseCategorie" required>
							<option value="">Sélectionner une catégorie...</option>
						</select>
					</div>
					<div class="mb-3">
						<label for="depenseMontant" class="form-label">Montant prévu *</label>
						<div class="input-group">
							<input type="number" class="form-control" id="depenseMontant" min="0" step="1000" required>
							<span class="input-group-text">FCFA</span>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
				<button type="button" class="btn btn-success" onclick="addDepense()">
					<i class="fa fa-plus"></i> Ajouter
				</button>
			</div>
		</div>
	</div>
</div>


{% endblock %}

{% block stylesheets %}
<style>
.step-indicator {
    font-size: 0.9rem;
    color: #6c757d;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 15px;
    transition: all 0.3s ease;
}

.step-indicator.active {
    background-color: #007bff;
    color: white;
}

.step-indicator.completed {
    background-color: #28a745;
    color: white;
}

.step-content {
    min-height: 400px;
}
</style>
{% endblock %}

{% block javascripts %}
<script>
let currentStep = 1;
let participantsData = {};
let depensesData = [];
let depenseAllocations = {};
let statutsParticipation = [];
let participantLookup = {};
let participantExpenseMap = {};
let participantsLoaded = false;
let depensesLoaded = false;

document.addEventListener('DOMContentLoaded', function() {
    // Charger d'abord les statuts, puis les participants
    loadStatutsParticipation().then(() => {
        loadParticipants();
        loadDepenses();
    });
});

function nextStep(step) {
    if (validateCurrentStep()) {
        // Masquer toutes les étapes
        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.add('d-none');
        });
        
        // Afficher l'étape demandée
        document.getElementById(`step${step}`).classList.remove('d-none');
        
        // Mettre à jour les indicateurs d'étapes
        document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
            indicator.classList.remove('active', 'completed');
            if (index + 1 < step) {
                indicator.classList.add('completed');
            } else if (index + 1 === step) {
                indicator.classList.add('active');
            }
        });
        
        updateProgressBar(step);
        currentStep = step;
        
        if (step === 4) {
            updateRecap();
        }
    }
}

function prevStep(step) {
    // Masquer toutes les étapes
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.add('d-none');
    });
    
    // Afficher l'étape demandée
    document.getElementById(`step${step}`).classList.remove('d-none');
    
    // Mettre à jour les indicateurs d'étapes
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        indicator.classList.remove('active', 'completed');
        if (index + 1 < step) {
            indicator.classList.add('completed');
        } else if (index + 1 === step) {
            indicator.classList.add('active');
        }
    });
    
    updateProgressBar(step);
    currentStep = step;
}

function updateProgressBar(step) {
    const progress = (step / 4) * 100;
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
    }
}

function validateCurrentStep() {
    if (currentStep === 1) {
        const dateDebut = document.getElementById('dateReelleDebut').value;
        const dateFin = document.getElementById('dateReelleFin').value;
        const lieu = document.getElementById('lieuReel').value;
        
        if (!dateDebut || !dateFin || !lieu) {
            showToast('Veuillez remplir tous les champs obligatoires', 'error');
            return false;
        }
        
        if (new Date(dateDebut) > new Date(dateFin)) {
            showToast('La date de début ne peut pas être postérieure à la date de fin', 'error');
            return false;
        }
    }
    
    return true;
}

function loadStatutsParticipation() {
    return fetch('/api/statuts-participation')
        .then(response => {
            console.log('Réponse API statuts:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Statuts de participation reçus:', data);
            statutsParticipation = data;
            return data; // Retourner les données pour la chaîne de Promises
        })
        .catch(error => {
            console.error('Erreur lors du chargement des statuts:', error);
            showToast('Erreur lors du chargement des statuts de participation', 'error');
            throw error; // Propager l'erreur
        });
}

function loadParticipants() {
    return fetch('{{ path('app_mission_realisation_participants', {'id': missionSession.id}) }}')
        .then(response => response.json())
        .then(data => {
            console.log('Données participants reçues:', data);
            participantsData = data;
            participantLookup = {};
            
            const tbody = document.querySelector('#participantsTable tbody');
            tbody.innerHTML = '';
            
            if (!data.prevus || !Array.isArray(data.prevus)) {
                console.error('data.prevus is not an array:', data.prevus);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erreur: Format de données invalide</td></tr>';
                return;
            }
            
            if (data.prevus.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Aucun participant prévu pour cette mission.</td></tr>';
            }
            
            data.prevus.forEach(participant => {
                const row = document.createElement('tr');
                row.setAttribute('data-participant-id', participant.id);
                
                const selectOptions = statutsParticipation
                    .filter(statut => statut.code === 'participe' || statut.code === 'absent')
                    .map(statut => 
                        `<option value="${statut.id}" ${participant.statut_participation_id == statut.id ? 'selected' : ''}>${statut.libelle}</option>`
                    ).join('');
                
                row.innerHTML = `
                    <td>${participant.nom}</td>
                    <td>${participant.prenom}</td>
                    <td>${participant.matricule || '-'}</td>
                    <td>
                        <select class="form-select form-select-sm" onchange="updateParticipantStatut(${participant.id}, this.value)">
                            <option value="">Choisir un statut</option>
                            ${selectOptions}
                        </select>
                    </td>
                    <td>
                        <span class="badge bg-${participant.statut_couleur || 'secondary'}">${participant.statut_libelle || 'Non défini'}</span>
                    </td>
                `;
                tbody.appendChild(row);

                const key = getAllocationKey(participant.id, participant.userId);
                participantLookup[key] = {
                    userMissionId: participant.id,
                    userId: participant.userId,
                    nom: participant.nom,
                    prenom: participant.prenom,
                    statut: participant.statut_libelle || 'Prévu'
                };
            });

            participantsLoaded = true;
            if (depensesLoaded) {
                renderParticipantExpensesUI();
            } else {
                const container = document.getElementById('participantExpensesContainer');
                if (container) {
                    container.innerHTML = '<div class="text-center text-muted"><i class="fa fa-spinner fa-spin me-2"></i>Chargement des dépenses...</div>';
                }
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des participants:', error);
            const tbody = document.querySelector('#participantsTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erreur lors du chargement des participants</td></tr>';
            showToast('Erreur lors du chargement des participants', 'error');
        });
}

function loadDepenses() {
    return fetch('{{ path('app_mission_realisation_depenses', {'id': missionSession.id}) }}')
        .then(response => response.json())
        .then(data => {
            depensesData = Array.isArray(data.depenses) ? data.depenses : [];
            depenseAllocations = {};

            depensesData.forEach(depense => {
                depenseAllocations[depense.id] = {};
                if (!Array.isArray(depense.allocations)) {
                    depense.allocations = [];
                }

                depense.allocations.forEach(allocation => {
                    const key = getAllocationKey(allocation.userMissionId, allocation.userId);
                    const montantPrevu = allocation.montantPrevu !== null && allocation.montantPrevu !== undefined
                        ? parseFloat(allocation.montantPrevu)
                        : null;
                    let montantReel = allocation.montantReel !== null && allocation.montantReel !== undefined
                        ? parseFloat(allocation.montantReel)
                        : null;

                    if ((montantReel === null || isNaN(montantReel)) && montantPrevu !== null) {
                        montantReel = montantPrevu;
                        allocation.montantReel = montantReel;
                    }

                    depenseAllocations[depense.id][key] = {
                        userMissionId: allocation.userMissionId || null,
                        userId: allocation.userId || null,
                        montantReel: montantReel,
                        montantPrevu: montantPrevu
                    };
                });

                const sommeReelle = depense.allocations.reduce((total, allocation) => {
                    return total + (allocation.montantReel ? parseFloat(allocation.montantReel) : 0);
                }, 0);

                depense.montantReel = sommeReelle;
                depense.ecart = sommeReelle - parseFloat(depense.montantPrevu || 0);
            });

            depensesLoaded = true;
            if (participantsLoaded) {
                renderParticipantExpensesUI();
            }
            recalculateTotaux();
        })
        .catch(error => {
            console.error('Erreur:', error);
            showToast('Erreur lors du chargement des dépenses', 'error');
        });
}

function updateTotaux(totaux) {
    document.getElementById('totalPrevu').textContent = numberFormat(totaux.totalPrevu) + ' FCFA';
    document.getElementById('totalReel').textContent = numberFormat(totaux.totalReel) + ' FCFA';
    
    const ecartClass = totaux.totalEcart > 0 ? 'text-danger' : totaux.totalEcart < 0 ? 'text-success' : 'text-muted';
    const ecartSign = totaux.totalEcart > 0 ? '+' : '';
    
    const totalEcartElement = document.getElementById('totalEcart');
    totalEcartElement.textContent = `${ecartSign}${numberFormat(totaux.totalEcart)} FCFA`;
    totalEcartElement.className = `${ecartClass} fw-bold`;
}

function recalculateTotaux() {
    let totalPrevu = 0;
    let totalReel = 0;
    
    depensesData.forEach(depense => {
        totalPrevu += parseFloat(depense.montantPrevu);
        totalReel += depense.montantReel ? parseFloat(depense.montantReel) : 0;
    });
    
    const totalEcart = totalReel - totalPrevu;
    
    updateTotaux({
        totalPrevu: totalPrevu,
        totalReel: totalReel,
        totalEcart: totalEcart
    });
}

function renderParticipantExpensesUI() {
    const container = document.getElementById('participantExpensesContainer');
    if (!container) {
        return;
    }

    if (!depensesLoaded) {
        container.innerHTML = '<div class="text-center text-muted"><i class="fa fa-spinner fa-spin me-2"></i>Chargement des dépenses...</div>';
        return;
    }

    const participants = Array.isArray(participantsData.prevus) ? participantsData.prevus : [];
    if (!participants.length) {
        container.innerHTML = '<div class="alert alert-warning mb-0">Aucun participant prévu pour cette mission.</div>';
        return;
    }

    if (!depensesData.length) {
        container.innerHTML = '<div class="alert alert-info mb-0">Aucune catégorie de dépense n\'a été définie pour cette mission.</div>';
        return;
    }

    participantExpenseMap = {};
    container.innerHTML = participants.map(participant => renderParticipantExpenseCard(participant)).join('');
    participants.forEach(participant => updateParticipantCardTotals(participant.id));
}

function renderParticipantExpenseCard(participant) {
    const allocations = depensesData
        .map(depense => {
            const allocation = Array.isArray(depense.allocations)
                ? depense.allocations.find(a => a.userMissionId === participant.id)
                : null;

            if (!allocation) {
                return null;
            }

            const montantPrevu = allocation.montantPrevu !== null && allocation.montantPrevu !== undefined
                ? parseFloat(allocation.montantPrevu)
                : 0;

            let montantReel = allocation.montantReel !== null && allocation.montantReel !== undefined
                ? parseFloat(allocation.montantReel)
                : null;

            if ((montantReel === null || isNaN(montantReel)) && montantPrevu) {
                montantReel = montantPrevu;
                allocation.montantReel = montantReel;
                const key = getAllocationKey(allocation.userMissionId, allocation.userId);
                if (!depenseAllocations[depense.id]) {
                    depenseAllocations[depense.id] = {};
                }
                if (!depenseAllocations[depense.id][key]) {
                    depenseAllocations[depense.id][key] = {
                        userMissionId: allocation.userMissionId || null,
                        userId: allocation.userId || null,
                        montantPrevu: montantPrevu,
                        montantReel: montantReel
                    };
                } else {
                    depenseAllocations[depense.id][key].montantReel = montantReel;
                }
            }

            return {
                depenseId: depense.id,
                categorie: depense.categorie,
                montantPrevu,
                montantReel,
                allocation: allocation
            };
        })
        .filter(Boolean);

    participantExpenseMap[participant.id] = allocations;

    const rows = allocations.length
        ? allocations.map(alloc => `
        <tr>
            <td>${alloc.categorie}</td>
            <td>${alloc.montantPrevu ? numberFormat(alloc.montantPrevu) + ' FCFA' : '-'}</td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="number"
                           class="form-control text-end"
                           value="${alloc.montantReel ?? (alloc.montantPrevu || '')}"
                           min="0" step="1000"
                           data-user-mission-id="${participant.id}"
                           data-depense-id="${alloc.depenseId}"
                           data-montant-prevu="${alloc.montantPrevu || 0}"
                           oninput="handleParticipantExpenseChange(this)">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            title="Copier le montant prévu"
                            onclick="copyPlannedToReal(this)">
                        <i class="fa fa-arrow-right"></i>
                    </button>
                    <span class="input-group-text">FCFA</span>
                </div>
            </td>
        </tr>
    `).join('')
        : `<tr><td colspan="3" class="text-muted">Aucune dépense planifiée pour ce participant.</td></tr>`;

    const totalPrevu = allocations.reduce((sum, alloc) => sum + (parseFloat(alloc.montantPrevu) || 0), 0);
    const totalReel = allocations.reduce((sum, alloc) => sum + (parseFloat(alloc.montantReel) || 0), 0);
    const totalEcart = totalReel - totalPrevu;
    const ecartClass = totalEcart > 0 ? 'text-danger' : (totalEcart < 0 ? 'text-success' : 'text-muted');
    const ecartSign = totalEcart > 0 ? '+' : '';

    const badge = participant.statut_couleur
        ? `<span class="badge bg-${participant.statut_couleur} ms-2">${participant.statut_libelle || 'Non défini'}</span>`
        : '';

    return `
    <div class="card mb-3" data-participant-id="${participant.id}">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
            <div>
                <h6 class="mb-0">${participant.nom} ${participant.prenom} ${badge}</h6>
                <small class="text-muted">${participant.email || ''}</small>
            </div>
            <div class="text-end">
                <div class="small text-muted">Prévu</div>
                <div class="participant-total-prevu fw-bold">${numberFormat(totalPrevu)} FCFA</div>
                <div class="small text-muted mt-2">Réel</div>
                <div class="participant-total-reel fw-bold text-primary">${numberFormat(totalReel)} FCFA</div>
                <div class="small participant-total-ecart ${ecartClass} mt-1">${ecartSign}${numberFormat(totalEcart)} FCFA</div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Catégorie</th>
                            <th>Montant prévu</th>
                            <th>Montant réel</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            </div>
        </div>
    </div>`;
}

function copyPlannedToReal(button) {
    const group = button.closest('.input-group');
    if (!group) {
        return;
    }

    const input = group.querySelector('input[type="number"]');
    if (!input) {
        return;
    }

    const plannedValue = input.dataset.montantPrevu ? parseFloat(input.dataset.montantPrevu) : 0;
    input.value = plannedValue || '';
    input.dispatchEvent(new Event('input', { bubbles: true }));
}

function handleParticipantExpenseChange(input) {
    const userMissionId = parseInt(input.dataset.userMissionId, 10);
    const depenseId = parseInt(input.dataset.depenseId, 10);
    const montant = input.value ? parseFloat(input.value) : 0;

    const allocations = participantExpenseMap[userMissionId] || [];
    const allocationEntry = allocations.find(a => a.depenseId === depenseId);
    if (allocationEntry) {
        allocationEntry.montantReel = montant;
    }

    const depense = depensesData.find(d => d.id === depenseId);
    if (depense) {
        let allocation = depense.allocations.find(a => a.userMissionId === userMissionId);
        if (!allocation) {
            allocation = {
                userMissionId,
                userId: null,
                montantPrevu: allocationEntry ? allocationEntry.montantPrevu : null,
                montantReel: montant
            };
            depense.allocations.push(allocation);
        } else {
            allocation.montantReel = montant;
        }

        if (!depenseAllocations[depenseId]) {
            depenseAllocations[depenseId] = {};
        }
        const key = getAllocationKey(userMissionId, allocation.userId || null);
        depenseAllocations[depenseId][key] = {
            userMissionId,
            userId: allocation.userId || null,
            montantReel: montant,
            montantPrevu: allocation.montantPrevu || null
        };

        depense.montantReel = depense.allocations.reduce((sum, a) => sum + (parseFloat(a.montantReel) || 0), 0);
        depense.ecart = depense.montantReel - parseFloat(depense.montantPrevu || 0);
    }

    updateParticipantCardTotals(userMissionId);
    recalculateTotaux();
}

function updateParticipantCardTotals(userMissionId) {
    const allocations = participantExpenseMap[userMissionId] || [];
    const totalPrevu = allocations.reduce((sum, alloc) => sum + (parseFloat(alloc.montantPrevu) || 0), 0);
    const totalReel = allocations.reduce((sum, alloc) => sum + (parseFloat(alloc.montantReel) || 0), 0);
    const ecart = totalReel - totalPrevu;

    const card = document.querySelector(`[data-participant-id="${userMissionId}"]`);
    if (!card) return;

    const prevuEl = card.querySelector('.participant-total-prevu');
    const reelEl = card.querySelector('.participant-total-reel');
    const ecartEl = card.querySelector('.participant-total-ecart');

    if (prevuEl) {
        prevuEl.textContent = numberFormat(totalPrevu) + ' FCFA';
    }
    if (reelEl) {
        reelEl.textContent = numberFormat(totalReel) + ' FCFA';
    }
    if (ecartEl) {
        const ecartClass = ecart > 0 ? 'text-danger' : ecart < 0 ? 'text-success' : 'text-muted';
        const ecartSign = ecart > 0 ? '+' : '';
        ecartEl.className = `participant-total-ecart ${ecartClass}`;
        ecartEl.textContent = `${ecartSign}${numberFormat(ecart)} FCFA`;
    }
}

function numberFormat(number) {
    return new Intl.NumberFormat('fr-FR').format(number);
}

function getAllocationKey(userMissionId, userId) {
    if (userMissionId) {
        return `um_${userMissionId}`;
    }
    if (userId) {
        return `user_${userId}`;
    }
    return `tmp_${Date.now()}_${Math.random().toString(16).slice(2)}`;
}

function getAllocationMap(depenseId) {
    if (!depenseAllocations[depenseId]) {
        depenseAllocations[depenseId] = {};
    }
    return depenseAllocations[depenseId];
}

function getAllocationTotals(depenseId) {
    const allocationMap = depenseAllocations[depenseId] || {};
    let total = 0;
    let count = 0;

    Object.values(allocationMap).forEach(allocation => {
        if (allocation.montantReel) {
            total += parseFloat(allocation.montantReel);
            count++;
        }
    });

    return { total, count };
}

function getAllocationPayload(depenseId) {
    const allocationMap = depenseAllocations[depenseId] || {};
    return Object.values(allocationMap)
        .filter(allocation => allocation.montantReel && parseFloat(allocation.montantReel) > 0)
        .map(allocation => ({
            userMissionId: allocation.userMissionId,
            userId: allocation.userId,
            montant: parseFloat(allocation.montantReel)
        }));
}

function findAllocationMismatch() {
    if (!Array.isArray(depensesData)) {
        return null;
    }

    for (const depense of depensesData) {
        if (!depense.montantReel || parseFloat(depense.montantReel) === 0) {
            continue;
        }

        const totals = getAllocationTotals(depense.id);
        if (totals.count === 0) {
            return `La dépense « ${depense.categorie} » possède un montant réel mais aucune répartition n'est renseignée.`;
        }

        if (Math.abs(totals.total - parseFloat(depense.montantReel)) > 0.5) {
            return `La répartition de la dépense « ${depense.categorie} » ne correspond pas au montant réel saisi.`;
        }
    }

    return null;
}

function updateParticipantStatut(userMissionId, statutId) {
    // Mettre à jour le statut dans les données
    const participant = participantsData.prevus.find(p => p.id === userMissionId);
    if (participant) {
        const statut = statutsParticipation.find(s => s.id == statutId);
        if (statut) {
            participant.statut_participation_id = statutId;
            participant.statut_libelle = statut.libelle;
            participant.statut_couleur = statut.couleur;
            
            // Mettre à jour l'affichage du badge
            const row = document.querySelector(`tr[data-participant-id="${userMissionId}"]`);
            if (row) {
                const badge = row.querySelector('.badge');
                if (badge) {
                    badge.className = `badge bg-${statut.couleur}`;
                    badge.textContent = statut.libelle;
                }
            }
        }
    }
}


function removeAllocationsForParticipant(userMissionId, userId) {
    const key = getAllocationKey(userMissionId, userId);
    Object.keys(depenseAllocations).forEach(depenseId => {
        if (depenseAllocations[depenseId] && depenseAllocations[depenseId][key]) {
            delete depenseAllocations[depenseId][key];
        }
    });
    renderParticipantExpensesUI();
    recalculateTotaux();
}

function updateRecap() {
    // Informations de base
    const dateDebut = document.getElementById('dateReelleDebut').value;
    const dateFin = document.getElementById('dateReelleFin').value;
    const lieu = document.getElementById('lieuReel').value;
    
    document.getElementById('recapDateDebut').textContent = dateDebut || 'Non renseigné';
    document.getElementById('recapDateFin').textContent = dateFin || 'Non renseigné';
    document.getElementById('recapLieu').textContent = lieu || 'Non renseigné';
    
    // Calculer la durée réelle
    if (dateDebut && dateFin) {
        const debut = new Date(dateDebut);
        const fin = new Date(dateFin);
        const diffTime = Math.abs(fin - debut);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 pour inclure le jour de fin
        document.getElementById('recapDureeReelle').textContent = diffDays + ' jour(s)';
    } else {
        document.getElementById('recapDureeReelle').textContent = 'Non calculable';
    }
    
    // Participants
    const participantsPrevus = participantsData.prevus ? participantsData.prevus.length : 0;
    const totalParticipants = participantsPrevus;
    
    // Compter les participants présents (statut "participe")
    let participantsPresents = 0;
    if (participantsData.prevus) {
        participantsPresents = participantsData.prevus.filter(p => {
            const statut = statutsParticipation.find(s => s.id == p.statut_participation_id);
            return statut && statut.code === 'participe';
        }).length;
    }
    
    document.getElementById('recapParticipantsPrevus').textContent = participantsPrevus;
    document.getElementById('recapTotalParticipants').textContent = totalParticipants;
    document.getElementById('recapParticipantsPresents').textContent = participantsPresents;
    
    // Dépenses
    let totalPrevu = 0;
    let totalReel = 0;
    let nombreDepenses = 0;
    
    if (Array.isArray(depensesData)) {
        depensesData.forEach(depense => {
            totalPrevu += parseFloat(depense.montantPrevu) || 0;
            totalReel += parseFloat(depense.montantReel) || 0;
            if (depense.montantReel) {
                nombreDepenses++;
            }
        });
    }
    
    const ecart = totalReel - totalPrevu;
    const ecartClass = ecart > 0 ? 'text-danger' : ecart < 0 ? 'text-success' : 'text-muted';
    const ecartSign = ecart > 0 ? '+' : '';
    
    document.getElementById('recapBudgetPrevu').textContent = numberFormat(totalPrevu) + ' FCFA';
    document.getElementById('recapDepensesReelles').textContent = numberFormat(totalReel) + ' FCFA';
    
    const ecartElement = document.getElementById('recapEcartBudget');
    ecartElement.textContent = `${ecartSign}${numberFormat(ecart)} FCFA`;
    ecartElement.className = ecartClass;
    
    document.getElementById('recapNombreDepenses').textContent = nombreDepenses + ' dépense(s) renseignée(s)';
}

function validerRealisation() {
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Validation en cours...';
    
    // Validation des champs requis
    const dateReelleDebut = document.getElementById('dateReelleDebut').value;
    const dateReelleFin = document.getElementById('dateReelleFin').value;
    const lieuReel = document.getElementById('lieuReel').value;
    
    if (!dateReelleDebut || !dateReelleFin || !lieuReel) {
        showToast('Veuillez remplir tous les champs obligatoires', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
    }

    const allocationIssue = findAllocationMismatch();
    if (allocationIssue) {
        showToast(allocationIssue, 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
    }
    
    const data = {
        dateReelleDebut: dateReelleDebut,
        dateReelleFin: dateReelleFin,
        lieuReel: lieuReel,
        participants: (Array.isArray(participantsData.prevus) ? participantsData.prevus : []).map(p => ({
            userMissionId: p.id,
            statut_participation_id: p.statut_participation_id
        })),
        depensesReelles: (Array.isArray(depensesData) ? depensesData : [])
            .filter(d => d.montantReel)
            .map(d => {
                const payload = {
                    categorieId: d.categorieId,
                    montant: parseFloat(d.montantReel),
                    montantPrevu: d.montantPrevu ? parseFloat(d.montantPrevu) : parseFloat(d.montantReel)
                };

                const allocationsPayload = getAllocationPayload(d.id);
                if (allocationsPayload.length > 0) {
                    payload.allocations = allocationsPayload;
                }

                return payload;
            })
    };
    
    console.log('Données envoyées pour validation:', data);
    
    fetch('{{ path('app_mission_realisation_complete', {'id': missionSession.id}) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('Réponse du serveur:', response.status);
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Données reçues:', data);
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => {
                window.location.href = '{{ path('app_mission_show', {'id': missionSession.id}) }}';
            }, 2000);
        } else {
            showToast(data.message || 'Erreur lors de la validation', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur détaillée:', error);
        showToast('Erreur lors de la validation: ' + error.message, 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Variables globales pour les catégories de dépenses
let categoriesDepenses = [];
let participantDepensesRows = 0;


function showAddDepenseModal() {
    // Charger les catégories de dépenses si pas encore fait
    if (categoriesDepenses.length === 0) {
        loadCategoriesDepenses();
    }
    
    // Réinitialiser le formulaire
    document.getElementById('addDepenseForm').reset();
    
    // Afficher le modal
    const modal = new bootstrap.Modal(document.getElementById('addDepenseModal'));
    modal.show();
}

function loadCategoriesDepenses() {
    return fetch('/api/categories-depenses')
        .then(response => response.json())
        .then(data => {
            categoriesDepenses = data;
            const select = document.getElementById('depenseCategorie');
            if (select) {
                select.innerHTML = '<option value="">Sélectionner une catégorie...</option>';
                data.forEach(categorie => {
                    const option = document.createElement('option');
                    option.value = categorie.id;
                    option.textContent = categorie.libelle;
                    select.appendChild(option);
                });
            }
            return data;
        })
        .catch(error => {
            console.error('Erreur lors du chargement des catégories:', error);
            showToast('Erreur lors du chargement des catégories', 'error');
            throw error;
        });
}

function addDepense() {
    const categorieId = document.getElementById('depenseCategorie').value;
    const montant = document.getElementById('depenseMontant').value;
    
    if (!categorieId || !montant) {
        showToast('Veuillez remplir tous les champs', 'error');
        return;
    }
    
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Ajout...';
    
    const data = {
        categorieId: parseInt(categorieId),
        montant: parseFloat(montant)
    };
    
    fetch("{{ path('app_mission_add_depense', {'id': missionSession.id}) }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            
            // Fermer le modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDepenseModal'));
            modal.hide();
            
            // Recharger les dépenses avec les nouveaux totaux
            loadDepenses();
        } else {
            showToast(data.message || 'Erreur lors de l\'ajout', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showToast('Erreur lors de l\'ajout de la dépense', 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}



</script>
{% endblock %}
