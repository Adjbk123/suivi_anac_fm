{% extends 'base.html.twig' %}

{% set session = formationSession %}

{% block title %}Modifier la Formation{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
	<li class="breadcrumb-item"><a href="{{ path('app_formation_index') }}">FORMATIONS</a></li>
	<li class="breadcrumb-item"><a href="{{ path('app_formation_show', {'id': session.id}) }}">DÉTAIL</a></li>
	<li class="breadcrumb-item active">MODIFIER</li>
</ul>
{% endblock %}

{% block page_title %}
<h1 class="page-header">
	Modifier la Formation <small>{{ formation.titre }}</small>
</h1>
{% endblock %}

{% block buttons %}
<div class="d-flex gap-2">
	<a href="{{ path('app_formation_show', {'id': session.id}) }}" class="btn btn-secondary btn-sm">
		<i class="fa fa-arrow-left"></i> Retour
	</a>
</div>
{% endblock %}

{% block body %}
<div class="row">
	<div class="col-xl-12">
		<div class="card">
			<div class="card-body">
				<form id="formationEditForm">
					<!-- Informations générales -->
					<div class="mb-4">
						<h4 class="mb-3"><i class="fa fa-info-circle text-primary"></i> Informations générales</h4>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="formationId" class="form-label">Modèle de formation *</label>
									<select class="form-select" id="formationId" name="formationId" required>
										<option value="">Sélectionner un modèle</option>
										<option value="{{ formation.id }}" selected>{{ formation.titre }}</option>
									</select>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="directionId" class="form-label">Direction responsable *</label>
									<select class="form-select" id="directionId" name="directionId" required>
										<option value="">Choisir une direction</option>
									</select>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="fondsId" class="form-label">Fonds *</label>
									<select class="form-select" id="fondsId" name="fondsId" required>
										<option value="">Choisir le type de fonds</option>
									</select>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="lieuPrevu" class="form-label">Lieu prévu *</label>
									<input type="text" class="form-control" id="lieuPrevu" name="lieuPrevu" required value="{{ session.lieuPrevu }}" placeholder="Ex: Salle Conférence">
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="datePrevueDebut" class="form-label">Date de début *</label>
									<input type="date" class="form-control" id="datePrevueDebut" name="datePrevueDebut" required value="{{ session.datePrevueDebut ? session.datePrevueDebut|date('Y-m-d') : '' }}">
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="datePrevueFin" class="form-label">Date de fin *</label>
									<input type="date" class="form-control" id="datePrevueFin" name="datePrevueFin" required value="{{ session.datePrevueFin ? session.datePrevueFin|date('Y-m-d') : '' }}">
								</div>
							</div>
						</div>

						<input type="hidden" id="dureePrevue" name="dureePrevu" value="{{ session.dureePrevue }}">
						<input type="hidden" id="budgetPrevu" name="budgetPrevu" value="{{ session.budgetPrevu }}">

						<div class="mb-3">
							<label for="description" class="form-label">Description</label>
							<textarea class="form-control" id="description" name="description" rows="4" placeholder="Détails de la formation...">{{ formation.description }}</textarea>
						</div>

						<div class="mb-3">
							<label for="statutActivite" class="form-label">Statut</label>
							<select class="form-select" id="statutActivite" name="statutActivite">
								<option value="">Choisir un statut</option>
							</select>
						</div>
					</div>

					<!-- Boutons -->
					<div class="d-flex justify-content-end gap-2">
						<a href="{{ path('app_formation_show', {'id': session.id}) }}" class="btn btn-secondary">
							<i class="fa fa-times"></i> Annuler
						</a>
						<button type="submit" class="btn btn-primary">
							<i class="fa fa-save"></i> Enregistrer
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block javascripts %}
<script>
// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
	loadFormations();
    loadDirections();
    loadFonds();
    loadStatutsActivite();
    setupEventListeners();
    calculateDuration();
});

function loadFormations() {
    fetch('/api/formations')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('formationId');
            if (!select) {
                return;
            }
            select.innerHTML = '<option value=\"\">Sélectionner un modèle</option>';

            const currentId = {{ formation.id }};
            const currentTitle = '{{ formation.titre|e('js') }}';
            const currentItem = data.find(item => item.id == currentId);

            if (currentItem) {
                select.innerHTML += `<option value=\"${currentItem.id}\" selected>${currentItem.titre}</option>`;
            } else {
                select.innerHTML += `<option value=\"${currentId}\" selected>${currentTitle}</option>`;
            }

            data
                .filter(item => item.id != currentId)
                .forEach(item => {
                    select.innerHTML += `<option value=\"${item.id}\">${item.titre}</option>`;
                });
        })
        .catch(error => console.error('Erreur lors du chargement des modèles :', error));
}

// Charger les directions
function loadDirections() {
    fetch('/api/directions')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('directionId');
            select.innerHTML = '<option value="">Choisir une direction</option>';
            data.forEach(direction => {
                const selected = direction.id == {{ session.direction ? session.direction.id : 'null' }} ? 'selected' : '';
                select.innerHTML += `<option value="${direction.id}" ${selected}>${direction.libelle}</option>`;
            });
        })
        .catch(error => console.error('Erreur:', error));
}

// Charger les types de fonds
function loadFonds() {
    fetch('/api/fonds')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('fondsId');
            select.innerHTML = '<option value="">Choisir le type de fonds</option>';
            data.forEach(fond => {
                const selected = fond.id == {{ session.fonds ? session.fonds.id : 'null' }} ? 'selected' : '';
                select.innerHTML += `<option value="${fond.id}" ${selected}>${fond.libelle}</option>`;
            });
        })
        .catch(error => console.error('Erreur:', error));
}

// Charger les statuts d'activité
function loadStatutsActivite() {
    fetch('/api/statuts-activite')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('statutActivite');
            select.innerHTML = '<option value="">Choisir un statut</option>';
            data.forEach(statut => {
                const selected = statut.id == {{ session.statutActivite ? session.statutActivite.id : 'null' }} ? 'selected' : '';
                select.innerHTML += `<option value="${statut.id}" ${selected}>${statut.libelle}</option>`;
            });
        })
        .catch(error => console.error('Erreur:', error));
}

// Configuration des événements
function setupEventListeners() {
    // Calcul automatique de la durée
    document.getElementById('datePrevueDebut').addEventListener('change', calculateDuration);
    document.getElementById('datePrevueFin').addEventListener('change', calculateDuration);
}

// Calculer la durée automatiquement
function calculateDuration() {
    const debut = document.getElementById('datePrevueDebut').value;
    const fin = document.getElementById('datePrevueFin').value;
    
    if (debut && fin) {
        const dateDebut = new Date(debut);
        const dateFin = new Date(fin);
        const diffTime = Math.abs(dateFin - dateDebut);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        document.getElementById('dureePrevue').value = diffDays;
    } else {
        document.getElementById('dureePrevue').value = '';
    }
}

// Gestion de la soumission du formulaire
document.getElementById('formationEditForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Désactiver le bouton et afficher le spinner
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Enregistrement...';
    
    // Préparer les données
    const formData = {
        formationId: document.getElementById('formationId').value,
        directionId: document.getElementById('directionId').value,
        fondsId: document.getElementById('fondsId').value,
        lieuPrevu: document.getElementById('lieuPrevu').value,
        datePrevueDebut: document.getElementById('datePrevueDebut').value,
        datePrevueFin: document.getElementById('datePrevueFin').value,
        dureePrevue: document.getElementById('dureePrevue').value,
        budgetPrevu: document.getElementById('budgetPrevu').value,
        description: document.getElementById('description').value,
        statutActiviteId: document.getElementById('statutActivite').value
    };
    
    // Envoyer les données
    fetch('{{ path('app_formation_update', {'id': session.id}) }}', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => {
                window.location.href = '{{ path('app_formation_show', {'id': formation.id}) }}';
            }, 1500);
        } else {
            showToast(data.message || 'Erreur lors de la modification', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showToast('Erreur lors de la modification de la formation', 'error');
    })
    .finally(() => {
        // Réactiver le bouton
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});
</script>
{% endblock %}
