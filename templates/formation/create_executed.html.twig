{% extends 'base.html.twig' %}

{% block title %}Créer une Formation Exécutée (Non Prévue){% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
	<li class="breadcrumb-item"><a href="{{ path('app_formation_index') }}">FORMATIONS</a></li>
	<li class="breadcrumb-item active">FORMATION EXÉCUTÉE (NON PRÉVUE)</li>
</ul>
{% endblock %}

{% block page_title %}
<h1 class="page-header">
	Créer une Formation Exécutée <small>Non prévue mais déjà réalisée</small>
</h1>
{% endblock %}

{% block buttons %}
<div class="d-flex gap-2">
	<a href="{{ path('app_formation_index') }}" class="btn btn-secondary btn-sm">
		<i class="fa fa-arrow-left"></i> Retour
	</a>
</div>
{% endblock %}

{% block body %}
<div class="row">
	<div class="col-xl-12">
		<div class="card">
			<div class="card-body">
				<div class="alert alert-success d-flex align-items-center gap-2 mb-4" role="alert">
					<i class="fa fa-info-circle"></i>
					<div>
						<strong>Formation non prévue mais déjà exécutée :</strong> Utilisez ce formulaire pour enregistrer une formation qui n'était pas prévue dans le planning mais qui a déjà eu lieu. 
						Vous devrez renseigner les dates réelles, les participants et les dépenses réelles.
					</div>
				</div>

				<form id="formationExecutedForm" novalidate>
					<input type="hidden" id="formationId" name="formationId">
					
					<!-- Informations générales -->
					<div class="mb-4">
						<h5 class="mb-3"><i class="fa fa-info-circle text-primary"></i> Informations générales</h5>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="formationModeleId" class="form-label">Formation concernée <span class="text-danger">*</span></label>
									<select class="form-select" id="formationModeleId" required>
										<option value="">Sélectionner une formation</option>
									</select>
									<div class="form-text text-muted">Sélectionnez une formation modèle existante</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="directionId" class="form-label">Direction responsable <span class="text-danger">*</span></label>
									<select class="form-select" id="directionId" required>
										<option value="">Choisir une direction</option>
									</select>
								</div>
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="fondsId" class="form-label">Type de fonds <span class="text-danger">*</span></label>
									<select class="form-select" id="fondsId" required>
										<option value="">Choisir le type de fonds</option>
									</select>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="lieuReel" class="form-label">Lieu réel <span class="text-danger">*</span></label>
									<input type="text" class="form-control" id="lieuReel" required>
								</div>
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="dateReelleDebut" class="form-label">Date réelle de début <span class="text-danger">*</span></label>
									<input type="date" class="form-control" id="dateReelleDebut" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="dateReelleFin" class="form-label">Date réelle de fin <span class="text-danger">*</span></label>
									<input type="date" class="form-control" id="dateReelleFin" required>
								</div>
							</div>
						</div>
						
						<div class="mb-3">
							<label for="notes" class="form-label">Notes</label>
							<textarea class="form-control" id="notes" rows="3"></textarea>
						</div>
					</div>
					
					<hr>
					
					<!-- Participants -->
					<div class="mb-4">
						<h5 class="mb-3"><i class="fa fa-users text-primary"></i> Participants</h5>
						<div class="mb-3">
							<label for="participantsSelect" class="form-label">Participants <span class="text-danger">*</span></label>
							<select class="form-select" id="participantsSelect" multiple size="8" required>
								<option value="">Chargement...</option>
							</select>
							<div class="form-text text-muted">Maintenez Ctrl (Windows) ou Cmd (Mac) pour sélectionner plusieurs participants</div>
						</div>
						<div id="selectedParticipantsList" class="mb-3">
							<!-- Liste des participants sélectionnés -->
						</div>
					</div>
					
					<hr>
					
					<!-- Dépenses réelles -->
					<div class="mb-4">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<h5 class="mb-0"><i class="fa fa-money-bill text-primary"></i> Dépenses réelles</h5>
							<button type="button" class="btn btn-success btn-sm" onclick="addDepenseRow()">
								<i class="fa fa-plus"></i> Ajouter une dépense
							</button>
						</div>
						<div id="depensesList">
							<!-- Les dépenses seront ajoutées dynamiquement -->
						</div>
					</div>
					
					<div class="d-flex justify-content-end gap-2">
						<a href="{{ path('app_formation_index') }}" class="btn btn-secondary">Annuler</a>
						<button type="button" class="btn btn-success" onclick="submitForm()">
							<i class="fa fa-check"></i> Créer la formation exécutée
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block javascripts %}
<script>
let formationModeles = [];
let directions = [];
let fonds = [];
let categoriesDepenses = [];
let users = [];
let depensesRows = 0;

document.addEventListener('DOMContentLoaded', function() {
	Promise.all([
		loadFormationModeles(),
		loadDirections(),
		loadFonds(),
		loadCategoriesDepenses(),
		loadUsers()
	]).then(() => {
		populateSelects();
	}).catch(error => {
		console.error('Erreur lors du chargement:', error);
		showToast('Erreur lors du chargement des données', 'error');
	});
});

function loadFormationModeles() {
	return fetch('/api/formations')
		.then(response => response.json())
		.then(data => {
			formationModeles = data || [];
		});
}

function loadDirections() {
	return fetch('/api/directions')
		.then(response => response.json())
		.then(data => {
			directions = data || [];
		});
}

function loadFonds() {
	return fetch('/api/fonds')
		.then(response => response.json())
		.then(data => {
			fonds = data || [];
		});
}

function loadCategoriesDepenses() {
	return fetch('/api/categories-depenses')
		.then(response => response.json())
		.then(data => {
			categoriesDepenses = data || [];
		});
}

function loadUsers() {
	return fetch('/api/users')
		.then(response => response.json())
		.then(data => {
			users = data || [];
		});
}

function populateSelects() {
	const formationSelect = document.getElementById('formationModeleId');
	formationSelect.innerHTML = '<option value="">Sélectionner une formation</option>';
	formationModeles.forEach(formation => {
		const option = document.createElement('option');
		option.value = formation.id;
		option.textContent = formation.titre;
		formationSelect.appendChild(option);
	});
	
	const directionSelect = document.getElementById('directionId');
	directionSelect.innerHTML = '<option value="">Choisir une direction</option>';
	directions.forEach(direction => {
		const option = document.createElement('option');
		option.value = direction.id;
		option.textContent = direction.libelle;
		directionSelect.appendChild(option);
	});
	
	const fondsSelect = document.getElementById('fondsId');
	fondsSelect.innerHTML = '<option value="">Choisir le type de fonds</option>';
	fonds.forEach(fond => {
		const option = document.createElement('option');
		option.value = fond.id;
		option.textContent = fond.libelle;
		fondsSelect.appendChild(option);
	});
	
	const participantsSelect = document.getElementById('participantsSelect');
	participantsSelect.innerHTML = '';
	users.forEach(user => {
		const option = document.createElement('option');
		option.value = user.id;
		option.textContent = `${user.nom} ${user.prenom} (${user.matricule || 'N/A'})`;
		participantsSelect.appendChild(option);
	});
	
	participantsSelect.addEventListener('change', updateSelectedParticipantsList);
}

function updateSelectedParticipantsList() {
	const select = document.getElementById('participantsSelect');
	const selected = Array.from(select.selectedOptions).map(opt => opt.value);
	const container = document.getElementById('selectedParticipantsList');
	
	if (selected.length === 0) {
		container.innerHTML = '';
		return;
	}
	
	container.innerHTML = '<div class="d-flex flex-wrap gap-2"><strong>Participants sélectionnés :</strong> ' +
		selected.map(userId => {
			const user = users.find(u => u.id == userId);
			return user ? `<span class="badge bg-primary">${user.nom} ${user.prenom}</span>` : '';
		}).filter(Boolean).join(' ') + '</div>';
}

function addDepenseRow() {
	const container = document.getElementById('depensesList');
	const rowId = 'depenseRow_' + depensesRows++;
	
	const row = document.createElement('div');
	row.className = 'card mb-3';
	row.id = rowId;
	row.innerHTML = `
		<div class="card-body">
			<div class="row align-items-end">
				<div class="col-md-5">
					<label class="form-label">Catégorie de dépense *</label>
					<select class="form-select depense-categorie" required>
						<option value="">Sélectionner...</option>
						${categoriesDepenses.map(cat => `<option value="${cat.id}">${cat.libelle}</option>`).join('')}
					</select>
				</div>
				<div class="col-md-4">
					<label class="form-label">Montant réel *</label>
					<div class="input-group">
						<input type="number" class="form-control depense-montant" min="0" step="1000" required>
						<span class="input-group-text">FCFA</span>
					</div>
				</div>
				<div class="col-md-3">
					<button type="button" class="btn btn-danger btn-sm w-100" onclick="removeDepenseRow('${rowId}')">
						<i class="fa fa-times"></i> Supprimer
					</button>
				</div>
			</div>
			<div class="row mt-3">
				<div class="col-12">
					<label class="form-label">Répartition par participant</label>
					<div class="table-responsive">
						<table class="table table-sm table-bordered">
							<thead>
								<tr>
									<th>Participant</th>
									<th>Montant</th>
								</tr>
							</thead>
							<tbody id="depenseAllocations_${rowId}">
								<!-- Les allocations seront ajoutées dynamiquement -->
							</tbody>
						</table>
						<button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addAllocationRow('${rowId}')">
							<i class="fa fa-plus"></i> Ajouter une répartition
						</button>
					</div>
				</div>
			</div>
		</div>
	`;
	container.appendChild(row);
}

function addAllocationRow(depenseRowId) {
	const container = document.getElementById('depenseAllocations_' + depenseRowId);
	const participantsSelect = document.getElementById('participantsSelect');
	const selectedParticipants = Array.from(participantsSelect.selectedOptions).map(opt => ({
		id: opt.value,
		nom: opt.textContent.split('(')[0].trim()
	}));
	
	if (selectedParticipants.length === 0) {
		showToast('Veuillez d\'abord sélectionner des participants', 'warning');
		return;
	}
	
	const row = document.createElement('tr');
	const allocationId = 'allocation_' + Date.now() + '_' + Math.random();
	row.id = allocationId;
	
	let optionsHtml = '<option value="">Sélectionner...</option>';
	selectedParticipants.forEach(participant => {
		optionsHtml += `<option value="${participant.id}">${participant.nom}</option>`;
	});
	
	row.innerHTML = `
		<td>
			<select class="form-select form-select-sm allocation-participant" required>
				${optionsHtml}
			</select>
		</td>
		<td>
			<div class="input-group input-group-sm">
				<input type="number" class="form-control allocation-montant" min="0" step="1000" required>
				<span class="input-group-text">FCFA</span>
			</div>
		</td>
		<td>
			<button type="button" class="btn btn-danger btn-sm" onclick="removeAllocationRow('${allocationId}')">
				<i class="fa fa-times"></i>
			</button>
		</td>
	`;
	container.appendChild(row);
}

function removeAllocationRow(allocationId) {
	const row = document.getElementById(allocationId);
	if (row) {
		row.remove();
	}
}

function removeDepenseRow(rowId) {
	const row = document.getElementById(rowId);
	if (row) {
		row.remove();
	}
}

function submitForm() {
	const form = document.getElementById('formationExecutedForm');
	if (!form.checkValidity()) {
		form.reportValidity();
		return;
	}
	
	const formationId = document.getElementById('formationModeleId').value;
	const formation = formationModeles.find(f => f.id == formationId);
	
	if (!formation) {
		showToast('Veuillez sélectionner une formation', 'error');
		return;
	}
	
	const directionId = document.getElementById('directionId').value;
	const fondsId = document.getElementById('fondsId').value;
	const lieuReel = document.getElementById('lieuReel').value;
	const dateReelleDebut = document.getElementById('dateReelleDebut').value;
	const dateReelleFin = document.getElementById('dateReelleFin').value;
	const notes = document.getElementById('notes').value;
	
	if (!dateReelleDebut || !dateReelleFin) {
		showToast('Veuillez renseigner les dates réelles', 'error');
		return;
	}
	
	if (new Date(dateReelleDebut) > new Date(dateReelleFin)) {
		showToast('La date de début ne peut pas être postérieure à la date de fin', 'error');
		return;
	}
	
	const participantsSelect = document.getElementById('participantsSelect');
	const participants = Array.from(participantsSelect.selectedOptions).map(opt => parseInt(opt.value));
	
	if (participants.length === 0) {
		showToast('Veuillez sélectionner au moins un participant', 'error');
		return;
	}
	
	// Récupérer les dépenses
	const depensesRows = document.querySelectorAll('#depensesList .card');
	const depensesReelles = [];
	
	for (const depenseRow of depensesRows) {
		const categorieId = depenseRow.querySelector('.depense-categorie').value;
		const montant = depenseRow.querySelector('.depense-montant').value;
		
		if (!categorieId || !montant) {
			continue;
		}
		
		const depense = {
			categorieId: parseInt(categorieId),
			montant: parseFloat(montant).toFixed(2),
			allocations: []
		};
		
		// Récupérer les allocations
		const allocationsTable = depenseRow.querySelector('tbody');
		if (allocationsTable) {
			const allocationRows = allocationsTable.querySelectorAll('tr');
			for (const allocationRow of allocationRows) {
				const participantId = allocationRow.querySelector('.allocation-participant').value;
				const allocationMontant = allocationRow.querySelector('.allocation-montant').value;
				
				if (participantId && allocationMontant) {
					depense.allocations.push({
						userId: parseInt(participantId),
						montant: parseFloat(allocationMontant).toFixed(2)
					});
				}
			}
		}
		
		depensesReelles.push(depense);
	}
	
	const formData = {
		formationId: formationId ? parseInt(formationId) : null,
		titre: formation.titre,
		directionId: parseInt(directionId),
		fondsId: parseInt(fondsId),
		lieuReel: lieuReel,
		dateReelleDebut: dateReelleDebut,
		dateReelleFin: dateReelleFin,
		notes: notes,
		participants: participants,
		depensesReelles: depensesReelles
	};
	
	const payload = new FormData();
	payload.append('data', JSON.stringify(formData));
	
	const submitBtn = event.target;
	const originalText = submitBtn.innerHTML;
	submitBtn.disabled = true;
	submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Création...';
	
	fetch('{{ path('app_formation_create_executed_post') }}', {
		method: 'POST',
		body: payload
	})
	.then(response => response.json())
	.then(data => {
		if (data.success) {
			showToast(data.message || 'Formation exécutée créée avec succès', 'success');
			setTimeout(() => {
				window.location.href = data.id ? "{{ path('app_formation_show', {'id': '__ID__'}) }}".replace('__ID__', data.id) : '{{ path('app_formation_index') }}';
			}, 1500);
		} else {
			showToast(data.message || 'Une erreur est survenue', 'error');
			submitBtn.disabled = false;
			submitBtn.innerHTML = originalText;
		}
	})
	.catch(error => {
		console.error('Erreur:', error);
		showToast('Erreur lors de la création', 'error');
		submitBtn.disabled = false;
		submitBtn.innerHTML = originalText;
	});
}

function showToast(message, type = 'info') {
	// Utiliser SweetAlert si disponible
	if (typeof Swal !== 'undefined') {
		Swal.fire({
			toast: true,
			position: 'top-end',
			showConfirmButton: false,
			timer: 3000,
			icon: type,
			title: message
		});
	} else {
		alert(message);
	}
}
</script>
{% endblock %}

