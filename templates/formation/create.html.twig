{% extends 'base.html.twig' %}

{% block title %}Créer une Formation{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
	<li class="breadcrumb-item"><a href="{{ path('app_formation_index') }}">FORMATIONS</a></li>
	<li class="breadcrumb-item active">NOUVELLE FORMATION</li>
</ul>
{% endblock %}

{% block page_title %}
<h1 class="page-header">
	Créer une Formation <small>Planification d'une nouvelle formation</small>
</h1>
{% endblock %}

{% block buttons %}
<div class="d-flex gap-2">
	<a href="{{ path('app_formation_index') }}" class="btn btn-secondary btn-sm">
		<i class="fa fa-arrow-left"></i> Retour
	</a>
</div>
{% endblock %}

{% block body %}
<div class="row">
	<div class="col-xl-12">
		<div class="card">
			<div class="card-body">
				<!-- Étapes de progression -->
				<div class="mb-4">
					<div class="progress" style="height: 4px;">
						<div class="progress-bar" id="progressBar" role="progressbar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" aria-label="Progression"></div>
					</div>
					<div class="d-flex justify-content-between mt-2">
						<span class="step-indicator active" data-step="1">1. Informations générales</span>
						<span class="step-indicator" data-step="2">2. Budget</span>
						<span class="step-indicator" data-step="3">3. Documents</span>
						<span class="step-indicator" data-step="4">4. Récapitulatif</span>
					</div>
				</div>

				<form id="formationForm">
					<!-- Étape 1: Informations générales -->
					<div class="step-content" id="step1">
						<h4 class="mb-3"><i class="fa fa-info-circle text-primary"></i> Informations générales de la formation</h4>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="titre" class="form-label">Titre de la formation *</label>
									<input type="text" class="form-control" id="titre" name="titre" required placeholder="Ex: Formation Sécurité Incendie">
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="serviceId" class="form-label">Service responsable *</label>
									<select class="form-select" id="serviceId" name="serviceId" required>
										<option value="">Choisir un service</option>
									</select>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="fondsId" class="form-label">Fonds *</label>
									<select class="form-select" id="fondsId" name="fondsId" required>
										<option value="">Choisir le type de fonds</option>
									</select>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="lieuPrevu" class="form-label">Lieu prévu *</label>
									<input type="text" class="form-control" id="lieuPrevu" name="lieuPrevu" required placeholder="Ex: Salle Conférence">
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="datePrevueDebut" class="form-label">Date de début *</label>
									<input type="date" class="form-control" id="datePrevueDebut" name="datePrevueDebut" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="datePrevueFin" class="form-label">Date de fin *</label>
									<input type="date" class="form-control" id="datePrevueFin" name="datePrevueFin" required>
								</div>
							</div>
						</div>

						<input type="hidden" id="dureePrevue" name="dureePrevu">
						<input type="hidden" id="budgetPrevu" name="budgetPrevu">

						<div class="mb-3">
							<label for="description" class="form-label">Description</label>
							<textarea class="form-control" id="description" name="description" rows="4" placeholder="Détails de la formation..."></textarea>
						</div>
					</div>


					<!-- Étape 2: Budget -->
					<div class="step-content d-none" id="step2">
						<h4 class="mb-3"><i class="fa fa-money-bill text-primary"></i> Budget prévisionnel</h4>
						
						<div class="alert alert-info mb-3">
							<i class="fa fa-info-circle"></i> Définissez les dépenses prévues par catégorie. Le budget global sera calculé automatiquement.
						</div>

						<div class="table-responsive">
							<table class="table table-hover" id="depensesTable">
								<thead class="table-secondary">
									<tr>
										<th>Catégorie de dépense</th>
										<th>Montant prévu (FCFA)</th>
										<th width="100"><i class="fa fa-cogs"></i></th>
									</tr>
								</thead>
								<tbody>
									<!-- Les lignes seront ajoutées dynamiquement -->
								</tbody>
								<tfoot>
									<tr class="table-info">
										<td><strong>Total</strong></td>
										<td><strong id="totalDepenses">0 FCFA</strong></td>
										<td></td>
									</tr>
								</tfoot>
							</table>
						</div>
						<button type="button" class="btn btn-sm btn-outline-primary" onclick="addDepenseRow()">
							<i class="fa fa-plus"></i> Ajouter une dépense
						</button>
					</div>

					<!-- Étape 3: Documents -->
					<div class="step-content d-none" id="step3">
						<h4 class="mb-3"><i class="fa fa-file-alt text-primary"></i> Documents et Notes</h4>
						
						<!-- Notes en haut -->
						<div class="mb-4">
							<label for="notes" class="form-label">Notes internes</label>
							<textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Notes internes, observations..."></textarea>
						</div>

						<!-- Documents -->
						<div class="mb-3">
							<h5 class="mb-3">Documents</h5>
							<div class="table-responsive">
								<table class="table table-hover" id="documentsTable">
									<thead class="table-secondary">
																			<tr>
										<th>Nom du document</th>
										<th>Fichier</th>
										<th width="100"><i class="fa fa-cogs"></i></th>
									</tr>
									</thead>
									<tbody>
										<!-- Les lignes seront ajoutées dynamiquement -->
									</tbody>
								</table>
							</div>
							<button type="button" class="btn btn-sm btn-outline-primary" onclick="addDocumentRow()">
								<i class="fa fa-plus"></i> Ajouter un document
							</button>
						</div>
					</div>

					<!-- Étape 4: Récapitulatif -->
					<div class="step-content d-none" id="step4">
						<h4 class="mb-3"><i class="fa fa-check-circle text-primary"></i> Récapitulatif</h4>
						
						<div id="recapContent">
							<!-- Le contenu sera généré dynamiquement -->
						</div>
					</div>

					<!-- Boutons de navigation -->
					<div class="d-flex justify-content-between mt-4">
						<button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
							<i class="fa fa-arrow-left"></i> Précédent
						</button>
						<div class="ms-auto">
							<button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
								Suivant <i class="fa fa-arrow-right"></i>
							</button>
							<button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
								<i class="fa fa-save"></i> Créer la formation
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block javascripts %}
<script>
let currentStep = 1;
let totalSteps = 4;
let services = [];
let fonds = [];
let categories = [];
let depenses = [];
let documents = [];

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les variables globales
    services = [];
    fonds = [];
    categories = [];
    depenses = {};
    documents = {};
    
    // Charger les données de base
    Promise.all([
        loadServices(),
        loadFonds(),
        loadCategories()
    ]).then(() => {
        // Configurer les événements après le chargement des données
        setupEventListeners();
    }).catch(error => {
        console.error('Erreur lors du chargement des données:', error);
        // Continuer quand même avec la configuration des événements
        setupEventListeners();
    });
});

// Charger les services
function loadServices() {
    return fetch('/api/services')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('serviceId');
            if (select) {
                select.innerHTML = '<option value="">Choisir un service</option>';
                data.forEach(service => {
                    select.innerHTML += `<option value="${service.id}">${service.libelle} (${service.direction ? service.direction.libelle : '-'})</option>`;
                });
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des services:', error);
            throw error;
        });
}

// Charger les types de fonds
function loadFonds() {
    return fetch('/api/fonds')
        .then(response => response.json())
        .then(data => {
            fonds = data;
            const select = document.getElementById('fondsId');
            if (select) {
                select.innerHTML = '<option value="">Choisir le type de fonds</option>';
                data.forEach(fond => {
                    select.innerHTML += `<option value="${fond.id}">${fond.libelle}</option>`;
                });
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des fonds:', error);
            throw error;
        });
}

// Charger les catégories de dépenses
function loadCategories() {
    return fetch('/api/categories-depenses')
        .then(response => response.json())
        .then(data => {
            categories = data;
        })
        .catch(error => {
            console.error('Erreur lors du chargement des catégories:', error);
            throw error;
        });
}

// Configuration des événements
function setupEventListeners() {
    // Calcul automatique de la durée
    const dateDebut = document.getElementById('datePrevueDebut');
    const dateFin = document.getElementById('datePrevueFin');
    if (dateDebut) dateDebut.addEventListener('change', calculateDuration);
    if (dateFin) dateFin.addEventListener('change', calculateDuration);
    
    
}

// Fonction debounce pour éviter trop de sauvegardes
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Calculer la durée automatiquement
function calculateDuration() {
    const debutField = document.getElementById('datePrevueDebut');
    const finField = document.getElementById('datePrevueFin');
    const dureeField = document.getElementById('dureePrevue');
    
    if (!debutField || !finField || !dureeField) {
        console.error('Champs de date non trouvés');
        return;
    }
    
    const debut = debutField.value;
    const fin = finField.value;
    
    if (debut && fin) {
        const dateDebut = new Date(debut);
        const dateFin = new Date(fin);
        const diffTime = Math.abs(dateFin - dateDebut);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        dureeField.value = diffDays;
    } else {
        dureeField.value = '';
    }
}



// Permettre la navigation directe vers une étape en cliquant sur les indicateurs
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('step-indicator')) {
        const targetStep = parseInt(e.target.getAttribute('data-step'));
        if (targetStep && targetStep !== currentStep) {
            // Aller à l'étape cible
            currentStep = targetStep;
            updateStepDisplay();
        }
    }
});






// Ajouter une ligne de document
function addDocumentRow() {
    const tbody = document.getElementById('documentsTable').querySelector('tbody');
    const rowId = Date.now();
    
    const row = document.createElement('tr');
    row.id = `document_${rowId}`;
    row.innerHTML = `
        <td>
            <input type="text" class="form-control form-control-sm" placeholder="Nom du document" 
                   onchange="updateDocument(${rowId}, 'nom', this.value)">
        </td>
        <td>
            <input type="file" class="form-control form-control-sm" 
                   onchange="updateDocument(${rowId}, 'file', this.files[0])">
        </td>
        <td>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeDocumentRow(${rowId})">
                <i class="fa fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    documents[rowId] = { nom: '', file: null };
}

// Mettre à jour un document
function updateDocument(rowId, field, value) {
    if (!documents) {
        documents = {};
    }
    if (!documents[rowId]) {
        documents[rowId] = {};
    }
    documents[rowId][field] = value;
}

// Mettre à jour le tableau des documents pour la soumission
function updateDocumentsArray() {
    const documentsArray = [];
    if (documents && typeof documents === 'object') {
        Object.keys(documents).forEach(rowId => {
            const doc = documents[rowId];
            if (doc && (doc.nom || doc.file)) {
                documentsArray.push({
                    nom: doc.nom || '',
                    fichier: doc.file || null
                });
            }
        });
    }
    return documentsArray;
}

// Supprimer une ligne de document
function removeDocumentRow(rowId) {
    const row = document.getElementById(`document_${rowId}`);
    if (row) {
        row.remove();
    }
    if (documents && documents[rowId]) {
        delete documents[rowId];
    }
}

// Ajouter une ligne de dépense
function addDepenseRow() {
    const tbody = document.getElementById('depensesTable').querySelector('tbody');
    const rowId = Date.now();
    
    // Sélectionner la première catégorie par défaut si disponible
    const defaultCategory = categories.length > 0 ? categories[0].id : '';
    
    const row = document.createElement('tr');
    row.id = `depense_${rowId}`;
    row.innerHTML = `
        <td>
            <select class="form-select form-select-sm depense-categorie" name="depenses[][categorieId]" onchange="updateDepense(${rowId}, 'categorieId', this.value)" required>
                <option value="">Choisir une catégorie</option>
                ${categories.map(cat => 
                    `<option value="${cat.id}" ${cat.id == defaultCategory ? 'selected' : ''}>${cat.libelle}</option>`
                ).join('')}
            </select>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm depense-montant" name="depenses[][montant]" min="0" step="1" 
                   placeholder="0" onchange="updateDepense(${rowId}, 'montant', this.value)" 
                   oninput="updateDepenseRealtime(${rowId}, 'montant', this.value)" required>
        </td>
        <td>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeDepenseRow(${rowId})">
                <i class="fa fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    depenses[rowId] = { categorieId: defaultCategory, montant: 0 };
}

// Supprimer une ligne de dépense
function removeDepenseRow(rowId) {
    const row = document.getElementById(`depense_${rowId}`);
    if (row) {
        row.remove();
    }
    if (depenses && depenses[rowId]) {
        delete depenses[rowId];
    }
    calculateTotalBudget();
}

// Mettre à jour une dépense
function updateDepense(rowId, field, value) {
    if (!depenses) {
        depenses = {};
    }
    if (!depenses[rowId]) {
        depenses[rowId] = {};
    }
    depenses[rowId][field] = field === 'montant' ? parseFloat(value) || 0 : value;
    calculateTotalBudget();
}

// Mettre à jour une dépense en temps réel (pour les montants)
function updateDepenseRealtime(rowId, field, value) {
    if (!depenses) {
        depenses = {};
    }
    if (!depenses[rowId]) {
        depenses[rowId] = {};
    }
    depenses[rowId][field] = field === 'montant' ? parseFloat(value) || 0 : value;
    calculateTotalBudgetRealtime();
}

// Calculer le budget total
function calculateTotalBudget() {
    const total = depenses && typeof depenses === 'object' ? 
        Object.values(depenses).reduce((sum, depense) => {
            return sum + (depense && depense.montant ? parseFloat(depense.montant) : 0);
        }, 0) : 0;
    
    const totalElement = document.getElementById('totalDepenses');
    if (totalElement) {
        totalElement.textContent = total.toLocaleString('fr-FR') + ' FCFA';
    }
    
    const budgetElement = document.getElementById('budgetPrevu');
    if (budgetElement) {
        budgetElement.value = total;
    }
}

// Calculer le budget total en temps réel
function calculateTotalBudgetRealtime() {
    const total = depenses && typeof depenses === 'object' ? 
        Object.values(depenses).reduce((sum, depense) => {
            return sum + (depense && depense.montant ? parseFloat(depense.montant) : 0);
        }, 0) : 0;
    
    const totalElement = document.getElementById('totalDepenses');
    if (totalElement) {
        totalElement.textContent = total.toLocaleString('fr-FR') + ' FCFA';
    }
    
    const budgetInput = document.getElementById('budgetPrevu');
    if (budgetInput) {
        budgetInput.value = total;
        // Déclencher l'événement input pour mettre à jour les autres éléments qui écoutent
        budgetInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

// Passer à l'étape suivante
function nextStep() {
    if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
            currentStep++;
            updateStepDisplay();
            
            // Actions spécifiques à chaque étape
            if (currentStep === 4) {
                generateRecap();
            }
        }
    }
}

// Passer à l'étape précédente
function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
    }
}

// Valider l'étape actuelle
function validateCurrentStep() {
    switch (currentStep) {
        case 1:
            return validateStep1();
        case 2:
            return validateStep2();
        case 3:
            return validateStep3();
        default:
            return true;
    }
}

// Valider l'étape 1
function validateStep1() {
    const required = ['titre', 'serviceId', 'fondsId', 'lieuPrevu', 'datePrevueDebut', 'datePrevueFin'];
    
    for (let field of required) {
        const element = document.getElementById(field);
        if (!element.value) {
            showToast(`Le champ "${element.previousElementSibling.textContent.replace(' *', '')}" est requis.`, 'error');
            element.focus();
            return false;
        }
    }
    
    const debut = new Date(document.getElementById('datePrevueDebut').value);
    const fin = new Date(document.getElementById('datePrevueFin').value);
    
    if (fin <= debut) {
        showToast('La date de fin doit être postérieure à la date de début.', 'error');
        return false;
    }
    
    return true;
}

// Valider l'étape 2 (Budget)
function validateStep2() {
    const validDepenses = Object.values(depenses).filter(d => d.categorieId && d.montant > 0);
    if (validDepenses.length === 0) {
        showToast('Veuillez ajouter au moins une dépense valide.', 'error');
        return false;
    }
    return true;
}

// Valider l'étape 3 (Documents)
function validateStep3() {
    // Les documents et notes sont optionnels
    return true;
}



// Mettre à jour l'affichage des étapes
function updateStepDisplay() {
    // Masquer toutes les étapes
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.add('d-none');
    });
    
    // Afficher l'étape actuelle
    const currentStepElement = document.getElementById(`step${currentStep}`);
    if (currentStepElement) {
        currentStepElement.classList.remove('d-none');
    }
    
    // Mettre à jour les indicateurs d'étapes
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        indicator.classList.remove('active', 'completed');
        if (index + 1 < currentStep) {
            indicator.classList.add('completed');
        } else if (index + 1 === currentStep) {
            indicator.classList.add('active');
        }
    });
    
    // Mettre à jour la barre de progression
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        const progress = (currentStep / totalSteps) * 100;
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
    }
    
    // Mettre à jour les boutons
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    if (prevBtn) prevBtn.style.display = currentStep === 1 ? 'none' : 'block';
    if (nextBtn) nextBtn.style.display = currentStep === totalSteps ? 'none' : 'block';
    if (submitBtn) submitBtn.style.display = currentStep === totalSteps ? 'block' : 'none';
    
    // Initialiser le tableau des dépenses si on arrive à l'étape 2 et qu'il est vide
    if (currentStep === 2) {
        setTimeout(() => {
            const tbody = document.getElementById('depensesTable').querySelector('tbody');
            if (tbody && tbody.children.length === 0) {
                addDepenseRow(); // Ajouter une ligne par défaut seulement si le tableau est vide
            }
        }, 100);
    }
    
    // Initialiser le tableau des documents si on arrive à l'étape 3 et qu'il est vide
    if (currentStep === 3) {
        setTimeout(() => {
            const tbody = document.getElementById('documentsTable').querySelector('tbody');
            if (tbody && tbody.children.length === 0) {
                addDocumentRow(); // Ajouter une ligne par défaut seulement si le tableau est vide
            }
        }, 50);
    }
}

// Générer le récapitulatif
function generateRecap() {
    const recapContent = document.getElementById('recapContent');
    if (!recapContent) {
        console.error('Élément récapitulatif non trouvé');
        return;
    }
    
    
    // Recalculer le nombre de documents
    const documentsCount = Object.keys(documents).filter(key => documents[key] && (documents[key].nom || documents[key].file)).length;
    
    const titreField = document.getElementById('titre');
    const serviceField = document.getElementById('serviceId');
    const fondsField = document.getElementById('fondsId');
    const lieuField = document.getElementById('lieuPrevu');
    const debutField = document.getElementById('datePrevueDebut');
    const finField = document.getElementById('datePrevueFin');
    const dureeField = document.getElementById('dureePrevue');
    const budgetField = document.getElementById('budgetPrevu');
    const descField = document.getElementById('description');
    const notesField = document.getElementById('notes');
    
    const formationData = {
        titre: titreField ? titreField.value : '',
        service: serviceField && serviceField.selectedIndex > 0 ? serviceField.options[serviceField.selectedIndex].text : '',
        fonds: fondsField && fondsField.selectedIndex > 0 ? fondsField.options[fondsField.selectedIndex].text : '',
        lieu: lieuField ? lieuField.value : '',
        debut: debutField ? debutField.value : '',
        fin: finField ? finField.value : '',
        duree: dureeField ? dureeField.value : '',
        budget: budgetField ? budgetField.value : '0',
        description: descField ? descField.value : '',
        notes: notesField ? notesField.value : ''
    };
    
    recapContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h5>Informations générales</h5>
                <table class="table table-sm">
                    <tr><td><strong>Titre:</strong></td><td>${formationData.titre}</td></tr>
                    <tr><td><strong>Service:</strong></td><td>${formationData.service}</td></tr>
                    <tr><td><strong>Fonds:</strong></td><td>${formationData.fonds}</td></tr>
                    <tr><td><strong>Lieu:</strong></td><td>${formationData.lieu}</td></tr>
                    <tr><td><strong>Dates:</strong></td><td>${formationData.debut} au ${formationData.fin}</td></tr>
                    <tr><td><strong>Durée:</strong></td><td>${formationData.duree} jours</td></tr>
                    <tr><td><strong>Budget:</strong></td><td>${parseInt(formationData.budget || 0).toLocaleString()} FCFA</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h5>Description</h5>
                <p>${formationData.description || 'Aucune description'}</p>
                
                <h5>Notes</h5>
                <p>${formationData.notes || 'Aucune note'}</p>
                
                <h5>Documents</h5>
                <p><strong>Nombre de documents:</strong> ${documentsCount}</p>
                ${documentsCount > 0 ? '<ul class="list-unstyled">' + Object.values(documents).filter(doc => doc && (doc.nom || doc.file)).map(doc => `<li>• ${doc.nom || 'Document sans nom'}</li>`).join('') + '</ul>' : '<p class="text-muted">Aucun document ajouté</p>'}
            </div>
        </div>
    `;
}

// Fonction pour afficher les messages toast
function showToast(message, type = 'info') {
    // Créer un élément toast simple
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Supprimer automatiquement après 5 secondes
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Gestion de la soumission du formulaire
document.getElementById('formationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    // Désactiver le bouton et afficher le spinner
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Création en cours...';
    
    // Préparer les données avec validation
    const getFieldValue = (id) => {
        const element = document.getElementById(id);
        return element ? element.value : '';
    };
    
    const formData = {
        titre: getFieldValue('titre'),
        serviceId: getFieldValue('serviceId'),
        fondsId: getFieldValue('fondsId'),
        lieuPrevu: getFieldValue('lieuPrevu'),
        datePrevueDebut: getFieldValue('datePrevueDebut'),
        datePrevueFin: getFieldValue('datePrevueFin'),
        dureePrevue: getFieldValue('dureePrevue'),
        budgetPrevu: getFieldValue('budgetPrevu') || '0',
        description: getFieldValue('description'),
        depenses: [],
        notes: getFieldValue('notes')
    };
    
    // Ajouter les dépenses
    if (depenses && typeof depenses === 'object') {
        Object.keys(depenses).forEach(rowId => {
            const depense = depenses[rowId];
            if (depense && depense.categorieId && depense.montant > 0) {
                formData.depenses.push({
                    categorieId: parseInt(depense.categorieId),
                    montant: parseFloat(depense.montant)
                });
            }
        });
    }
    
    // Ajouter les documents
    const documentsArray = updateDocumentsArray();
    formData.documents = documentsArray || [];
    
    // Créer FormData pour les fichiers
    const formDataToSend = new FormData();
    
    // Ajouter les données JSON
    formDataToSend.append('data', JSON.stringify(formData));
    
    // Ajouter les fichiers
    if (documentsArray && Array.isArray(documentsArray)) {
        documentsArray.forEach((doc, index) => {
            if (doc && doc.fichier) {
                formDataToSend.append(`document_${index}`, doc.fichier);
            }
            formDataToSend.append(`document_nom_${index}`, doc ? doc.nom || '' : '');
        });
    }
    
    // Envoyer les données
    fetch('{{ path('app_formation_new') }}', {
        method: 'POST',
        body: formDataToSend
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => {
                window.location.href = '{{ path('app_formation_index') }}';
            }, 1500);
        } else {
            showToast(data.message || 'Erreur lors de la création', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showToast('Erreur lors de la création de la formation', 'error');
    })
    .finally(() => {
        // Réactiver le bouton
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});
</script>

<style>
.step-indicator {
    font-size: 0.9rem;
    color: #6c757d;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 15px;
    transition: all 0.3s ease;
}

.step-indicator.active {
    background-color: #007bff;
    color: white;
}

.step-indicator.completed {
    background-color: #28a745;
    color: white;
}

.step-content {
    min-height: 400px;
}
</style>
{% endblock %}
