{% extends 'base.html.twig' %}

{% block title %}ANAC BENIN - Mon Profil{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
	<li class="breadcrumb-item"><a href="#">UTILISATEUR</a></li>
	<li class="breadcrumb-item active">PROFIL</li>
</ul>
{% endblock %}

{% block page_title %}
<h1 class="page-header">
	Mon Profil <small>Gestion de mes informations personnelles</small>
</h1>
{% endblock %}

{% block buttons %}
<a href="{{ path('app_profile_change_password') }}" class="btn btn-warning btn-sm">
	<i class="fa fa-key"></i> Changer le mot de passe
</a>
{% endblock %}

{% block body %}
<div class="row">
	<div class="col-xl-12">
		<div class="card">
			<div class="card-body">
				{% for message in app.flashes('success') %}
					<div class="alert alert-success alert-dismissible fade show" role="alert">
						{{ message }}
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
					</div>
				{% endfor %}

				<!-- Image de profil centrée -->
				<div class="text-center mb-4">
					{% if app.user.photo %}
						<img src="{{ asset('uploads/photos/' ~ app.user.photo) }}" alt="Avatar" class="rounded-circle" width="120" height="120" style="object-fit: cover;">
					{% else %}
						<img src="{{ asset('assets/img/user/user.jpg') }}" alt="Avatar" class="rounded-circle" width="120" height="120">
					{% endif %}
					<h4 class="mt-3 mb-1">{{ app.user.nom }} {{ app.user.prenom }}</h4>
					<p class="text-muted">{{ app.user.email }}</p>
				</div>

				<!-- Bouton modifier centré -->
				<div class="text-center mb-4">
					<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
						<i class="fa fa-edit"></i> Modifier le profil
					</button>
				</div>

				<!-- Contenu centré -->
				<div class="row justify-content-center">
					<div class="col-md-6">
<div class="border rounded p-3">
				<div class="table-responsive">
					<table class="table table-borderless">
						<tbody>
							<tr>
								<td width="150"><strong>Nom</strong></td>
								<td>{{ app.user.nom }}</td>
							</tr>
							<tr>
								<td><strong>Prénom</strong></td>
								<td>{{ app.user.prenom }}</td>
							</tr>
							<tr>
								<td><strong>Email</strong></td>
								<td>{{ app.user.email }}</td>
							</tr>
							<tr>
								<td><strong>Matricule</strong></td>
								<td>{{ app.user.matricule ?: 'Non renseigné' }}</td>
							</tr>
							<tr>
								<td><strong>Service</strong></td>
								<td>{{ app.user.service ? app.user.service.libelle : 'Non assigné' }}</td>
							</tr>
							<tr>
								<td><strong>Domaine</strong></td>
								<td>{{ app.user.domaine ? app.user.domaine.libelle : 'Non assigné' }}</td>
							</tr>
							<tr>
								<td><strong>Poste</strong></td>
								<td>{{ app.user.poste ? app.user.poste.libelle : 'Non assigné' }}</td>
							</tr>
							<tr>
								<td><strong>Rôles</strong></td>
								<td>
									{% for role in app.user.roles %}
										{% if role == 'ROLE_ADMIN' %}
											<span class="badge bg-danger">{{ role|replace({'ROLE_': ''}) }}</span>
										{% elseif role == 'ROLE_DIRECTEUR' %}
											<span class="badge bg-warning">{{ role|replace({'ROLE_': ''}) }}</span>
										{% elseif role == 'ROLE_EDITEUR' %}
											<span class="badge bg-success">{{ role|replace({'ROLE_': ''}) }}</span>
										{% elseif role == 'ROLE_USER' %}
											<span class="badge bg-primary">{{ role|replace({'ROLE_': ''}) }}</span>
										{% else %}
											<span class="badge bg-secondary">{{ role }}</span>
										{% endif %}
									{% endfor %}
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Modal pour modifier le profil -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editProfileModalLabel">Modifier le profil</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form id="editProfileForm" enctype="multipart/form-data">
				<div class="modal-body">
					<div class="mb-3">
						<label for="nom" class="form-label">Nom</label>
						<input type="text" class="form-control" id="nom" name="nom" value="{{ app.user.nom }}" required>
					</div>
					<div class="mb-3">
						<label for="prenom" class="form-label">Prénom</label>
						<input type="text" class="form-control" id="prenom" name="prenom" value="{{ app.user.prenom }}" required>
					</div>
					<div class="mb-3">
						<label for="email" class="form-label">Email</label>
						<input type="email" class="form-control" id="email" name="email" value="{{ app.user.email }}" required>
					</div>
					<div class="mb-3">
						<label for="matricule" class="form-label">Matricule</label>
						<input type="text" class="form-control" id="matricule" name="matricule" value="{{ app.user.matricule }}">
						<small class="form-text text-muted">Optionnel</small>
					</div>
					<div class="mb-3">
						<label for="photo" class="form-label">Photo de profil</label>
						<input type="file" class="form-control" id="photo" name="photo" accept="image/*">
						<small class="form-text text-muted">Formats acceptés : JPG, PNG, GIF (max 1MB)</small>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
					<button type="submit" class="btn btn-primary" id="submitBtn">
						<span class="btn-text">
							<i class="fa fa-save"></i> Enregistrer
						</span>
						<span class="btn-spinner d-none">
							<i class="fa fa-spinner fa-spin"></i> Enregistrement...
						</span>
					</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier que jQuery est disponible
    if (typeof $ === 'undefined') {
        console.error('jQuery n\'est pas chargé');
        showToast('Erreur: jQuery n\'est pas disponible', 'error');
        return;
    }
    
    $('#editProfileForm').on('submit', function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        var submitBtn = $('#submitBtn');
        var btnText = submitBtn.find('.btn-text');
        var btnSpinner = submitBtn.find('.btn-spinner');
        
        // Désactiver le bouton et afficher le spinner
        submitBtn.prop('disabled', true);
        btnText.addClass('d-none');
        btnSpinner.removeClass('d-none');
        
        $.ajax({
            url: '{{ path('app_profile_update') }}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    
                    // Mettre à jour les valeurs dans le tableau
                    $('td:contains("Nom")').parent().find('td:eq(1)').text($('#nom').val());
                    $('td:contains("Prénom")').parent().find('td:eq(1)').text($('#prenom').val());
                    $('td:contains("Email")').parent().find('td:eq(1)').text($('#email').val());
                    $('td:contains("Matricule")').parent().find('td:eq(1)').text($('#matricule').val() || 'Non renseigné');
                    
                    // Mettre à jour l'affichage en haut
                    $('h4.mt-3').text($('#nom').val() + ' ' + $('#prenom').val());
                    $('p.text-muted').text($('#email').val());
                    
                    // Mettre à jour la photo si elle a changé
                    if (response.photo) {
                        $('.rounded-circle').attr('src', '{{ asset('uploads/photos/') }}' + response.photo);
                    }
                    
                    // Fermer le modal
                    $('#editProfileModal').modal('hide');
                } else {
                    showToast(response.message, 'error');
                }
            },
            error: function() {
                showToast('Erreur lors de la mise à jour', 'error');
            },
            complete: function() {
                // Réactiver le bouton
                submitBtn.prop('disabled', false);
                btnText.removeClass('d-none');
                btnSpinner.addClass('d-none');
            }
        });
    });
});
</script>
{% endblock %}

