{% extends 'base.html.twig' %}

{% block title %}ANAC BENIN - Reporting{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
	<li class="breadcrumb-item"><a href="#">REPORTING</a></li>
	<li class="breadcrumb-item active">FILTRES ET ANALYSES</li>
</ul>
{% endblock %}

{% block page_title %}
<h1 class="page-header">
	Reporting <small>Analyses et statistiques détaillées</small>
</h1>
{% endblock %}

{% block stylesheets %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.filter-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    background: #f8f9fa;
}

.filter-section {
    margin-bottom: 15px;
}

.filter-section label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    font-size: 0.8rem;
    white-space: nowrap;
}

.filter-section .form-select,
.filter-section .form-control {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    height: auto;
}

.filter-section {
    margin-bottom: 0.5rem;
}

.results-section {
    display: none;
    margin-top: 30px;
}

.section-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 20px;
    background: white;
}

.section-header {
    background: #f8f9fa;
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
    border-radius: 8px 8px 0 0;
}

.section-content {
    padding: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.stat-item {
    background: #ffffff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
    overflow: hidden;
}

.stat-item:hover {
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
    transform: translateY(-2px);
}

.stat-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.stat-item-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
}

.stat-item-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    color: #ffffff;
    flex-shrink: 0;
}

.stat-item.stat-success .stat-item-icon {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.stat-item.stat-danger .stat-item-icon {
    background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
}

.stat-item.stat-warning .stat-item-icon {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
}

.stat-item.stat-info .stat-item-icon {
    background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%);
}

.stat-item.stat-primary .stat-item-icon {
    background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
}

.stat-number {
    font-size: 1.50rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 10px 0;
    line-height: 1.2;
}

.stat-item-footer {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.875rem;
    margin-top: 10px;
}

.stat-item-change {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
}

.stat-item-change.positive {
    color: #28a745;
}

.stat-item-change.negative {
    color: #dc3545;
}

.stat-item-period {
    color: #6c757d;
    font-size: 0.75rem;
    margin-left: auto;
}

.export-buttons {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    text-align: center;
}

.table-responsive {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: auto;
    width: 100%;
}

#directionsTable {
    table-layout: fixed;
}

#directionsTable th:nth-child(1),
#directionsTable td:nth-child(1) {
    width: 25%;
    max-width: 25%;
}

#directionsTable th:nth-child(2),
#directionsTable td:nth-child(2) {
    width: 18%;
    max-width: 18%;
}

#directionsTable th:nth-child(3),
#directionsTable td:nth-child(3) {
    width: 18%;
    max-width: 18%;
}

#directionsTable th:nth-child(4),
#directionsTable td:nth-child(4) {
    width: 20%;
    max-width: 20%;
}

#directionsTable th:nth-child(5),
#directionsTable td:nth-child(5) {
    width: 19%;
    max-width: 19%;
}

.table {
    width: 100% !important;
    margin-bottom: 0;
    table-layout: fixed;
}

.table th,
.table td {
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    padding: 8px;
    vertical-align: middle;
}

.table th:nth-child(1),
.table td:nth-child(1) {
    width: 25%;
    max-width: 25%;
}

.table th:nth-child(2),
.table td:nth-child(2) {
    width: 15%;
    max-width: 15%;
}

.table th:nth-child(3),
.table td:nth-child(3) {
    width: 20%;
    max-width: 20%;
}

.table th:nth-child(4),
.table td:nth-child(4) {
    width: 20%;
    max-width: 20%;
}

.table th:nth-child(5),
.table td:nth-child(5) {
    width: 20%;
    max-width: 20%;
}

.loading {
    display: none;
    text-align: center;
    padding: 40px;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}
</style>
{% endblock %}

{% block body %}
<!-- Section Filtres Horizontale -->
<div class="filter-card mb-4">
    <h5 class="mb-3"><i class="fa fa-filter"></i> Filtres</h5>
    <form id="filtersForm">
        <div class="row">
            <!-- Colonne 9 pour les champs -->
            <div class="col-md-9">
                <!-- Première ligne des champs -->
                <div class="row mb-3">
                    <!-- Direction -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Direction</label>
                            <select class="form-select" name="direction_id" id="directionSelect">
                                <option value="">Toutes</option>
                            </select>
                        </div>
                    </div>

                    <!-- Service -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Service</label>
                            <select class="form-select" name="service_id" id="serviceSelect">
                                <option value="">Tous</option>
                            </select>
                        </div>
                    </div>

                    <!-- Statut -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Statut</label>
                            <select class="form-select" name="statut_id" id="statutSelect">
                                <option value="">Tous</option>
                            </select>
                        </div>
                    </div>

                    <!-- Type de fonds -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Type de financement</label>
                            <select class="form-select" name="type_fonds_id" id="typeFondsSelect">
                                <option value="">Tous</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Deuxième ligne des champs -->
                <div class="row">
                    <!-- Lieu -->
                    <div class="col-md-4">
                        <div class="filter-section">
                            <label>Lieu</label>
                            <input type="text" class="form-control" name="lieu" placeholder="Ville, pays...">
                        </div>
                    </div>

                    <!-- Période -->
                    <div class="col-md-4">
                        <div class="filter-section">
                            <label>Période</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="date" class="form-control" name="date_debut" id="dateDebut" placeholder="Date début">
                                </div>
                                <div class="col-6">
                                    <input type="date" class="form-control" name="date_fin" id="dateFin" placeholder="Date fin">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Année -->
                    <div class="col-md-4">
                        <div class="filter-section">
                            <label>Année</label>
                            <select class="form-select" name="annee" id="anneeSelect">
                                <option value="{{ currentYear }}" selected>{{ currentYear }}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne 3 pour les boutons avec bordure -->
            <div class="col-md-3">
                <div class="filter-section d-flex align-items-end h-100" style="border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; background: #f8f9fa;">
                    <div class="w-100">
                        <!-- Type d'activité en haut -->
                        <div class="mb-3">
                            <label style="font-size: 0.8rem; margin-bottom: 0.25rem;">Type d'activité</label>
                            <select class="form-select form-select-sm" name="type_activite" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                <option value="all">Tous</option>
                                <option value="formation">Formations</option>
                                <option value="mission">Missions</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-sm w-100 mb-2">
                            <i class="fa fa-search"></i> Appliquer les filtres
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm w-100" id="resetFilters">
                            <i class="fa fa-refresh"></i> Réinitialiser
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Section Résultats -->
<div class="row">
    <div class="col-12">
        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Génération du rapport en cours...</p>
        </div>

        <div class="results-section" id="resultsContainer">
            <!-- 1. Résumé Global -->
            <div class="section-card" id="resumeSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-chart-pie"></i> Résumé Global</h5>
                </div>
                <div class="section-content">
                    <div class="stats-grid" id="resumeStats">
                        <!-- Stats will be populated by JS -->
                    </div>
                </div>
            </div>

            <!-- 2. Détails Formations -->
            <div class="section-card" id="formationsSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-graduation-cap"></i> Détails Formations</h5>
                </div>
                <div class="section-content">
                    <div class="row">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-striped w-100" id="reportingFormationsTable">
                                    <thead>
                                        <tr>
                                            <th>Titre</th>
                                            <th>Direction</th>
                                            <th>Dates</th>
                                            <th>Statut</th>
                                            <th>Budget</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Détails Missions -->
            <div class="section-card" id="missionsSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-plane"></i> Détails Missions</h5>
                </div>
                <div class="section-content">
                    <div class="row">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-striped w-100" id="reportingMissionsTable">
                                    <thead>
                                        <tr>
                                            <th>Titre</th>
                                            <th>Direction</th>
                                            <th>Dates</th>
                                            <th>Statut</th>
                                            <th>Budget</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="chart-container">
                                <canvas id="missionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Par Direction -->
            <div class="section-card" id="directionsSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-building"></i> Analyse par Direction</h5>
                </div>
                <div class="section-content">
                    <div class="table-responsive">
                        <table class="table table-striped" id="directionsTable">
                            <thead>
                                <tr>
                                    <th>Direction</th>
                                    <th>Formations</th>
                                    <th>Missions</th>
                                    <th>Taux d'exécution</th>
                                    <th>Budget total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. Évolution temporelle -->
            <div class="section-card" id="evolutionSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-line-chart"></i> Évolution Temporelle</h5>
                </div>
                <div class="section-content">
                    <div class="chart-container">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 6. Indicateurs Clés -->
            <div class="section-card" id="indicateursSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-dashboard"></i> Indicateurs Clés</h5>
                </div>
                <div class="section-content">
                    <div class="stats-grid" id="indicateursStats">
                        <!-- Stats will be populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Export -->
            <div class="export-buttons">
                <button type="button" class="btn btn-danger me-2" id="exportPdf">
                    <i class="fa fa-file-pdf-o"></i> Exporter en PDF
                </button>
                <button type="button" class="btn btn-success me-2" id="exportExcel">
                    <i class="fa fa-file-excel-o"></i> Exporter en Excel
                </button>
                <button type="button" class="btn btn-info" id="print">
                    <i class="fa fa-print"></i> Imprimer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filtersForm = document.getElementById('filtersForm');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultsContainer = document.getElementById('resultsContainer');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const exportPdfBtn = document.getElementById('exportPdf');

    let currentData = null;

    // Charger les données des filtres au démarrage
    loadFiltersData();
    
    // Définir les dates par défaut (début et fin du mois actuel)
    setDefaultDates();
    
    // Charger les données par défaut (mois actuel)
    loadData();

    // Gestion du formulaire de filtres
    filtersForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loadData();
    });

    // Réinitialisation des filtres
    resetFiltersBtn.addEventListener('click', function() {
        filtersForm.reset();
        filtersForm.querySelector('[name="annee"]').value = '{{ currentYear }}';
        setDefaultDates(); // Remettre les dates par défaut
        resultsContainer.style.display = 'none';
    });

    // Export PDF
    exportPdfBtn.addEventListener('click', function() {
        if (!currentData) return;
        
        const formData = new FormData(filtersForm);
        
        fetch('{{ path('app_reporting_export_pdf') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rapport_' + new Date().toISOString().slice(0, 10) + '.pdf';
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Erreur export PDF:', error);
            showToast('Erreur lors de l\'export PDF', 'error');
        });
    });

    // Fonction pour définir les dates par défaut
    function setDefaultDates() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        
        // Premier jour du mois actuel
        const firstDay = new Date(year, month, 1);
        const dateDebut = firstDay.toISOString().split('T')[0];
        
        // Dernier jour du mois actuel
        const lastDay = new Date(year, month + 1, 0);
        const dateFin = lastDay.toISOString().split('T')[0];
        
        // Définir les valeurs par défaut
        document.getElementById('dateDebut').value = dateDebut;
        document.getElementById('dateFin').value = dateFin;
    }

    // Fonction pour charger les données des filtres
    function loadFiltersData() {
        fetch('{{ path('app_reporting_api_filters') }}')
        .then(response => response.json())
        .then(data => {
            console.log('Données reçues:', data);
            
            // Remplir les directions
            const directionSelect = document.getElementById('directionSelect');
            directionSelect.innerHTML = '<option value="">Toutes</option>';
            if (data.directions && data.directions.length > 0) {
                data.directions.forEach(direction => {
                    const option = document.createElement('option');
                    option.value = direction.id;
                    option.textContent = direction.libelle;
                    directionSelect.appendChild(option);
                });
            }

            // Remplir les services
            const serviceSelect = document.getElementById('serviceSelect');
            serviceSelect.innerHTML = '<option value="">Tous</option>';
            if (data.services && data.services.length > 0) {
                data.services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = service.libelle;
                    serviceSelect.appendChild(option);
                });
            }

            // Remplir les statuts
            const statutSelect = document.getElementById('statutSelect');
            statutSelect.innerHTML = '<option value="">Tous</option>';
            if (data.statuts && data.statuts.length > 0) {
                data.statuts.forEach(statut => {
                    const option = document.createElement('option');
                    option.value = statut.id;
                    option.textContent = statut.libelle;
                    statutSelect.appendChild(option);
                });
            }

            // Remplir les types de fonds
            const typeFondsSelect = document.getElementById('typeFondsSelect');
            typeFondsSelect.innerHTML = '<option value="">Tous</option>';
            if (data.typeFonds && data.typeFonds.length > 0) {
                data.typeFonds.forEach(fonds => {
                    const option = document.createElement('option');
                    option.value = fonds.id;
                    option.textContent = fonds.libelle;
                    typeFondsSelect.appendChild(option);
                });
            }

            // Remplir les années
            const anneeSelect = document.getElementById('anneeSelect');
            anneeSelect.innerHTML = '';
            if (data.years && data.years.length > 0) {
                data.years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    anneeSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des filtres:', error);
        });
    }

    // Fonction pour charger les données
    function loadData() {
        loadingIndicator.style.display = 'block';
        resultsContainer.style.display = 'none';

        const formData = new FormData(filtersForm);
        
        // Ajouter le mois actuel par défaut
        const currentMonth = new Date().getMonth() + 1;
        formData.append('mois', currentMonth);

        // Charger les données section par section
        Promise.all([
            loadResumeData(formData),
            loadFormationsData(formData),
            loadMissionsData(formData),
            loadDirectionsData(formData),
            loadPeriodesData(formData),
            loadStatutsData(formData),
            loadIndicateursData(formData)
        ]).then(() => {
            loadingIndicator.style.display = 'none';
            resultsContainer.style.display = 'block';
        }).catch(error => {
            console.error('Erreur:', error);
            loadingIndicator.style.display = 'none';
            showToast('Erreur lors du chargement des données', 'error');
        });
    }

    // Fonction pour charger le résumé
    function loadResumeData(formData) {
        return fetch('{{ path('app_reporting_data_resume') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            populateResumeGlobal(data);
        });
    }

    // Fonction pour charger les formations
    function loadFormationsData(formData) {
        return fetch('{{ path('app_reporting_data_formations') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            populateFormations(data);
        });
    }

    // Fonction pour charger les missions
    function loadMissionsData(formData) {
        return fetch('{{ path('app_reporting_data_missions') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            populateMissions(data);
        });
    }

    // Fonction pour charger les données par direction
    function loadDirectionsData(formData) {
        return fetch('{{ path('app_reporting_data_directions') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            populateDirections(data);
        });
    }

    // Fonction pour charger les données par période
    function loadPeriodesData(formData) {
        return fetch('{{ path('app_reporting_data_periodes') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            populateEvolution(data);
        });
    }

    // Fonction pour charger les données de statuts
    function loadStatutsData(formData) {
        return fetch('{{ path('app_reporting_data_statuts') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // populateStatuts(data); // À implémenter si nécessaire
        });
    }

    // Fonction pour charger les indicateurs
    function loadIndicateursData(formData) {
        return fetch('{{ path('app_reporting_data_indicateurs') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            populateIndicateurs(data);
        });
    }



    function populateResumeGlobal(resume) {
        const container = document.getElementById('resumeStats');
        const tauxExecution = resume.missions_prevues + resume.formations_prevues > 0 
            ? ((resume.missions_realisees + resume.formations_realisees) / (resume.missions_prevues + resume.formations_prevues) * 100).toFixed(1)
            : 0;

        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-bordered table-striped w-100">
                    <thead>
                        <tr>
                            <th>Indicateur</th>
                            <th>Valeur</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Formations prévues</td>
                            <td>${resume.formations_prevues}</td>
                        </tr>
                        <tr>
                            <td>Formations réalisées</td>
                            <td>${resume.formations_realisees}</td>
                        </tr>
                        <tr>
                            <td>Missions prévues</td>
                            <td>${resume.missions_prevues}</td>
                        </tr>
                        <tr>
                            <td>Missions réalisées</td>
                            <td>${resume.missions_realisees}</td>
                        </tr>
                        <tr>
                            <td>Budget total prévu</td>
                            <td>${new Intl.NumberFormat('fr-FR').format(resume.budget_total_prevu)} FCFA</td>
                        </tr>
                        <tr>
                            <td>Budget total réalisé</td>
                            <td>${new Intl.NumberFormat('fr-FR').format(resume.budget_total_realise)} FCFA</td>
                        </tr>
                        <tr>
                            <td>Taux d'exécution global</td>
                            <td>${tauxExecution}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;
    }

    function populateFormations(formations) {
        const tbody = document.querySelector('#reportingFormationsTable tbody');
        let html = '';
        
        console.log('Formations data:', formations);
        
        if (formations.liste && formations.liste.length > 0) {
            formations.liste.forEach(formation => {
                console.log('Formation:', formation);
                
                 // Gestion des dates (maintenant des chaînes de caractères)
                let dateDebut = '-';
                let dateFin = '-';
                
                if (formation.datePrevueDebut) {
                    try {
                        dateDebut = new Date(formation.datePrevueDebut).toLocaleDateString('fr-FR');
                    } catch (e) {
                        console.error('Erreur date début:', e);
                        dateDebut = '-';
                    }
                }
                
                if (formation.datePrevueFin) {
                    try {
                        dateFin = new Date(formation.datePrevueFin).toLocaleDateString('fr-FR');
                    } catch (e) {
                        console.error('Erreur date fin:', e);
                        dateFin = '-';
                    }
                }
                
                const dates = `${dateDebut} - ${dateFin}`;
                const budget = formation.budgetPrevu ? new Intl.NumberFormat('fr-FR').format(formation.budgetPrevu) + ' FCFA' : '-';
                
                html += `
                    <tr>
                        <td>${formation.titre || '-'}</td>
                        <td>${formation.direction ? formation.direction.libelle : '-'}</td>
                        <td>${dates}</td>
                        <td><span class="badge bg-${formation.statutActivite ? formation.statutActivite.couleur : 'secondary'}">${formation.statutActivite ? formation.statutActivite.libelle : '-'}</span></td>
                        <td>${budget}</td>
                    </tr>
                `;
            });
        } else {
            html = '<tr><td colspan="5" class="text-center">Aucune formation trouvée</td></tr>';
        }
        
        tbody.innerHTML = html;
    }

    function populateMissions(missions) {
        const tbody = document.querySelector('#reportingMissionsTable tbody');
        let html = '';
        
        console.log('Missions data:', missions);
        
        if (missions.liste && missions.liste.length > 0) {
            missions.liste.forEach(mission => {
                console.log('Mission:', mission);
                
                // Gestion des dates (maintenant des chaînes de caractères)
                let dateDebut = '-';
                let dateFin = '-';
                
                if (mission.datePrevueDebut) {
                    try {
                        dateDebut = new Date(mission.datePrevueDebut).toLocaleDateString('fr-FR');
                    } catch (e) {
                        console.error('Erreur date début:', e);
                        dateDebut = '-';
                    }
                }
                
                if (mission.datePrevueFin) {
                    try {
                        dateFin = new Date(mission.datePrevueFin).toLocaleDateString('fr-FR');
                    } catch (e) {
                        console.error('Erreur date fin:', e);
                        dateFin = '-';
                    }
                }
                
                const dates = `${dateDebut} - ${dateFin}`;
                const budget = mission.budgetPrevu ? new Intl.NumberFormat('fr-FR').format(mission.budgetPrevu) + ' FCFA' : '-';
                
                html += `
                    <tr>
                        <td>${mission.titre || '-'}</td>
                        <td>${mission.direction ? mission.direction.libelle : '-'}</td>
                        <td>${dates}</td>
                        <td><span class="badge bg-${mission.statutActivite ? mission.statutActivite.couleur : 'secondary'}">${mission.statutActivite ? mission.statutActivite.libelle : '-'}</span></td>
                        <td>${budget}</td>
                    </tr>
                `;
            });
        } else {
            html = '<tr><td colspan="5" class="text-center">Aucune mission trouvée</td></tr>';
        }
        
        tbody.innerHTML = html;
    }

    function populateDirections(parDirection) {
        const tbody = document.querySelector('#directionsTable tbody');
        let html = '';

        // Combiner les données formations et missions par direction
        const directions = {};
        
        // Traiter les formations - convertir en nombres
        if (parDirection.formations && Array.isArray(parDirection.formations)) {
            parDirection.formations.forEach(item => {
                const directionName = item.direction_name || 'Non définie';
                if (!directions[directionName]) {
                    directions[directionName] = { formations: 0, missions: 0, formations_exec: 0, missions_exec: 0 };
                }
                // Convertir en nombres pour éviter les problèmes de type
                directions[directionName].formations = parseInt(item.total) || 0;
                directions[directionName].formations_exec = parseInt(item.executed) || 0;
            });
        }

        // Traiter les missions - convertir en nombres
        if (parDirection.missions && Array.isArray(parDirection.missions)) {
            parDirection.missions.forEach(item => {
                const directionName = item.direction_name || 'Non définie';
                if (!directions[directionName]) {
                    directions[directionName] = { formations: 0, missions: 0, formations_exec: 0, missions_exec: 0 };
                }
                // Convertir en nombres pour éviter les problèmes de type
                directions[directionName].missions = parseInt(item.total) || 0;
                directions[directionName].missions_exec = parseInt(item.executed) || 0;
            });
        }

        Object.entries(directions).forEach(([directionName, data]) => {
            // Convertir toutes les valeurs en nombres
            const totalFormations = parseInt(data.formations) || 0;
            const totalMissions = parseInt(data.missions) || 0;
            const formationsExec = parseInt(data.formations_exec) || 0;
            const missionsExec = parseInt(data.missions_exec) || 0;
            
            const totalActivites = totalFormations + totalMissions;
            const totalExecutees = formationsExec + missionsExec;
            
            // Calcul du taux d'exécution : (réalisées / prévues) * 100
            // Limiter à 100% maximum sauf si vraiment plus d'activités exécutées que prévues
            let tauxExecution = 0;
            if (totalActivites > 0) {
                tauxExecution = (totalExecutees / totalActivites * 100);
                // Si le taux dépasse 100%, c'est possible (activités non prévues exécutées)
                // mais on peut vouloir le limiter visuellement à 100% pour la cohérence
                // Pour l'instant, on garde le calcul réel
            }

            // Arrondir à 1 décimale
            tauxExecution = parseFloat(tauxExecution.toFixed(1));

            // Déterminer la couleur du badge
            let badgeColor = 'secondary';
            if (tauxExecution >= 100) {
                badgeColor = 'success';
            } else if (tauxExecution >= 70) {
                badgeColor = 'success';
            } else if (tauxExecution >= 50) {
                badgeColor = 'warning';
            } else {
                badgeColor = 'danger';
            }

            html += `
                <tr>
                    <td>${directionName}</td>
                    <td>${totalFormations} (${formationsExec} réalisées)</td>
                    <td>${totalMissions} (${missionsExec} réalisées)</td>
                    <td><span class="badge bg-${badgeColor}">${tauxExecution}%</span></td>
                    <td>-</td>
                </tr>
            `;
        });

        tbody.innerHTML = html || '<tr><td colspan="5" class="text-center">Aucune donnée disponible</td></tr>';
    }

    function populateEvolution(parPeriode) {
        const ctx = document.getElementById('evolutionChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
                datasets: [{
                    label: 'Formations',
                    data: Object.values(parPeriode.formations),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }, {
                    label: 'Missions',
                    data: Object.values(parPeriode.missions),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function populateIndicateurs(indicateurs) {
        const container = document.getElementById('indicateursStats');
        
        // Calcul de l'écart : budget_reel - budget_prevu
        // Si écart < 0 : on a dépensé moins que prévu (profit) = vert
        // Si écart > 0 : on a dépensé plus que prévu (dépassement) = rouge
        const ecart = indicateurs.ecart_budget;
        const isProfit = ecart < 0; // Budget réel < Budget prévu = profit
        const ecartClass = isProfit ? 'positive' : 'negative';
        const ecartItemClass = isProfit ? 'stat-success' : 'stat-danger';
        const ecartIcon = isProfit ? '↑' : '↓';
        
        // Déterminer la classe pour le taux d'exécution
        const tauxExecution = indicateurs.taux_execution_budget;
        let tauxItemClass = 'stat-info';
        let tauxIcon = 'fa-percent';
        if (tauxExecution >= 90) {
            tauxItemClass = 'stat-success';
            tauxIcon = 'fa-check-circle';
        } else if (tauxExecution >= 70) {
            tauxItemClass = 'stat-warning';
            tauxIcon = 'fa-exclamation-circle';
        } else {
            tauxItemClass = 'stat-danger';
            tauxIcon = 'fa-times-circle';
        }

        // Formatage des montants
        const budgetPrevu = new Intl.NumberFormat('fr-FR').format(indicateurs.budget_prevu_total);
        const budgetReel = new Intl.NumberFormat('fr-FR').format(indicateurs.budget_reel_total);
        const ecartAbs = new Intl.NumberFormat('fr-FR').format(Math.abs(ecart));

        container.innerHTML = `
            <div class="stat-item ${tauxItemClass}">
                <div class="stat-item-header">
                    <p class="stat-item-title">Taux d'exécution budget</p>
                    <div class="stat-item-icon">
                        <i class="fa ${tauxIcon}"></i>
                    </div>
                </div>
                <div class="stat-number">${tauxExecution.toFixed(1)}%</div>
            </div>
            
            <div class="stat-item stat-primary">
                <div class="stat-item-header">
                    <p class="stat-item-title">Budget prévu total</p>
                    <div class="stat-item-icon">
                        <i class="fa fa-calendar-check"></i>
                    </div>
                </div>
                <div class="stat-number">${budgetPrevu} FCFA</div>
            </div>
            
            <div class="stat-item stat-info">
                <div class="stat-item-header">
                    <p class="stat-item-title">Budget réel total</p>
                    <div class="stat-item-icon">
                        <i class="fa fa-money-bill-wave"></i>
                    </div>
                </div>
                <div class="stat-number">${budgetReel} FCFA</div>
            </div>
            
            <div class="stat-item ${ecartItemClass}">
                <div class="stat-item-header">
                    <p class="stat-item-title">Écart budgétaire</p>
                    <div class="stat-item-icon">
                        <i class="fa ${isProfit ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                    </div>
                </div>
                <div class="stat-number">${ecartAbs} FCFA</div>
                <div class="stat-item-footer">
                    <div class="stat-item-change ${ecartClass}">
                        <i class="fa ${isProfit ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                        <span>${isProfit ? 'Économie' : 'Dépassement'}</span>
                    </div>
                </div>
            </div>
        `;
    }

    function showToast(message, type = 'info') {
        // Fonction pour afficher les notifications
        console.log(`${type.toUpperCase()}: ${message}`);
    }
});
</script>
{% endblock %}
