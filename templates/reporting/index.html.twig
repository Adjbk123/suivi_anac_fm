{% extends 'base.html.twig' %}

{% block title %}ANAC BENIN - Reporting{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
	<li class="breadcrumb-item"><a href="#">REPORTING</a></li>
	<li class="breadcrumb-item active">FILTRES ET ANALYSES</li>
</ul>
{% endblock %}

{% block page_title %}
<h1 class="page-header">
	Reporting <small>Analyses et statistiques détaillées</small>
</h1>
{% endblock %}

{% block stylesheets %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.filter-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    background: #f8f9fa;
}

.filter-section {
    margin-bottom: 15px;
}

.filter-section label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    font-size: 0.8rem;
    white-space: nowrap;
}

.filter-section .form-select,
.filter-section .form-control {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    height: auto;
}

.filter-section {
    margin-bottom: 0.5rem;
}

.results-section {
    display: none;
    margin-top: 30px;
}

.section-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 20px;
    background: white;
}

.section-header {
    background: #f8f9fa;
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
    border-radius: 8px 8px 0 0;
}

.section-content {
    padding: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.stat-item {
    background: #ffffff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
    overflow: hidden;
}

.stat-item:hover {
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
    transform: translateY(-2px);
}

.stat-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.stat-item-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
}

.stat-item-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    color: #ffffff;
    flex-shrink: 0;
}

.stat-item.stat-success .stat-item-icon {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.stat-item.stat-danger .stat-item-icon {
    background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
}

.stat-item.stat-warning .stat-item-icon {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
}

.stat-item.stat-info .stat-item-icon {
    background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%);
}

.stat-item.stat-primary .stat-item-icon {
    background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
}

.stat-number {
    font-size: 1.50rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 10px 0;
    line-height: 1.2;
}

.stat-item-footer {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.875rem;
    margin-top: 10px;
}

.stat-item-change {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
}

.stat-item-change.positive {
    color: #28a745;
}

.stat-item-change.negative {
    color: #dc3545;
}

.stat-item-period {
    color: #6c757d;
    font-size: 0.75rem;
    margin-left: auto;
}

.export-buttons {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    text-align: center;
}

.table-responsive {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: auto;
    width: 100%;
}

/* Égaliser les hauteurs des colonnes dans les sections séparées */
.section-content .row {
    display: flex;
    flex-wrap: wrap;
}

.section-content .row > [class*='col-'] {
    display: flex;
    flex-direction: column;
}

.section-content .row > [class*='col-'] > div:last-child {
    flex: 1;
}

#directionsTable {
    table-layout: fixed;
}

#directionsTable th:nth-child(1),
#directionsTable td:nth-child(1) {
    width: 25%;
    max-width: 25%;
}

#directionsTable th:nth-child(2),
#directionsTable td:nth-child(2) {
    width: 18%;
    max-width: 18%;
}

#directionsTable th:nth-child(3),
#directionsTable td:nth-child(3) {
    width: 18%;
    max-width: 18%;
}

#directionsTable th:nth-child(4),
#directionsTable td:nth-child(4) {
    width: 20%;
    max-width: 20%;
}

#directionsTable th:nth-child(5),
#directionsTable td:nth-child(5) {
    width: 19%;
    max-width: 19%;
}

.table {
    width: 100% !important;
    margin-bottom: 0;
    table-layout: fixed;
}

.table th,
.table td {
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    padding: 8px;
    vertical-align: middle;
}

.table th:nth-child(1),
.table td:nth-child(1) {
    width: 25%;
    max-width: 25%;
}

.table th:nth-child(2),
.table td:nth-child(2) {
    width: 15%;
    max-width: 15%;
}

.table th:nth-child(3),
.table td:nth-child(3) {
    width: 20%;
    max-width: 20%;
}

.table th:nth-child(4),
.table td:nth-child(4) {
    width: 20%;
    max-width: 20%;
}

.table th:nth-child(5),
.table td:nth-child(5) {
    width: 20%;
    max-width: 20%;
}

.loading {
    display: none;
    text-align: center;
    padding: 40px;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.no-results-message {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
    font-size: 1rem;
}

.no-results-message i {
    font-size: 3rem;
    color: #dee2e6;
    margin-bottom: 15px;
    display: block;
}

.no-results-message p {
    margin: 0;
    font-weight: 500;
}
</style>
{% endblock %}

{% block body %}
<!-- Section Filtres Horizontale -->
<div class="filter-card mb-4">
    <h5 class="mb-3"><i class="fa fa-filter"></i> Filtres</h5>
    <form id="filtersForm">
        <div class="row">
            <!-- Colonne 9 pour les champs -->
            <div class="col-md-9">
                <!-- Première ligne des champs -->
                <div class="row mb-3">
                    <!-- Direction -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Direction</label>
                            <select class="form-select" name="direction_id" id="directionSelect">
                                <option value="">Toutes</option>
                            </select>
                        </div>
                    </div>

                    <!-- Service -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Service</label>
                            <select class="form-select" name="service_id" id="serviceSelect">
                                <option value="">Tous</option>
                            </select>
                        </div>
                    </div>

                    <!-- Statut -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Statut</label>
                            <select class="form-select" name="statut_id" id="statutSelect">
                                <option value="">Tous</option>
                            </select>
                        </div>
                    </div>

                    <!-- Type de fonds -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Type de financement</label>
                            <select class="form-select" name="type_fonds_id" id="typeFondsSelect">
                                <option value="">Tous</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Deuxième ligne des champs -->
                <div class="row">
                    <!-- Lieu -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Lieu</label>
                            <input type="text" class="form-control" name="lieu" placeholder="Ville, pays...">
                        </div>
                    </div>

                    <!-- Période -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Période</label>
                            <select class="form-select mb-2" name="periode_type" id="periodeType">
                                <option value="">Toutes les périodes</option>
                                <option value="mois">Ce mois</option>
                                <option value="trimestre">Ce trimestre</option>
                                <option value="semestre1">1er semestre</option>
                                <option value="semestre2">2ème semestre</option>
                                <option value="annee">Cette année</option>
                                <option value="personnalisee">Période personnalisée</option>
                            </select>
                            <div class="row" id="dateRangeContainer" style="display: none;">
                                <div class="col-6 mb-2">
                                    <label class="form-label small">Date début</label>
                                    <input type="date" class="form-control" name="date_debut" id="dateDebut" placeholder="Date début">
                                </div>
                                <div class="col-6 mb-2">
                                    <label class="form-label small">Date fin</label>
                                    <input type="date" class="form-control" name="date_fin" id="dateFin" placeholder="Date fin">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Année -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Année</label>
                            <select class="form-select" name="annee" id="anneeSelect">
                                <option value="{{ currentYear }}" selected>{{ currentYear }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Type d'activité -->
                    <div class="col-md-3">
                        <div class="filter-section">
                            <label>Type d'activité</label>
                            <select class="form-select" name="type_activite" id="typeActiviteSelect">
                                <option value="all">Tous</option>
                                <option value="formation">Formations</option>
                                <option value="mission">Missions</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne 3 pour les boutons avec bordure -->
            <div class="col-md-3">
                <div class="filter-section d-flex align-items-end h-100" style="border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; background: #f8f9fa;">
                    <div class="w-100">
                        <button type="submit" class="btn btn-primary btn-sm w-100 mb-2">
                            <i class="fa fa-search"></i> Appliquer les filtres
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm w-100" id="resetFilters">
                            <i class="fa fa-refresh"></i> Réinitialiser
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Section Résultats -->
<div class="row">
    <div class="col-12">
        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Génération du rapport en cours...</p>
        </div>

        <div class="results-section" id="resultsContainer">
            <!-- 1. Résumé Global -->
            <div class="section-card" id="resumeSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-chart-pie"></i> Résumé Global</h5>
                </div>
                <div class="section-content">
                    <div class="row">
                        <!-- Colonne Formations -->
                        <div class="col-md-6">
                            <h6 class="text-center mb-3"><i class="fa fa-graduation-cap text-primary"></i> Formations</h6>
                            <div id="resumeStatsFormations">
                                <!-- Stats formations will be populated by JS -->
                            </div>
                        </div>
                        
                        <!-- Colonne Missions -->
                        <div class="col-md-6">
                            <h6 class="text-center mb-3"><i class="fa fa-plane text-danger"></i> Missions</h6>
                            <div id="resumeStatsMissions">
                                <!-- Stats missions will be populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Détails Formations -->
            <div class="section-card" id="formationsSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-graduation-cap"></i> Détails Formations</h5>
                </div>
                <div class="section-content">
                    <div class="row">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-striped w-100" id="reportingFormationsTable">
                                    <thead>
                                        <tr>
                                            <th>Titre</th>
                                            <th>Direction</th>
                                            <th>Dates</th>
                                            <th>Statut</th>
                                            <th>Budget</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Détails Missions -->
            <div class="section-card" id="missionsSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-plane"></i> Détails Missions</h5>
                </div>
                <div class="section-content">
                    <div class="row">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-striped w-100" id="reportingMissionsTable">
                                    <thead>
                                        <tr>
                                            <th>Titre</th>
                                            <th>Direction</th>
                                            <th>Dates</th>
                                            <th>Statut</th>
                                            <th>Budget</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="chart-container">
                                <canvas id="missionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Par Direction -->
            <div class="section-card" id="directionsSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-building"></i> Analyse par Direction</h5>
                </div>
                <div class="section-content">
                    <div class="row">
                        <!-- Formations par Direction -->
                        <div class="col-md-6">
                            <h6 class="text-center mb-3"><i class="fa fa-graduation-cap text-primary"></i> Formations par Direction</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm" id="directionsTableFormations">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Direction</th>
                                            <th class="text-center">Total</th>
                                            <th class="text-center">Exécutées</th>
                                            <th class="text-center">Taux</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Missions par Direction -->
                        <div class="col-md-6">
                            <h6 class="text-center mb-3"><i class="fa fa-plane text-danger"></i> Missions par Direction</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm" id="directionsTableMissions">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Direction</th>
                                            <th class="text-center">Total</th>
                                            <th class="text-center">Exécutées</th>
                                            <th class="text-center">Taux</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Évolution temporelle -->
            <div class="section-card" id="evolutionSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-line-chart"></i> Évolution Temporelle</h5>
                </div>
                <div class="section-content">
                    <div class="row">
                        <!-- Graphique Formations -->
                        <div class="col-md-6">
                            <h6 class="text-center mb-3"><i class="fa fa-graduation-cap text-primary"></i> Évolution Formations</h6>
                            <div class="chart-container" id="evolutionChartContainerFormations">
                                <canvas id="evolutionChartFormations"></canvas>
                            </div>
                        </div>
                        
                        <!-- Graphique Missions -->
                        <div class="col-md-6">
                            <h6 class="text-center mb-3"><i class="fa fa-plane text-danger"></i> Évolution Missions</h6>
                            <div class="chart-container" id="evolutionChartContainerMissions">
                                <canvas id="evolutionChartMissions"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. Indicateurs Clés -->
            <div class="section-card" id="indicateursSection">
                <div class="section-header">
                    <h5 class="mb-0"><i class="fa fa-dashboard"></i> Indicateurs Clés</h5>
                </div>
                <div class="section-content">
                    <div class="row">
                        <!-- Indicateurs Formations -->
                        <div class="col-md-6">
                            <h6 class="text-center mb-3"><i class="fa fa-graduation-cap text-primary"></i> Indicateurs Formations</h6>
                            <div class="stats-grid" id="indicateursStatsFormations">
                                <!-- Stats formations will be populated by JS -->
                            </div>
                        </div>
                        
                        <!-- Indicateurs Missions -->
                        <div class="col-md-6">
                            <h6 class="text-center mb-3"><i class="fa fa-plane text-danger"></i> Indicateurs Missions</h6>
                            <div class="stats-grid" id="indicateursStatsMissions">
                                <!-- Stats missions will be populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export -->
            <div class="export-buttons">
                <button type="button" class="btn btn-danger me-2" id="exportPdf">
                    <i class="fa fa-file-pdf-o"></i> Exporter en PDF
                </button>
                <button type="button" class="btn btn-success me-2" id="exportExcel">
                    <i class="fa fa-file-excel-o"></i> Exporter en Excel
                </button>
                <button type="button" class="btn btn-info" id="print">
                    <i class="fa fa-print"></i> Imprimer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filtersForm = document.getElementById('filtersForm');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultsContainer = document.getElementById('resultsContainer');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const exportPdfBtn = document.getElementById('exportPdf');
    const periodeTypeSelect = document.getElementById('periodeType');
    const dateRangeContainer = document.getElementById('dateRangeContainer');
    const anneeSelect = document.getElementById('anneeSelect');

    let currentData = null;
    let evolutionChartInstanceFormations = null; // Stocker l'instance du graphique formations
    let evolutionChartInstanceMissions = null; // Stocker l'instance du graphique missions

    // Charger les données des filtres au démarrage
    loadFiltersData();
    
    // Ne pas définir de dates par défaut - laisser les champs vides pour "Toutes les périodes"
    // setDefaultDates(); // Commenté pour permettre l'affichage de toutes les données
    
    // Charger les données par défaut (toutes les données de l'année, sans filtre de dates)
    loadData();

    // Gestion du formulaire de filtres
    filtersForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loadData();
    });

    // Réinitialisation des filtres
    resetFiltersBtn.addEventListener('click', function() {
        filtersForm.reset();
        filtersForm.querySelector('[name="annee"]').value = '{{ currentYear }}';
        if (periodeTypeSelect) {
            periodeTypeSelect.value = '';
            dateRangeContainer.style.display = 'none';
        }
        setDefaultDates(); // Remettre les dates par défaut
        resultsContainer.style.display = 'none';
    });

    // Export PDF
    exportPdfBtn.addEventListener('click', function() {
        if (!currentData) return;
        
        const formData = new FormData(filtersForm);
        
        fetch('{{ path('app_reporting_export_pdf') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rapport_' + new Date().toISOString().slice(0, 10) + '.pdf';
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Erreur export PDF:', error);
            showToast('Erreur lors de l\'export PDF', 'error');
        });
    });

    // Fonction pour définir les dates par défaut
    function setDefaultDates() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        
        // Premier jour du mois actuel
        const firstDay = new Date(year, month, 1);
        const dateDebut = firstDay.toISOString().split('T')[0];
        
        // Dernier jour du mois actuel
        const lastDay = new Date(year, month + 1, 0);
        const dateFin = lastDay.toISOString().split('T')[0];
        
        // Définir les valeurs par défaut
        document.getElementById('dateDebut').value = dateDebut;
        document.getElementById('dateFin').value = dateFin;
    }

    // Fonction pour calculer les dates selon la période sélectionnée
    function calculatePeriodDates(periodType) {
        const now = new Date();
        const year = parseInt(document.getElementById('anneeSelect').value) || now.getFullYear();
        let dateDebut, dateFin;

        switch(periodType) {
            case 'mois':
                // Ce mois
                const month = now.getMonth();
                dateDebut = new Date(year, month, 1).toISOString().split('T')[0];
                dateFin = new Date(year, month + 1, 0).toISOString().split('T')[0];
                break;
            
            case 'trimestre':
                // Ce trimestre
                const currentQuarter = Math.floor(now.getMonth() / 3);
                const quarterStartMonth = currentQuarter * 3;
                dateDebut = new Date(year, quarterStartMonth, 1).toISOString().split('T')[0];
                dateFin = new Date(year, quarterStartMonth + 3, 0).toISOString().split('T')[0];
                break;
            
            case 'semestre1':
                // 1er semestre (janvier à juin)
                dateDebut = new Date(year, 0, 1).toISOString().split('T')[0];
                dateFin = new Date(year, 5, 30).toISOString().split('T')[0];
                break;
            
            case 'semestre2':
                // 2ème semestre (juillet à décembre)
                dateDebut = new Date(year, 6, 1).toISOString().split('T')[0];
                dateFin = new Date(year, 11, 31).toISOString().split('T')[0];
                break;
            
            case 'annee':
                // Cette année
                dateDebut = new Date(year, 0, 1).toISOString().split('T')[0];
                dateFin = new Date(year, 11, 31).toISOString().split('T')[0];
                break;
            
            default:
                return;
        }

        document.getElementById('dateDebut').value = dateDebut;
        document.getElementById('dateFin').value = dateFin;
    }

    // Gestionnaire d'événement pour le filtre de période
    if (periodeTypeSelect) {
        periodeTypeSelect.addEventListener('change', function() {
            const selectedPeriod = this.value;
            
            if (selectedPeriod === 'personnalisee') {
                // Afficher les champs de date pour la période personnalisée
                dateRangeContainer.style.display = 'block';
            } else if (selectedPeriod === '') {
                // Toutes les périodes : masquer les champs et vider les dates
                dateRangeContainer.style.display = 'none';
                document.getElementById('dateDebut').value = '';
                document.getElementById('dateFin').value = '';
            } else {
                // Option prédéfinie : calculer et remplir les dates, masquer les champs
                calculatePeriodDates(selectedPeriod);
                dateRangeContainer.style.display = 'none';
            }
        });
    }

    // Recalculer les dates quand l'année change si une période prédéfinie est sélectionnée
    if (anneeSelect && periodeTypeSelect) {
        anneeSelect.addEventListener('change', function() {
            const selectedPeriod = periodeTypeSelect.value;
            if (selectedPeriod && selectedPeriod !== '' && selectedPeriod !== 'personnalisee') {
                calculatePeriodDates(selectedPeriod);
            }
        });
    }

    // Fonction pour charger les données des filtres
    function loadFiltersData() {
        fetch('{{ path('app_reporting_api_filters') }}')
        .then(response => response.json())
        .then(data => {
            console.log('Données reçues:', data);
            
            // Remplir les directions
            const directionSelect = document.getElementById('directionSelect');
            directionSelect.innerHTML = '<option value="">Toutes</option>';
            if (data.directions && data.directions.length > 0) {
                data.directions.forEach(direction => {
                    const option = document.createElement('option');
                    option.value = direction.id;
                    option.textContent = direction.libelle;
                    directionSelect.appendChild(option);
                });
            }

            // Remplir les services
            const serviceSelect = document.getElementById('serviceSelect');
            serviceSelect.innerHTML = '<option value="">Tous</option>';
            if (data.services && data.services.length > 0) {
                data.services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = service.libelle;
                    serviceSelect.appendChild(option);
                });
            }

            // Remplir les statuts
            const statutSelect = document.getElementById('statutSelect');
            statutSelect.innerHTML = '<option value="">Tous</option>';
            if (data.statuts && data.statuts.length > 0) {
                data.statuts.forEach(statut => {
                    const option = document.createElement('option');
                    option.value = statut.id;
                    option.textContent = statut.libelle;
                    statutSelect.appendChild(option);
                });
            }

            // Remplir les types de fonds
            const typeFondsSelect = document.getElementById('typeFondsSelect');
            typeFondsSelect.innerHTML = '<option value="">Tous</option>';
            if (data.typeFonds && data.typeFonds.length > 0) {
                data.typeFonds.forEach(fonds => {
                    const option = document.createElement('option');
                    option.value = fonds.id;
                    option.textContent = fonds.libelle;
                    typeFondsSelect.appendChild(option);
                });
            }

            // Remplir les années
            const anneeSelect = document.getElementById('anneeSelect');
            anneeSelect.innerHTML = '';
            if (data.years && data.years.length > 0) {
                data.years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    anneeSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des filtres:', error);
        });
    }

    // Fonction pour charger les données
    function loadData() {
        loadingIndicator.style.display = 'block';
        resultsContainer.style.display = 'none';

        // Nettoyer les dates si "Toutes les périodes" est sélectionné
        clearDatesIfAllPeriods();
        
        const formData = new FormData(filtersForm);
        
        // Ne pas ajouter de filtre de mois par défaut
        // Les données seront filtrées uniquement par les filtres sélectionnés par l'utilisateur
        
        // Supprimer les dates du FormData si "Toutes les périodes" est sélectionné
        const periodeType = periodeTypeSelect ? periodeTypeSelect.value : '';
        if (periodeType === '' || periodeType === null) {
            formData.delete('date_debut');
            formData.delete('date_fin');
            formData.delete('mois'); // S'assurer qu'aucun mois n'est envoyé
        }

        // Charger les données section par section
        Promise.all([
            loadResumeData(formData),
            loadFormationsData(formData),
            loadMissionsData(formData),
            loadDirectionsData(formData),
            loadPeriodesData(formData),
            loadStatutsData(formData),
            loadIndicateursData(formData)
        ]).then(() => {
            loadingIndicator.style.display = 'none';
            resultsContainer.style.display = 'block';
        }).catch(error => {
            console.error('Erreur lors du chargement des données:', error);
            loadingIndicator.style.display = 'none';
            resultsContainer.style.display = 'block'; // Afficher le conteneur même en cas d'erreur
            showToast('Erreur lors du chargement des données. Veuillez réessayer.', 'error');
        });
    }

    // Fonction pour nettoyer les dates si "Toutes les périodes" est sélectionné
    function clearDatesIfAllPeriods() {
        const periodeType = periodeTypeSelect ? periodeTypeSelect.value : '';
        if (periodeType === '' || periodeType === null) {
            // Vider les champs de date si "Toutes les périodes" est sélectionné
            const dateDebut = document.getElementById('dateDebut');
            const dateFin = document.getElementById('dateFin');
            if (dateDebut) dateDebut.value = '';
            if (dateFin) dateFin.value = '';
        }
    }

    // Fonction pour charger le résumé
    function loadResumeData(formData) {
        return fetch('{{ path('app_reporting_data_resume') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Résumé global reçu:', data);
            populateResumeGlobal(data);
        })
        .catch(error => {
            console.error('Erreur lors du chargement du résumé:', error);
        });
    }

    // Fonction pour charger les formations
    function loadFormationsData(formData) {
        return fetch('{{ path('app_reporting_data_formations') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur HTTP: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Formations reçues:', data);
            populateFormations(data);
        })
        .catch(error => {
            console.error('Erreur lors du chargement des formations:', error);
        });
    }

    // Fonction pour charger les missions
    function loadMissionsData(formData) {
        return fetch('{{ path('app_reporting_data_missions') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur HTTP: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Missions reçues:', data);
            populateMissions(data);
        })
        .catch(error => {
            console.error('Erreur lors du chargement des missions:', error);
        });
    }

    // Fonction pour charger les données par direction
    function loadDirectionsData(formData) {
        return fetch('{{ path('app_reporting_data_directions') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            populateDirections(data);
        });
    }

    // Fonction pour charger les données par période
    function loadPeriodesData(formData) {
        return fetch('{{ path('app_reporting_data_periodes') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            populateEvolution(data);
        });
    }

    // Fonction pour charger les données de statuts
    function loadStatutsData(formData) {
        return fetch('{{ path('app_reporting_data_statuts') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // populateStatuts(data); // À implémenter si nécessaire
        });
    }

    // Fonction pour charger les indicateurs
    function loadIndicateursData(formData) {
        return fetch('{{ path('app_reporting_data_indicateurs') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            populateIndicateurs(data);
        });
    }



    function populateResumeGlobal(resume) {
        const containerFormations = document.getElementById('resumeStatsFormations');
        const containerMissions = document.getElementById('resumeStatsMissions');
        
        // Données formations
        const formations = resume.formations || {};
        const totalFormations = parseInt(formations.total) || 0;
        const formationsRealisees = parseInt(formations.realisees) || 0;
        const budgetPrevuFormations = parseFloat(formations.budget_prevu) || 0;
        const budgetReelFormations = parseFloat(formations.budget_reel) || 0;
        const statutsFormations = formations.statuts || [];
        
        // Données missions
        const missions = resume.missions || {};
        const totalMissions = parseInt(missions.total) || 0;
        const missionsRealisees = parseInt(missions.realisees) || 0;
        const budgetPrevuMissions = parseFloat(missions.budget_prevu) || 0;
        const budgetReelMissions = parseFloat(missions.budget_reel) || 0;
        const statutsMissions = missions.statuts || [];
        
        // Vérifier s'il y a des données formations
        const hasDataFormations = totalFormations > 0 || (budgetPrevuFormations > 0 || budgetReelFormations > 0);
        
        if (!hasDataFormations) {
            containerFormations.innerHTML = `
                <div class="no-results-message">
                    <i class="fa fa-info-circle"></i>
                    <p>Aucune formation disponible</p>
                </div>
            `;
        } else {
            // Calcul du taux d'exécution formations
            let tauxExecutionFormations = 0;
            if (totalFormations > 0) {
                tauxExecutionFormations = (formationsRealisees / totalFormations) * 100;
                if (tauxExecutionFormations > 100) tauxExecutionFormations = 100;
            }
            tauxExecutionFormations = parseFloat(tauxExecutionFormations.toFixed(1));
            
            // Construire les lignes du tableau pour chaque statut (formations)
            let statutsRowsFormations = '';
            if (statutsFormations.length > 0) {
                statutsFormations.forEach(statut => {
                    statutsRowsFormations += `
                        <tr>
                            <td>${statut.libelle}</td>
                            <td class="text-end"><strong>${statut.count || 0}</strong></td>
                        </tr>
                    `;
                });
            } else {
                statutsRowsFormations = '<tr><td colspan="2" class="text-center text-muted">Aucun statut disponible</td></tr>';
            }

            containerFormations.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Indicateur</th>
                                <th class="text-end">Valeur</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${statutsRowsFormations}
                            <tr class="table-info">
                                <td><strong>Total</strong></td>
                                <td class="text-end"><strong>${totalFormations}</strong></td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>Réalisées</strong></td>
                                <td class="text-end"><strong>${formationsRealisees}</strong></td>
                            </tr>
                            <tr>
                                <td>Budget prévu</td>
                                <td class="text-end">${new Intl.NumberFormat('fr-FR').format(budgetPrevuFormations)} FCFA</td>
                            </tr>
                            <tr>
                                <td>Budget réalisé</td>
                                <td class="text-end">${new Intl.NumberFormat('fr-FR').format(budgetReelFormations)} FCFA</td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>Taux d'exécution</strong></td>
                                <td class="text-end"><strong>${tauxExecutionFormations}%</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Vérifier s'il y a des données missions
        const hasDataMissions = totalMissions > 0 || (budgetPrevuMissions > 0 || budgetReelMissions > 0);
        
        if (!hasDataMissions) {
            containerMissions.innerHTML = `
                <div class="no-results-message">
                    <i class="fa fa-info-circle"></i>
                    <p>Aucune mission disponible</p>
                </div>
            `;
        } else {
            // Calcul du taux d'exécution missions
            let tauxExecutionMissions = 0;
            if (totalMissions > 0) {
                tauxExecutionMissions = (missionsRealisees / totalMissions) * 100;
                if (tauxExecutionMissions > 100) tauxExecutionMissions = 100;
            }
            tauxExecutionMissions = parseFloat(tauxExecutionMissions.toFixed(1));
            
            // Construire les lignes du tableau pour chaque statut (missions)
            let statutsRowsMissions = '';
            if (statutsMissions.length > 0) {
                statutsMissions.forEach(statut => {
                    statutsRowsMissions += `
                        <tr>
                            <td>${statut.libelle}</td>
                            <td class="text-end"><strong>${statut.count || 0}</strong></td>
                        </tr>
                    `;
                });
            } else {
                statutsRowsMissions = '<tr><td colspan="2" class="text-center text-muted">Aucun statut disponible</td></tr>';
            }

            containerMissions.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Indicateur</th>
                                <th class="text-end">Valeur</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${statutsRowsMissions}
                            <tr class="table-info">
                                <td><strong>Total</strong></td>
                                <td class="text-end"><strong>${totalMissions}</strong></td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>Réalisées</strong></td>
                                <td class="text-end"><strong>${missionsRealisees}</strong></td>
                            </tr>
                            <tr>
                                <td>Budget prévu</td>
                                <td class="text-end">${new Intl.NumberFormat('fr-FR').format(budgetPrevuMissions)} FCFA</td>
                            </tr>
                            <tr>
                                <td>Budget réalisé</td>
                                <td class="text-end">${new Intl.NumberFormat('fr-FR').format(budgetReelMissions)} FCFA</td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>Taux d'exécution</strong></td>
                                <td class="text-end"><strong>${tauxExecutionMissions}%</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    function populateFormations(formations) {
        const tbody = document.querySelector('#reportingFormationsTable tbody');
        let html = '';
        
        console.log('Formations data:', formations);
        
        // Vérification stricte : s'assurer que formations existe et a une liste non vide
        if (formations && formations.liste && Array.isArray(formations.liste) && formations.liste.length > 0) {
            formations.liste.forEach(formation => {
                console.log('Formation:', formation);
                
                 // Gestion des dates (maintenant des chaînes de caractères)
                let dateDebut = '-';
                let dateFin = '-';
                
                if (formation.datePrevueDebut) {
                    try {
                        dateDebut = new Date(formation.datePrevueDebut).toLocaleDateString('fr-FR');
                    } catch (e) {
                        console.error('Erreur date début:', e);
                        dateDebut = '-';
                    }
                }
                
                if (formation.datePrevueFin) {
                    try {
                        dateFin = new Date(formation.datePrevueFin).toLocaleDateString('fr-FR');
                    } catch (e) {
                        console.error('Erreur date fin:', e);
                        dateFin = '-';
                    }
                }
                
                const dates = `${dateDebut} - ${dateFin}`;
                const budget = formation.budgetPrevu ? new Intl.NumberFormat('fr-FR').format(formation.budgetPrevu) + ' FCFA' : '-';
                
                html += `
                    <tr>
                        <td>${formation.titre || '-'}</td>
                        <td>${formation.direction ? formation.direction.libelle : '-'}</td>
                        <td>${dates}</td>
                        <td><span class="badge bg-${formation.statutActivite ? formation.statutActivite.couleur : 'secondary'}">${formation.statutActivite ? formation.statutActivite.libelle : '-'}</span></td>
                        <td>${budget}</td>
                    </tr>
                `;
            });
        } else {
            html = '<tr><td colspan="5" class="text-center"><i class="fa fa-info-circle text-muted me-2"></i><span class="text-muted">Aucune formation trouvée pour les critères sélectionnés</span></td></tr>';
        }
        
        tbody.innerHTML = html;
    }

    function populateMissions(missions) {
        const tbody = document.querySelector('#reportingMissionsTable tbody');
        let html = '';
        
        console.log('Missions data:', missions);
        
        // Vérification stricte : s'assurer que missions existe et a une liste non vide
        if (missions && missions.liste && Array.isArray(missions.liste) && missions.liste.length > 0) {
            missions.liste.forEach(mission => {
                console.log('Mission:', mission);
                
                // Gestion des dates (maintenant des chaînes de caractères)
                let dateDebut = '-';
                let dateFin = '-';
                
                if (mission.datePrevueDebut) {
                    try {
                        dateDebut = new Date(mission.datePrevueDebut).toLocaleDateString('fr-FR');
                    } catch (e) {
                        console.error('Erreur date début:', e);
                        dateDebut = '-';
                    }
                }
                
                if (mission.datePrevueFin) {
                    try {
                        dateFin = new Date(mission.datePrevueFin).toLocaleDateString('fr-FR');
                    } catch (e) {
                        console.error('Erreur date fin:', e);
                        dateFin = '-';
                    }
                }
                
                const dates = `${dateDebut} - ${dateFin}`;
                const budget = mission.budgetPrevu ? new Intl.NumberFormat('fr-FR').format(mission.budgetPrevu) + ' FCFA' : '-';
                
                html += `
                    <tr>
                        <td>${mission.titre || '-'}</td>
                        <td>${mission.direction ? mission.direction.libelle : '-'}</td>
                        <td>${dates}</td>
                        <td><span class="badge bg-${mission.statutActivite ? mission.statutActivite.couleur : 'secondary'}">${mission.statutActivite ? mission.statutActivite.libelle : '-'}</span></td>
                        <td>${budget}</td>
                    </tr>
                `;
            });
        } else {
            html = '<tr><td colspan="5" class="text-center"><i class="fa fa-info-circle text-muted me-2"></i><span class="text-muted">Aucune mission trouvée pour les critères sélectionnés</span></td></tr>';
        }
        
        tbody.innerHTML = html;
    }

    function populateDirections(parDirection) {
        const tbodyFormations = document.querySelector('#directionsTableFormations tbody');
        const tbodyMissions = document.querySelector('#directionsTableMissions tbody');

        // Vérification stricte : s'assurer que parDirection existe
        if (!parDirection || (!parDirection.formations && !parDirection.missions)) {
            tbodyFormations.innerHTML = '<tr><td colspan="4" class="text-center"><i class="fa fa-info-circle text-muted me-2"></i><span class="text-muted">Aucune donnée disponible</span></td></tr>';
            tbodyMissions.innerHTML = '<tr><td colspan="4" class="text-center"><i class="fa fa-info-circle text-muted me-2"></i><span class="text-muted">Aucune donnée disponible</span></td></tr>';
            return;
        }

        // Traiter les FORMATIONS par direction
        let htmlFormations = '';
        if (parDirection.formations && Array.isArray(parDirection.formations) && parDirection.formations.length > 0) {
            parDirection.formations.forEach(item => {
                const directionName = item.direction_name || 'Non définie';
                const total = parseInt(item.total) || 0;
                const executed = parseInt(item.executed) || 0;
                
                // Calcul du taux d'exécution
                let tauxExecution = 0;
                if (total > 0) {
                    tauxExecution = (executed / total * 100);
                    if (tauxExecution > 100) tauxExecution = 100;
                }
                tauxExecution = parseFloat(tauxExecution.toFixed(1));
                
                // Déterminer la couleur du badge
                let badgeColor = 'secondary';
                if (tauxExecution >= 70) {
                    badgeColor = 'success';
                } else if (tauxExecution >= 50) {
                    badgeColor = 'warning';
                } else if (tauxExecution > 0) {
                    badgeColor = 'danger';
                }
                
                htmlFormations += `
                    <tr>
                        <td>${directionName}</td>
                        <td class="text-center">${total}</td>
                        <td class="text-center">${executed}</td>
                        <td class="text-center"><span class="badge bg-${badgeColor}">${tauxExecution}%</span></td>
                    </tr>
                `;
            });
        } else {
            htmlFormations = '<tr><td colspan="4" class="text-center text-muted">Aucune formation disponible</td></tr>';
        }
        
        // Traiter les MISSIONS par direction
        let htmlMissions = '';
        if (parDirection.missions && Array.isArray(parDirection.missions) && parDirection.missions.length > 0) {
            parDirection.missions.forEach(item => {
                const directionName = item.direction_name || 'Non définie';
                const total = parseInt(item.total) || 0;
                const executed = parseInt(item.executed) || 0;
                
                // Calcul du taux d'exécution
                let tauxExecution = 0;
                if (total > 0) {
                    tauxExecution = (executed / total * 100);
                    if (tauxExecution > 100) tauxExecution = 100;
                }
                tauxExecution = parseFloat(tauxExecution.toFixed(1));
                
                // Déterminer la couleur du badge
                let badgeColor = 'secondary';
                if (tauxExecution >= 70) {
                    badgeColor = 'success';
                } else if (tauxExecution >= 50) {
                    badgeColor = 'warning';
                } else if (tauxExecution > 0) {
                    badgeColor = 'danger';
                }
                
                htmlMissions += `
                    <tr>
                        <td>${directionName}</td>
                        <td class="text-center">${total}</td>
                        <td class="text-center">${executed}</td>
                        <td class="text-center"><span class="badge bg-${badgeColor}">${tauxExecution}%</span></td>
                    </tr>
                `;
            });
        } else {
            htmlMissions = '<tr><td colspan="4" class="text-center text-muted">Aucune mission disponible</td></tr>';
        }

        tbodyFormations.innerHTML = htmlFormations;
        tbodyMissions.innerHTML = htmlMissions;
    }

    function populateEvolution(parPeriode) {
        const chartContainerFormations = document.getElementById('evolutionChartContainerFormations');
        const chartContainerMissions = document.getElementById('evolutionChartContainerMissions');
        
        // Détruire les graphiques existants s'ils existent
        if (evolutionChartInstanceFormations) {
            evolutionChartInstanceFormations.destroy();
            evolutionChartInstanceFormations = null;
        }
        if (evolutionChartInstanceMissions) {
            evolutionChartInstanceMissions.destroy();
            evolutionChartInstanceMissions = null;
        }
        
        // Vérifier s'il y a des données formations
        const formationsData = Object.values(parPeriode.formations || {});
        const hasDataFormations = formationsData.some(v => v > 0);
        
        if (!hasDataFormations) {
            chartContainerFormations.innerHTML = `
                <div class="no-results-message">
                    <i class="fa fa-line-chart"></i>
                    <p>Aucune donnée disponible</p>
                </div>
            `;
        } else {
            // Réinitialiser le canvas formations
            chartContainerFormations.innerHTML = '<canvas id="evolutionChartFormations"></canvas>';
            
            const ctxFormations = document.getElementById('evolutionChartFormations').getContext('2d');
            
            // Créer le graphique formations
            evolutionChartInstanceFormations = new Chart(ctxFormations, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
                    datasets: [{
                        label: 'Formations',
                        data: formationsData,
                        borderColor: 'rgb(0, 123, 255)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Vérifier s'il y a des données missions
        const missionsData = Object.values(parPeriode.missions || {});
        const hasDataMissions = missionsData.some(v => v > 0);
        
        if (!hasDataMissions) {
            chartContainerMissions.innerHTML = `
                <div class="no-results-message">
                    <i class="fa fa-line-chart"></i>
                    <p>Aucune donnée disponible</p>
                </div>
            `;
        } else {
            // Réinitialiser le canvas missions
            chartContainerMissions.innerHTML = '<canvas id="evolutionChartMissions"></canvas>';
            
            const ctxMissions = document.getElementById('evolutionChartMissions').getContext('2d');
            
            // Créer le graphique missions
            evolutionChartInstanceMissions = new Chart(ctxMissions, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
                    datasets: [{
                        label: 'Missions',
                        data: missionsData,
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
    }

    function populateIndicateurs(indicateurs) {
        const containerFormations = document.getElementById('indicateursStatsFormations');
        const containerMissions = document.getElementById('indicateursStatsMissions');
        
        // Vérification stricte : s'assurer que indicateurs existe
        if (!indicateurs || (!indicateurs.formations && !indicateurs.missions)) {
            containerFormations.innerHTML = `<div class="no-results-message"><i class="fa fa-dashboard"></i><p>Aucun indicateur disponible</p></div>`;
            containerMissions.innerHTML = `<div class="no-results-message"><i class="fa fa-dashboard"></i><p>Aucun indicateur disponible</p></div>`;
            return;
        }
        
        // Traiter les FORMATIONS
        const formations = indicateurs.formations || {};
        const budgetPrevuF = parseFloat(formations.budget_prevu) || 0;
        const budgetReelF = parseFloat(formations.budget_reel) || 0;
        const hasDataF = budgetPrevuF > 0 || budgetReelF > 0;
        
        if (!hasDataF) {
            containerFormations.innerHTML = `<div class="no-results-message"><i class="fa fa-dashboard"></i><p>Aucune donnée disponible</p></div>`;
        } else {
            const ecartF = formations.ecart_budget || 0;
            const isProfitF = ecartF < 0;
            const ecartClassF = isProfitF ? 'positive' : 'negative';
            const ecartItemClassF = isProfitF ? 'stat-success' : 'stat-danger';
            
            const tauxExecutionF = formations.taux_execution_budget || 0;
            let tauxItemClassF = 'stat-info';
            let tauxIconF = 'fa-percent';
            if (tauxExecutionF >= 90) {
                tauxItemClassF = 'stat-success';
                tauxIconF = 'fa-check-circle';
            } else if (tauxExecutionF >= 70) {
                tauxItemClassF = 'stat-warning';
                tauxIconF = 'fa-exclamation-circle';
            } else {
                tauxItemClassF = 'stat-danger';
                tauxIconF = 'fa-times-circle';
            }
            
            const budgetPrevuFormattedF = new Intl.NumberFormat('fr-FR').format(budgetPrevuF);
            const budgetReelFormattedF = new Intl.NumberFormat('fr-FR').format(budgetReelF);
            const ecartAbsF = new Intl.NumberFormat('fr-FR').format(Math.abs(ecartF));
            
            containerFormations.innerHTML = `
                <div class="stat-item ${tauxItemClassF}">
                    <div class="stat-item-header">
                        <p class="stat-item-title">Taux d'exécution</p>
                        <div class="stat-item-icon">
                            <i class="fa ${tauxIconF}"></i>
                        </div>
                    </div>
                    <div class="stat-number">${tauxExecutionF.toFixed(1)}%</div>
                </div>
                
                <div class="stat-item stat-primary">
                    <div class="stat-item-header">
                        <p class="stat-item-title">Budget prévu</p>
                        <div class="stat-item-icon">
                            <i class="fa fa-calendar-check"></i>
                        </div>
                    </div>
                    <div class="stat-number">${budgetPrevuFormattedF} FCFA</div>
                </div>
                
                <div class="stat-item stat-info">
                    <div class="stat-item-header">
                        <p class="stat-item-title">Budget réel</p>
                        <div class="stat-item-icon">
                            <i class="fa fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="stat-number">${budgetReelFormattedF} FCFA</div>
                </div>
                
                <div class="stat-item ${ecartItemClassF}">
                    <div class="stat-item-header">
                        <p class="stat-item-title">Écart budgétaire</p>
                        <div class="stat-item-icon">
                            <i class="fa ${isProfitF ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                        </div>
                    </div>
                    <div class="stat-number">${ecartAbsF} FCFA</div>
                    <div class="stat-item-footer">
                        <div class="stat-item-change ${ecartClassF}">
                            <i class="fa ${isProfitF ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                            <span>${isProfitF ? 'Économie' : 'Dépassement'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Traiter les MISSIONS
        const missions = indicateurs.missions || {};
        const budgetPrevuM = parseFloat(missions.budget_prevu) || 0;
        const budgetReelM = parseFloat(missions.budget_reel) || 0;
        const hasDataM = budgetPrevuM > 0 || budgetReelM > 0;
        
        if (!hasDataM) {
            containerMissions.innerHTML = `<div class="no-results-message"><i class="fa fa-dashboard"></i><p>Aucune donnée disponible</p></div>`;
        } else {
            const ecartM = missions.ecart_budget || 0;
            const isProfitM = ecartM < 0;
            const ecartClassM = isProfitM ? 'positive' : 'negative';
            const ecartItemClassM = isProfitM ? 'stat-success' : 'stat-danger';
            
            const tauxExecutionM = missions.taux_execution_budget || 0;
            let tauxItemClassM = 'stat-info';
            let tauxIconM = 'fa-percent';
            if (tauxExecutionM >= 90) {
                tauxItemClassM = 'stat-success';
                tauxIconM = 'fa-check-circle';
            } else if (tauxExecutionM >= 70) {
                tauxItemClassM = 'stat-warning';
                tauxIconM = 'fa-exclamation-circle';
            } else {
                tauxItemClassM = 'stat-danger';
                tauxIconM = 'fa-times-circle';
            }
            
            const budgetPrevuFormattedM = new Intl.NumberFormat('fr-FR').format(budgetPrevuM);
            const budgetReelFormattedM = new Intl.NumberFormat('fr-FR').format(budgetReelM);
            const ecartAbsM = new Intl.NumberFormat('fr-FR').format(Math.abs(ecartM));
            
            containerMissions.innerHTML = `
                <div class="stat-item ${tauxItemClassM}">
                    <div class="stat-item-header">
                        <p class="stat-item-title">Taux d'exécution</p>
                        <div class="stat-item-icon">
                            <i class="fa ${tauxIconM}"></i>
                        </div>
                    </div>
                    <div class="stat-number">${tauxExecutionM.toFixed(1)}%</div>
                </div>
                
                <div class="stat-item stat-primary">
                    <div class="stat-item-header">
                        <p class="stat-item-title">Budget prévu</p>
                        <div class="stat-item-icon">
                            <i class="fa fa-calendar-check"></i>
                        </div>
                    </div>
                    <div class="stat-number">${budgetPrevuFormattedM} FCFA</div>
                </div>
                
                <div class="stat-item stat-info">
                    <div class="stat-item-header">
                        <p class="stat-item-title">Budget réel</p>
                        <div class="stat-item-icon">
                            <i class="fa fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="stat-number">${budgetReelFormattedM} FCFA</div>
                </div>
                
                <div class="stat-item ${ecartItemClassM}">
                    <div class="stat-item-header">
                        <p class="stat-item-title">Écart budgétaire</p>
                        <div class="stat-item-icon">
                            <i class="fa ${isProfitM ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                        </div>
                    </div>
                    <div class="stat-number">${ecartAbsM} FCFA</div>
                    <div class="stat-item-footer">
                        <div class="stat-item-change ${ecartClassM}">
                            <i class="fa ${isProfitM ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                            <span>${isProfitM ? 'Économie' : 'Dépassement'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    function showToast(message, type = 'info') {
        // Fonction pour afficher les notifications
        console.log(`${type.toUpperCase()}: ${message}`);
    }
});
</script>
{% endblock %}
